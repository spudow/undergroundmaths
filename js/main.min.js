!function(){angular.module("cmAuth",["cmApi"]).factory("Auth",["$rootScope","$http","$compile","$timeout","UserAccount",function(a,b,c,d,e){var f={};return f.setAccountSettings=function(b){a.accountSettings=b||{}},f.setCurrentUser=function(b){b&&b.username?a.currentUser=b:(a.currentUser={},a.currentUser.roles=[],a.currentUser.verified=!1),a.currentUser.passwordExpiryImminent=function(){var b=new Date;return a.accountSettings&&a.accountSettings.imminentPasswordExpiryHours&&b.setHours(b.getHours()+a.accountSettings.imminentPasswordExpiryHours),a.currentUser.passwordExpiryDate&&new Date(a.currentUser.passwordExpiryDate)<b},a.currentUser.hasPasswordExpired=function(){return a.currentUser.passwordExpiryDate&&new Date(a.currentUser.passwordExpiryDate)<new Date},a.currentUser.isLoggedIn=function(){return!a.currentUser.hasPasswordExpired()&&!!a.currentUser.username},a.currentUser.isInAnyRole=function(b){if(a.currentUser.hasPasswordExpired())return!1;if(!a.currentUser.roles||!a.currentUser.verified)return!1;if(!b||0==b.length)return!0;var c=!1;return angular.forEach(b,function(b){if(a.currentUser.roles.indexOf(b)>=0)return c=!0,!1}),c},a.currentUser.isInAnyOriginalRole=function(b){if(a.currentUser.hasPasswordExpired())return!1;if(!a.currentUser.originalRoles||!a.currentUser.verified)return!1;if(!b||0==b.length)return!0;var c=!1;return angular.forEach(b,function(b){if(a.currentUser.originalRoles.indexOf(b)>=0)return c=!0,!1}),c},a.currentUser.canViewItem=function(b){if("Public"==b)return!0;var c=a.currentUser;if(!c.username||!c.verified)return!1;switch(b){case"ChampionReview":return c.roles.indexOf("ChampionManager")>=0||c.roles.indexOf("ChampionTeamMember")>=0||c.roles.indexOf("Champion")>=0||c.roles.indexOf("AcademicReviewer")>=0||c.roles.indexOf("InternalReviewer")>=0||c.roles.indexOf("AssistantAuthor")>=0||c.roles.indexOf("Author")>=0||c.roles.indexOf("Webmaster")>=0;case"AcademicReview":return c.roles.indexOf("AcademicReviewer")>=0||c.roles.indexOf("InternalReviewer")>=0||c.roles.indexOf("AssistantAuthor")>=0||c.roles.indexOf("Author")>=0||c.roles.indexOf("Webmaster")>=0;default:return c.roles.indexOf("InternalReviewer")>=0||c.roles.indexOf("AssistantAuthor")>=0||c.roles.indexOf("Author")>=0||c.roles.indexOf("Webmaster")>=0}}},f.confirmLogin=function(b,g){var h=new CmModal({addToHistory:!1});h.setContentLoading(),h.show(),$.get("/static/spa-templates/account/confirm-login.html",function(i){var j=$(i),k=a.$new();k.viewModel={},k.viewModel.successfull=!1,k.viewModel.errors=[],k.userLogin={username:a.currentUser.username,password:"",stayLoggedIn:a.currentUser.stayLoggedIn},k.clearErrors=function(){k.viewModel.errors=[]},k.logIn=function(){k.clearErrors(),k.viewModel.confirmLoginForm.$valid&&e.logIn(k.userLogin,function(a){f.setCurrentUser(a),k.viewModel.successfull=!0,h.hide()},function(a){a.data&&a.data.errorMessages?k.viewModel.errors=a.data.errorMessages:k.viewModel.errors=["An error occured whilst trying to log in."]})},h.on("hidden",function(){h.remove(),k.viewModel.successfull?b&&d(b):g&&d(g),k.$destroy()}),c(j)(k),h.setContent(j[0])})},f}])}(),function(){angular.module("cmBookmarkManager",["cmApi"]).factory("BookmarkManager",["$rootScope","$timeout","Bookmark","BookmarkGroup",function(a,b,c,d){var e=function(a){var b=this;b.userId=a,b.bookmarks=[],b.bookmarkGroups=[],b.currentResourceId=null,b.notesModal=null,b.currentItemBookmark=null,b.handlers=[],b.loadBookmarks()};return e.prototype.on=function(a,b){var c=this;c.off(a,b),c.handlers.push({eventName:a,callback:b})},e.prototype.off=function(a,b){var c=this;c.handlers=c.handlers.filter(function(c){return!(c.eventName==a&&c.callback==b)})},e.prototype.invokeEvent=function(a){this.handlers.forEach(function(b){b.eventName==a&&b.callback&&b.callback()})},e.prototype.addBookmark=function(a,b,d){var e=this,f=new c;f.resourceId=a.resourceId,f.userId=e.userId,f.createdDate=new Date,f.updatedDate=new Date,f.$save(function(a){e.loadBookmarks(),b&&b(a)},function(a){d&&d(a.data)})},e.prototype.removeBookmark=function(a,b,d){var e=this;c.remove({id:a},null,function(a){e.loadBookmarks(),b&&b(a)},function(a){d&&d(a.data)})},e.prototype.loadBookmarks=function(){var a=this;c.query(function(b){a.bookmarks=b,a.setCurrentResourceId(a.currentResourceId)},function(){a.bookmarks=[]}),d.query(function(b){a.bookmarkGroups=b},function(){a.bookmarkGroups=[]})},e.prototype.setCurrentResourceId=function(a){var b=this;b.currentResourceId=a;var d=b.currentItemBookmark?b.currentItemBookmark.bookmark.id:null;b.currentItemBookmark=null;var e=b.getBookmarkForCurrentItem();if(!e)return void(d&&b.invokeEvent("bookmarkedItemChanged"));c.getDetail({id:e.id},function(a){b.currentItemBookmark=a,d&&d==a.bookmark.id||b.invokeEvent("bookmarkedItemChanged")})},e.prototype.getBookmarkForResource=function(a){var b=this,c=b.bookmarks.filter(function(b){return b.resourceId==a});return c.length>0?c[0]:null},e.prototype.getBookmarkForCurrentItem=function(){var a=this;return a.getBookmarkForResource(a.currentResourceId)},e.prototype.canBookmarkCurrentItem=function(){var a=this;return!!a.currentResourceId&&!a.getBookmarkForResource(a.currentResourceId)},e.prototype.addBookmarkForCurrentItem=function(b,c){var d=this;if(d.currentResourceId)return a.currentUser.isInAnyRole()?void d.addBookmark({resourceId:d.currentResourceId},b,c):void CmModal.showAlert("Login required to add to resource collection",'You must <a tabindex="0" data-cm-prompt-login-toggle="">log in</a> or <a tabindex="0" data-cm-prompt-register-toggle="">register</a> to add a resource to your collection.',null,!0)},e.prototype.removeBookmarkForCurrentItem=function(a,b){var c=this;c.currentItemBookmark&&c.removeBookmark(c.currentItemBookmark.bookmark.id,a,b)},e.prototype.confirmRemoveBookmarkForCurrentItem=function(a,b){var c=this;c.currentResourceId&&CmModal.showConfirm("Warning","Are you sure you want to remove this resource from your collection?",function(){c.removeBookmarkForCurrentItem(a,b)})},e.prototype.viewNotesForCurrentItem=function(){var a=this;if(a.currentItemBookmark){var b=a.notesModal;b||(b=new BookmarkNotesModal,a.notesModal=b),b.setBookmark(a.currentItemBookmark),b.show()}},e.prototype.showBookmarksModal=function(){var a=this,b=a.bookmarksModal;b||(b=new BookmarksModal,a.bookmarksModal=b),b.update(),b.show()},e}])}(),function(){angular.module("cmBookmarkNotesModal",["cmApi"]).controller("BookmarkNotesModalController",["$scope","$element","$timeout","$sce","Bookmark",function(a,b,c,d,e){a.viewModel=a.viewModel||{},a.viewModel.notes=null,a.viewModel.originalNotes=null,a.viewModel.errors=[],a.viewModel.saving=!1,a.viewModel.hasNotes=!1,a.clearErrors=function(){a.viewModel.errors=[]},a.saveState=function(){a.viewModel.originalNotes=angular.copy(a.viewModel.notes)},a.getBookmarkNotes=function(){a.viewModel.bookmark&&e.getNotes({bookmarkId:a.viewModel.bookmark.bookmark.id},function(b){a.viewModel.notes=b,a.viewModel.hasNotes=!0,a.saveState()},function(){a.viewModel.notes={bookmarkId:a.viewModel.bookmark.bookmark.id,content:null},a.saveState()})},a.getBookmarkNotes(),a.updateBookmarkNotes=function(){a.needsSaving()&&!a.viewModel.saving&&(a.clearErrors(),a.viewModel.saving=!0,a.viewModel.notes.updatedDate=new Date,e.updateNotes({bookmarkId:a.viewModel.bookmark.bookmark.id},a.viewModel.notes,function(b){a.viewModel.saving=!1,a.saveState(),a.viewModel.bookmark.hasNotes=!0,a.viewModel.hasNotes=!0,a.bookmarkManager.loadBookmarks()},function(b){a.viewModel.saving=!1,b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to update your notes."]}))},a.viewModel.update=function(){a.viewModel.hasNotes=!1,a.getBookmarkNotes()},a.needsSaving=function(){return!angular.equals(a.viewModel.notes,a.viewModel.originalNotes)};var f=function(){e.removeNotes({bookmarkId:a.viewModel.bookmark.bookmark.id},function(){a.viewModel.bookmark.hasNotes=!1,a.viewModel.hasNotes=!1,a.viewModel.notes=null,a.viewModel.originalNotes=null,a.viewModel.modal.hide(),a.bookmarkManager.loadBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to delete these notes."]})};a.confirmDeleteNotes=function(){a.clearErrors(),CmModal.showConfirm("Warning","Are you sure you want to delete these notes?",function(){f()})},a.$watch("viewModel.bookmark",function(b,c){b!=c&&(a.viewModel.notes=null,a.viewModel.originalNotes=null,a.viewModel.hasNotes=!1,a.getBookmarkNotes())}),c(function(){cmSite.processContent(b[0])})}]);var a=function(){var a=this;a.modal=new CmModal,a.modal.setContentLoading(),a.viewModel={},a.viewModel.modal=a.modal,$.get("/static/spa-templates/account/bookmark-notes-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,d){var e=b.$new();e.viewModel=a.viewModel,d(c)(e),a.modal.setContent(c[0])}])})};a.prototype.setBookmark=function(a){this.viewModel.bookmark=a},a.prototype.show=function(){var a=this;a.update(),a.modal.show()},a.prototype.hide=function(){this.modal.hide()},a.prototype.update=function(){var a=this;a.viewModel.update&&a.viewModel.update()},window.BookmarkNotesModal=a}(),function(){var a=function(){var a=this;a.viewModel={},a.viewModel.bookmarksTemplate=cmHelper.templateBaseUrl+"/account/bookmarks.html",a.viewModel.containerName="bookmarksModal",a.modal=new CmModal,a.modal.setContentLoading(),$.get("/static/spa-templates/account/bookmarks-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile","$timeout",function(b,d,e){var f=b.$new();f.viewModel=a.viewModel,d(c)(f),a.modal.setContent(c[0]),e(function(){})}])})};a.prototype.update=function(){var a=this;a.viewModel.update&&a.viewModel.update()},a.prototype.show=function(){this.modal.show()},a.prototype.hide=function(){this.modal.hide()},window.BookmarksModal=a}(),function(){angular.module("cmBookmarks",["cmCore"]).controller("BookmarksController",["$scope","$timeout","Bookmark","BookmarkGroup","BookmarkGroupPair","Resource","GeneratePrintable","Auth",function(a,b,c,d,e,f,g,h){a.viewModel=a.viewModel||{},a.viewModel.bookmarks=[],a.viewModel.bookmarkDetailList=[],a.viewModel.bookmarkGroups=[],a.viewModel.resourceTypeIdSelected=null,a.viewModel.stationIdSelected=null,a.viewModel.groupIdSelected=null,a.viewModel.pageSize=25,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.addToGroupViewModel={modal:null,errors:[],saving:!1},a.deleteGroupViewModel={modal:null,errors:[]},a.deleteBookmarkViewModel={modal:null,errors:[]},a.editGroupViewModel={modal:null,errors:[],saving:!1},a.cloneGroupViewModel={modal:null,errors:[],saving:!1},a.createGroupViewModel={modal:null,errors:[],saving:!1},a.viewModel.order=null;var i=!1;a.viewModel.loading=!0,a.viewModel.errors=[],a.viewModel.filteredStations=[],a.viewModel.filteredResourceTypes=[],a.clearErrors=function(){a.viewModel.errors=[]};var j=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b};a.pageChange=function(){a.viewModel.containerName&&cmHelper.setSessionStorage(a.viewModel.containerName+".currentPage",JSON.stringify(a.viewModel.currentPage)),a.getBookmarks()},a.getGroups=function(){a.viewModel.bookmarkGroups=d.query(function(){a.viewModel.groupIdSelected&&!a.getGroup(a.viewModel.groupIdSelected)&&(a.viewModel.groupIdSelected=null)})},a.getGroups(),a.getGroup=function(b){var c=a.viewModel.bookmarkGroups.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.viewModel.update=function(){a.getBookmarks(),a.getGroups(),a.getFilteredStations(),a.getFilteredResourceTypes()},a.getFilteredStations=function(){a.viewModel.filteredStations=c.getStations()},a.getFilteredResourceTypes=function(){a.viewModel.filteredResourceTypes=c.getResourceTypes()},a.getResourceType=function(b){var c=a.viewModel.filteredResourceTypes.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.hasNoBookmarks=function(){return 0==a.viewModel.bookmarks.length&&0==a.viewModel.bookmarkGroups.length&&!a.viewModel.stationIdSelected&&!a.viewModel.groupIdSelected},a.getFilteredStations(),a.getFilteredResourceTypes(),a.getBookmarks=function(){i=!0,a.clearErrors();var d;a.viewModel.order&&(d=a.viewModel.order.field+a.viewModel.order.direction);var e=a.viewModel.groupIdSelected;c.queryDetail({startRow:j(),maxRows:a.viewModel.pageSize,orderBy:d,station:a.viewModel.stationIdSelected,resourceType:a.viewModel.resourceTypeIdSelected,group:e},function(c){a.viewModel.bookmarkDetailList=c.results,a.viewModel.totalRows=c.totalRows,a.viewModel.loading=!1,b(function(){cmSite.processContent()})},function(){a.viewModel.loading=!1}),c.queryLite({group:e,station:a.viewModel.stationIdSelected,resourceType:a.viewModel.resourceTypeIdSelected,orderBy:d},function(b){a.viewModel.bookmarks=b},function(){a.viewModel.bookmarks=[]})};var k=function(b){c.remove({id:b.id},function(){a.getBookmarks(),a.getFilteredStations(),a.getFilteredResourceTypes(),a.bookmarkManager.loadBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to remove the resource from your collection."]})};a.getViewUrl=function(a){return"/"+a.station.friendlyId+"/"+a.resource.friendlyName},a.addToGroupViewModel.clearErrors=function(){a.addToGroupViewModel.errors=[]};var l=function(b){var c=new e;c.order=-1,c.bookmarkId=a.addToGroupViewModel.bookmarkSelected.bookmark.id,c.groupId=b,a.addToGroupViewModel.saving=!0,c.$save(function(){a.addToGroupViewModel.saving=!1,a.addToGroupViewModel.modal&&a.addToGroupViewModel.modal.hide(),a.getBookmarks()},function(b){a.addToGroupViewModel.saving=!1,b.data&&b.data.errorMessages?a.addToGroupViewModel.errors=b.data.errorMessages:a.addToGroupViewModel.errors=["An error occured whilst trying to add the resource to the subcollection."],a.getBookmarks()})};a.addToGroupViewModel.addToGroup=function(){if(a.addToGroupViewModel.bookmarkSelected&&(a.addToGroupViewModel.clearErrors(),a.addToGroupViewModel.addToGroupForm.$valid&&!a.addToGroupViewModel.saving))if(a.addToGroupViewModel.groupIdSelected&&"New"!=a.addToGroupViewModel.newOrExisting)l(a.addToGroupViewModel.groupIdSelected);else{var b=new d;b.userId=a.currentUser.userId,b.name=a.addToGroupViewModel.groupName,b.updatedDate=new Date,a.addToGroupViewModel.saving=!0,b.$save(function(b){a.addToGroupViewModel.groupIdSelected=b.id,l(b.id),a.getGroups()},function(b){a.addToGroupViewModel.saving=!1,b.data&&b.data.errorMessages?a.addToGroupViewModel.errors=b.data.errorMessages:a.addToGroupViewModel.errors=["An error occured whilst trying to create the subcollection."]})}},a.showAddToGroupModal=function(b){a.addToGroupViewModel.clearErrors(),a.addToGroupViewModel.bookmarkSelected=b,a.addToGroupViewModel.groups=a.viewModel.bookmarkGroups.filter(function(a){return 0==b.groups.filter(function(b){return b.detail.id==a.id}).length}),a.addToGroupViewModel.newOrExisting="Existing",0==a.addToGroupViewModel.groups.length&&(a.addToGroupViewModel.newOrExisting="New"),a.addToGroupViewModel.groupName=null,a.addToGroupViewModel.addToGroupForm&&(a.addToGroupViewModel.addToGroupForm.$setPristine(),a.addToGroupViewModel.addToGroupForm.$setUntouched());var c=a.addToGroupViewModel.modal;if(c)return void c.show();var d=new CmModal;d.setContentLoading(),d.show(),a.addToGroupViewModel.modal=d,$.get("/static/spa-templates/account/bookmarks-add-to-group-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(c)(a),d.setContent(c[0])}])}),d.show()},a.deleteGroupViewModel.clearErrors=function(){a.deleteGroupViewModel.errors=[]},a.deleteGroupViewModel.deleteGroup=function(){if(a.viewModel.groupIdSelected&&(a.deleteGroupViewModel.clearErrors(),a.deleteGroupViewModel.deleteGroupForm.$valid)){var b;"Full"==a.deleteGroupViewModel.deleteType&&(b="true"),d.remove({id:a.viewModel.groupIdSelected,removeFully:b},null,function(b){a.viewModel.groupIdSelected=null,a.getGroups(),a.getBookmarks(),a.getFilteredStations(),a.getFilteredResourceTypes(),a.bookmarkManager.loadBookmarks(),a.deleteGroupViewModel.modal.hide()},function(b){b.data&&b.data.errorMessages?a.deleteGroupViewModel.errors=b.data.errorMessages:a.deleteGroupViewModel.errors=["An error occured whilst trying to delete the subcollection."]})}};var m=function(){d.remove({id:a.viewModel.groupIdSelected},null,function(b){a.viewModel.groupIdSelected=null,a.getGroups(),a.getBookmarks(),a.bookmarkManager.loadBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to delete the subcollection."]})};a.confirmDeleteGroup=function(){a.viewModel.groupIdSelected&&(a.clearErrors(),0==a.viewModel.bookmarkDetailList.length?CmModal.showConfirm("Warning","Are you sure you want to delete this subcollection?",function(){m()}):a.showDeleteGroupModal())},a.showDeleteGroupModal=function(){if(a.viewModel.groupIdSelected){a.deleteGroupViewModel.deleteType="GroupOnly",a.deleteGroupViewModel.deleteGroupForm&&(a.deleteGroupViewModel.deleteGroupForm.$setPristine(),a.deleteGroupViewModel.deleteGroupForm.$setUntouched());var b=a.deleteGroupViewModel.modal;if(b)return void b.show();var c=new CmModal;c.setContentLoading(),c.show(),a.deleteGroupViewModel.modal=c,$.get("/static/spa-templates/account/bookmarks-delete-group-modal.html",function(b){var d=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(d)(a),c.setContent(d[0])}])}),c.show()}},a.deleteBookmarkViewModel.clearErrors=function(){a.deleteBookmarkViewModel.errors=[]},a.deleteBookmarkViewModel.deleteBookmarkInternal=function(){c.remove({id:a.deleteBookmarkViewModel.bookmarkSelected.bookmark.id},null,function(){a.getBookmarks(),a.bookmarkManager.loadBookmarks(),a.deleteBookmarkViewModel.modal.hide()},function(b){a.getBookmarks(),a.bookmarkManager.loadBookmarks(),b.data&&b.data.errorMessages?a.deleteBookmarkViewModel.errors=b.data.errorMessages:a.deleteBookmarkViewModel.errors=["An error occured whilst trying to remove the resource from your collection."]})},a.deleteBookmarkViewModel.deleteBookmark=function(){if(a.deleteBookmarkViewModel.bookmarkSelected&&(a.deleteBookmarkViewModel.clearErrors(),a.deleteBookmarkViewModel.deleteBookmarkForm.$valid)){var b=a.deleteBookmarkViewModel.bookmarkSelected.groups.filter(function(b){return b.value.groupId==a.viewModel.groupIdSelected});if(b.length>0){var c=b[0].value.id;e.remove({id:c},null,function(){"Full"==a.deleteBookmarkViewModel.deleteType?a.deleteBookmarkViewModel.deleteBookmarkInternal():(a.getBookmarks(),a.bookmarkManager.loadBookmarks(),a.deleteBookmarkViewModel.modal.hide())},function(b){b.data&&b.data.errorMessages?a.deleteBookmarkViewModel.errors=b.data.errorMessages:a.deleteBookmarkViewModel.errors=["An error occured whilst trying to remove the bookmark from the subcollection."]})}else a.deleteBookmarkViewModel.errors=["An error occured whilst trying to remove the bookmark from the subcollection."]}},a.confirmDeleteBookmark=function(b){a.clearErrors(),a.viewModel.groupIdSelected?a.showDeleteBookmarkModal(b):CmModal.showConfirm("Warning","Are you sure you want to remove this resource from your collection?",function(){k(b.bookmark)})},a.showDeleteBookmarkModal=function(b){if(a.viewModel.groupIdSelected){a.deleteBookmarkViewModel.bookmarkSelected=b,a.deleteBookmarkViewModel.deleteType="GroupOnly",a.deleteBookmarkViewModel.deleteBookmarkForm&&(a.deleteBookmarkViewModel.deleteBookmarkForm.$setPristine(),a.deleteBookmarkViewModel.deleteBookmarkForm.$setUntouched());var c=a.deleteBookmarkViewModel.modal;if(c)return void c.show();var d=new CmModal;d.setContentLoading(),d.show(),a.deleteBookmarkViewModel.modal=d,$.get("/static/spa-templates/account/bookmarks-delete-bookmark-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(c)(a),d.setContent(c[0])}])}),d.show()}},a.updateGroupOrder=function(b){a.clearErrors();var c=b.groups.filter(function(b){return b.value.groupId==a.viewModel.groupIdSelected});if(c.length>0){var d=c[0].value;d.order=b.orderInGroup,e.update(d,function(){a.getBookmarks(),a.bookmarkManager.loadBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to update the bookmark order."]})}else a.viewModel.errors=["An error occured whilst trying to update the bookmark order."]},a.editGroupViewModel.originalGroup=null,a.editGroupViewModel.group=null,a.editGroupViewModel.saveState=function(){a.editGroupViewModel.originalGroup=angular.copy(a.editGroupViewModel.group)},a.editGroupViewModel.needsSaving=function(){return!angular.equals(a.editGroupViewModel.originalGroup,a.editGroupViewModel.group)},a.editGroupViewModel.clearErrors=function(){a.editGroupViewModel.errors=[]},a.editGroupViewModel.updateGroup=function(){a.editGroupViewModel.group&&a.editGroupViewModel.editGroupForm.$valid&&!a.editGroupViewModel.saving&&a.editGroupViewModel.needsSaving()&&(a.editGroupViewModel.clearErrors(),a.editGroupViewModel.saving=!0,a.editGroupViewModel.group.$update(function(b){a.editGroupViewModel.saving=!1,a.editGroupViewModel.saveState(),a.getBookmarks(),a.bookmarkManager.loadBookmarks(),a.editGroupViewModel.modal.hide()},function(b){a.editGroupViewModel.saving=!1,b.data&&b.data.errorMessages?a.editGroupViewModel.errors=b.data.errorMessages:a.editGroupViewModel.errors=["An error occured whilst trying to update the subcollection."]}))},a.showEditGroupModal=function(){if(a.editGroupViewModel.group=a.getGroup(a.viewModel.groupIdSelected),a.editGroupViewModel.saveState(),a.editGroupViewModel.group){a.editGroupViewModel.editGroupForm&&(a.editGroupViewModel.editGroupForm.$setPristine(),a.editGroupViewModel.editGroupForm.$setUntouched());var b=a.editGroupViewModel.modal;if(b)return void b.show();var c=new CmModal;c.setContentLoading(),c.show(),a.editGroupViewModel.modal=c,$.get("/static/spa-templates/account/bookmarks-edit-group-modal.html",function(b){var d=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(d)(a),c.setContent(d[0])}])}),c.show()}},a.cloneGroupViewModel.newName=null,a.cloneGroupViewModel.clearErrors=function(){a.cloneGroupViewModel.errors=[]},a.cloneGroupViewModel.cloneGroup=function(){a.viewModel.groupIdSelected&&a.cloneGroupViewModel.cloneGroupForm.$valid&&!a.cloneGroupViewModel.saving&&(a.cloneGroupViewModel.clearErrors(),a.cloneGroupViewModel.saving=!0,d.clone({id:a.viewModel.groupIdSelected},{newName:a.cloneGroupViewModel.newName},function(b){a.cloneGroupViewModel.saving=!1,a.getGroups(),a.bookmarkManager.loadBookmarks(),a.viewModel.groupIdSelected=b.id,a.cloneGroupViewModel.modal.hide()},function(b){a.cloneGroupViewModel.saving=!1,b.data&&b.data.errorMessages?a.cloneGroupViewModel.errors=b.data.errorMessages:a.cloneGroupViewModel.errors=["An error occured whilst trying to duplicate the subcollection."]}))},a.showCloneGroupModal=function(){if(a.viewModel.groupIdSelected){var b=a.getGroup(a.viewModel.groupIdSelected);if(b){a.cloneGroupViewModel.newName=b.name+" copy",a.cloneGroupViewModel.cloneGroupForm&&(a.cloneGroupViewModel.cloneGroupForm.$setPristine(),a.cloneGroupViewModel.cloneGroupForm.$setUntouched());var c=a.cloneGroupViewModel.modal;if(c)return void c.show();var d=new CmModal;d.setContentLoading(),d.show(),a.cloneGroupViewModel.modal=d,$.get("/static/spa-templates/account/bookmarks-clone-group-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(c)(a),d.setContent(c[0])}])}),d.show()}}},a.createGroupViewModel.group=null,a.createGroupViewModel.clearErrors=function(){a.createGroupViewModel.errors=[]},a.createGroupViewModel.createGroup=function(){a.createGroupViewModel.createGroupForm.$valid&&!a.createGroupViewModel.saving&&(a.createGroupViewModel.clearErrors(),a.createGroupViewModel.saving=!0,a.createGroupViewModel.group.$save(function(b){a.createGroupViewModel.saving=!1,a.getGroups(),a.bookmarkManager.loadBookmarks(),a.createGroupViewModel.modal.hide()},function(b){a.createGroupViewModel.saving=!1,b.data&&b.data.errorMessages?a.createGroupViewModel.errors=b.data.errorMessages:a.createGroupViewModel.errors=["An error occured whilst trying to create the subcollection."]}))},a.showCreateGroupModal=function(){if(a.createGroupViewModel.group=new d,a.createGroupViewModel.group.userId=a.currentUser.userId,a.createGroupViewModel.group.updatedDate=new Date,a.createGroupViewModel.group){a.createGroupViewModel.clearErrors(),a.createGroupViewModel.createGroupForm&&(a.createGroupViewModel.createGroupForm.$setPristine(),a.createGroupViewModel.createGroupForm.$setUntouched());var b=a.createGroupViewModel.modal;if(b)return void b.show();var c=new CmModal;c.setContentLoading(),c.show(),a.createGroupViewModel.modal=c,$.get("/static/spa-templates/account/bookmarks-create-group-modal.html",function(b){var d=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){e(d)(a),c.setContent(d[0])}])}),c.show()}},a.viewNotes=function(b){var c=a.viewModel.notesModal;if(c)return c.setBookmark(b),void c.show();c=new BookmarkNotesModal,a.viewModel.notesModal=c,c.setBookmark(b),c.show()},a.isOrderSelected=function(b,c){return!a.viewModel.order||!a.viewModel.groupIdSelected&&"OrderInGroup"==a.viewModel.order.field?a.viewModel.groupIdSelected?"OrderInGroup"==b&&"Asc"==c:"Date"==b&&"Desc"==c:a.viewModel.order.field==b&&a.viewModel.order.direction==c},a.updateOrder=function(b,c){a.viewModel.order={field:b,direction:c},a.getBookmarks(),a.viewModel.containerName&&cmHelper.setSessionStorage(a.viewModel.containerName+".order",JSON.stringify(a.viewModel.order))};var n=null,o=null,p=function(b){var c={resourceSections:b,pageBreakType:a.generatePdfViewModel.pageBreakType};g.generateResourceSections({format:a.generatePdfViewModel.outputFormat},c,function(b){a.viewModel.generatingPrintable=!1;var c="application/pdf",d="printable.pdf";"latex"==a.generatePdfViewModel.outputFormat&&(c="application/x-latex",d="printable.tex");var e=new Blob([b.data],{type:c});if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,d);else{if(!n)return;o=URL.createObjectURL(e),n.location.href=o}},function(b){a.viewModel.generatingPrintable=!1,b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to generate the printable."],n&&n.close()})};a.generatePdfViewModel={errors:[],resources:[],modal:null},a.generatePdfViewModel.clearErrors=function(){a.generatePdfViewModel.errors=[]},a.generatePdfViewModel.generatePdf=function(){if(a.generatePdfViewModel.generatePdfForm.$valid&&!a.viewModel.generatingPrintable&&a.viewModel.groupIdSelected){a.generatePdfViewModel.clearErrors(),a.viewModel.generatingPrintable=!0;var b=a.getGroup(a.viewModel.groupIdSelected);if(b){if(!window.Blob||!window.URL)return void(a.generatePdfViewModel.errors=["Your browser doesn't support this."]);var c=[];if(a.generatePdfViewModel.resources.forEach(function(b){"First"==a.generatePdfViewModel.includeType?b.printableResourceSections.length>0&&1==b.printableResourceSections[0].order&&c.push(b.printableResourceSections[0].id):"All"==a.generatePdfViewModel.includeType?b.printableResourceSections.forEach(function(a){c.push(a.id)}):"Custom"==a.generatePdfViewModel.includeType&&b.printableResourceSections.forEach(function(a){a.include&&c.push(a.id)})}),0==c.length)return void(a.generatePdfViewModel.errors=["No resource sections selected"]);if(o)try{URL.revokeObjectURL(o)}catch(e){}o=null,window.navigator&&window.navigator.msSaveOrOpenBlob||(n=window.open("/placeholders/blank-page")),a.viewModel.generatingPrintable=!0;var d=function(){if(a.viewModel.generatingPrintable){var c=n.document;c.title="Printable for subcollection "+b.name;var d=c.body,e=c.createElement("div");e.style.padding="10px",e.textContent="Generating PDF for subcollection "+b.name+". This may take up to 30 seconds.",e.innerHTML='<span class="icon-waiting cm-spin"></span> '+e.innerHTML,d.appendChild(e)}};n&&n.addEventListener&&n.addEventListener("DOMContentLoaded",d),p(c),a.generatePdfViewModel.modal&&a.generatePdfViewModel.modal.hide()}}},a.$watch("generatePdfViewModel.includeType",function(){a.generatePdfViewModel.modal&&a.generatePdfViewModel.modal.contentElement&&b(function(){cmSite.processContent(a.generatePdfViewModel.modal.contentElement[0])})}),a.showGeneratePdfModal=function(){if(!a.viewModel.generatingPrintable&&a.viewModel.groupIdSelected){a.generatePdfViewModel.loading=!0,a.generatePdfViewModel.resources=a.viewModel.bookmarkDetailList.map(function(a){return{title:a.title,printableResourceSections:[],resourceId:a.bookmark.resourceId}});var c=a.viewModel.bookmarks.map(function(a){return a.resourceId});f.listResourceSections(c,function(c){c.forEach(function(b){var c=a.generatePdfViewModel.resources.filter(function(a){return a.resourceId==b.resource.id});c.length>0&&(c[0].printableResourceSections=b.resourceSections.filter(function(a){return a.printable}),c[0].printableResourceSections.forEach(function(a){1==a.order&&(a.include=!0)}))}),a.generatePdfViewModel.modal&&a.generatePdfViewModel.modal.contentElement&&b(function(){cmSite.processContent(a.generatePdfViewModel.modal.contentElement[0])}),a.generatePdfViewModel.loading=!1},function(b){b.data&&b.data.errorMessages?a.generatePdfViewModel.errors=b.data.errorMessages:a.generatePdfViewModel.errors=["An error occured whilst trying to load the resource details."],a.generatePdfViewModel.loading=!1}),a.generatePdfViewModel.includeType="First",a.generatePdfViewModel.pageBreakType="None",a.generatePdfViewModel.outputFormat="pdf",a.generatePdfViewModel.clearErrors(),a.generatePdfViewModel.generatePdfForm&&(a.generatePdfViewModel.generatePdfForm.$setPristine(),a.generatePdfViewModel.generatePdfForm.$setUntouched());var d=a.generatePdfViewModel.modal;if(d)return void d.show();var e=new CmModal;e.setContentLoading(),e.show(),a.generatePdfViewModel.modal=e,$.get("/static/spa-templates/account/bookmarks-generate-pdf-modal.html",function(c){var d=$(c);angular.element(document).injector().invoke(["$rootScope","$compile",function(c,f){f(d)(a),e.setContent(d[0]),b(function(){})}])}),e.show()}};var q=function(b){a.bookmarkManager.addBookmarkForCurrentItem(function(c){b&&a.viewModel.groupIdSelected?(a.addToGroupViewModel.bookmarkSelected={bookmark:c},l(a.viewModel.groupIdSelected)):a.getBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to add the resource to your collection."]})};if(a.bookmarkCurrentItem=function(){a.viewModel.groupIdSelected?CmModal.showConfirmYesFirst("Add to selected subcollection?","Also add the resource to the selected subcollection?",function(){q(!0)},function(){q(!1)}):q(!1)},a.confirmUnbookmarkCurrentItem=function(){a.bookmarkManager.confirmRemoveBookmarkForCurrentItem(function(){a.getBookmarks()},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to remove the resource from your collection."]})},a.canReset=function(){return a.viewModel.groupIdSelected||a.viewModel.stationIdSelected||a.viewModel.resourceTypeIdSelected||a.viewModel.order&&("Date"!=a.viewModel.order.field||"Desc"!=a.viewModel.order.direction)&&("OrderInGroup"!=a.viewModel.order.field||"Asc"!=a.viewModel.order.direction)},a.reset=function(){a.viewModel.groupIdSelected=null,a.viewModel.stationIdSelected=null,a.viewModel.resourceTypeIdSelected=null,a.viewModel.order=null,a.getBookmarks()},a.download=function(){var b,c="";a.viewModel.order&&(b=a.viewModel.order.field+a.viewModel.order.direction);var d={group:a.viewModel.groupIdSelected,station:a.viewModel.stationIdSelected,resourceType:a.viewModel.resourceTypeIdSelected,orderBy:b}
;Object.keys(d).forEach(function(a){c&&(c+="&"),null!=d[a]&&(c+=a+"="+encodeURIComponent(d[a]))}),c=c?"?"+c:c,location.href="/api/bookmarks/download"+c},a.$watch("viewModel.stationIdSelected",function(b,c){b!=c&&(a.getBookmarks(),a.viewModel.containerName&&cmHelper.setSessionStorage(a.viewModel.containerName+".stationIdSelected",JSON.stringify(a.viewModel.stationIdSelected)))}),a.$watch("viewModel.resourceTypeIdSelected",function(b,c){b!=c&&(a.getBookmarks(),a.viewModel.containerName&&cmHelper.setSessionStorage(a.viewModel.containerName+".resourceTypeIdSelected",JSON.stringify(a.viewModel.resourceTypeIdSelected)))}),a.$watch("viewModel.groupIdSelected",function(b,c){b!=c&&(a.getBookmarks(),a.viewModel.containerName&&cmHelper.setSessionStorage(a.viewModel.containerName+".groupIdSelected",JSON.stringify(a.viewModel.groupIdSelected)))}),a.viewModel.containerName&&sessionStorage[a.viewModel.containerName+".stationIdSelected"])try{a.viewModel.stationIdSelected=JSON.parse(sessionStorage[a.viewModel.containerName+".stationIdSelected"])}catch(s){}if(a.viewModel.containerName&&sessionStorage[a.viewModel.containerName+".resourceTypeIdSelected"])try{a.viewModel.resourceTypeIdSelected=JSON.parse(sessionStorage[a.viewModel.containerName+".resourceTypeIdSelected"])}catch(s){}if(a.viewModel.containerName&&sessionStorage[a.viewModel.containerName+".groupIdSelected"])try{var r=JSON.parse(sessionStorage[a.viewModel.containerName+".groupIdSelected"]);a.viewModel.bookmarkGroups&&0!=a.viewModel.bookmarkGroups.length&&!a.getGroup(r)||(a.viewModel.groupIdSelected=r)}catch(s){}if(a.viewModel.containerName&&sessionStorage[a.viewModel.containerName+".order"])try{a.viewModel.order=JSON.parse(sessionStorage[a.viewModel.containerName+".order"])}catch(s){}if(a.viewModel.containerName&&sessionStorage[a.viewModel.containerName+".currentPage"])try{a.viewModel.currentPage=JSON.parse(sessionStorage[a.viewModel.containerName+".currentPage"])}catch(s){}i||a.getBookmarks()}])}(),function(){angular.module("cmAdminModalToggle",["cmCore"]).controller("AdminModalController",["$scope","$timeout","Auth",function(a,b,c){a.viewModel={},a.toggleSection=function(b){if(a.rootViewModel.adminData.adminModal.sectionOpen==b)return void(a.rootViewModel.adminData.adminModal.sectionOpen=null);a.rootViewModel.adminData.adminModal.sectionOpen=b},a.$watch("rootViewModel.adminData.adminModal.sectionOpen",function(){a.viewModel.sectionOpen=a.rootViewModel.adminData.adminModal.sectionOpen}),b(function(){})}]),$(document).on("click","[data-cm-admin-modal-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b)return CmModal.hideContainingModal(this,!0),void b.show();var c=new CmModal;c.setContentLoading(),CmModal.hideContainingModal(this,!0),c.show(),$(this).data("cm-modal",c),$.get("/static/spa-templates/admin-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,d){var e=a.$new();d(b)(e),c.setContent(b[0])}])})}})}(),function(){var a=angular.module("cmApi",["ngResource"]);a.factory("Role",["$resource",function(a){return a("/account/api/roles",{},{})}]),a.factory("User",["$resource",function(a){return a("/account/api/users/:id",{id:"@id"},{query:{method:"GET"},update:{method:"PUT"},getCurrentUser:{method:"GET",url:"/account/api/users/current"}})}]),a.factory("UserType",["$resource",function(a){return a("/account/api/user-types",{},{})}]),a.factory("UserRole",["$resource",function(a){return a("/account/api/users/:userId/roles/:role",null,{})}]),a.factory("UserAccount",["$resource",function(a){return a("",{},{logIn:{method:"POST",url:"/account/api/login"},logOut:{method:"POST",url:"/account/api/logout"},resetPassword:{method:"POST",url:"/account/api/reset-password"},sendVerificationEmail:{method:"POST",url:"/account/api/send-verification-email"},switchRoles:{method:"POST",url:"/account/api/users/current/switch-roles"}})}]),a.factory("UserPublic",["$resource",function(a){return a("/account/api/users/public/:id",{id:"@id"},{queryAdmin:{method:"GET",isArray:!0,url:"/account/api/users/public/admin"}})}]),a.factory("Notification",["$resource",function(a){return a("/account/api/notifications",null,{})}]),a.factory("CmItemType",["$resource",function(a){return a("/api/cm-item-type",{},{})}]),a.factory("Image",["$resource",function(a){return a("/api/images/:virtualPath",{},{generateImages:{method:"POST",url:"/api/images/:virtualPath/generate"},clearImages:{method:"POST",url:"/api/images/:virtualPath/clear"},getImageSourcesParent:{method:"GET",url:"/api/images/:virtualPath/image-sources-parent"}})}]),a.factory("FileSystem",["$resource",function(a){return a("/file-system/api/file-info/:virtualPath",{},{update:{method:"PUT"},getDirectoryChildren:{url:"/file-system/api/directory-children/:virtualPath",method:"GET",isArray:!0},getBaseFriendlyPath:{url:"/file-system/api/base-friendly-path/:identifier",method:"GET",isArray:!0},getFriendlyPath:{url:"/file-system/api/friendly-path/:identifier",method:"GET",isArray:!0},getFriendlyIdentifierPieces:{url:"/file-system/api/friendly-identifier/:identifier",method:"GET",isArray:!0},doesFileExist:{url:"/file-system/api/file-exists/:strict/:virtualPath",method:"GET"},find:{url:"/file-system/api/find",method:"GET",isArray:!0}})}]),a.factory("Content",["$resource",function(a){return a("/api/content/:identifier",{},{update:{method:"PUT"},getConverted:{url:"/api/content/:identifier/converted",method:"GET"},getWarnings:{url:"/api/content/:identifier/warnings",method:"GET",isArray:!0},lockForEditing:{url:"/api/content/:identifier/lock",method:"POST"},unlockForEditing:{url:"/api/content/:identifier/unlock",method:"POST"},forceUnlockForEditing:{url:"/api/content/:identifier/force-unlock",method:"POST"}})}]),a.factory("Line",["$resource",function(a){return a("/api/lines/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("LineStation",["$resource",function(a){return a("/api/line-stations/:id",{id:"@id"},{update:{method:"PUT"},queryLine:{method:"GET",isArray:!0,url:"/api/lines/:lineId/stations"},queryLineDetail:{method:"GET",isArray:!0,url:"/api/lines/:lineId/stations/detail"},queryStation:{method:"GET",isArray:!0,url:"/api/stations/:stationId/lines"},queryStationDetail:{method:"GET",isArray:!0,url:"/api/stations/:stationId/lines/detail"}})}]),a.factory("StationNearby",["$resource",function(a){return a("/api/station-nearby/:id",{id:"@id"},{update:{method:"PUT"},queryStation:{method:"GET",isArray:!0,url:"/api/stations/:stationId/nearby"},queryStationDetail:{method:"GET",isArray:!0,url:"/api/stations/:stationId/nearby/detail"}})}]),a.factory("StationNearbyType",["$resource",function(a){return a("/api/station-nearby-types",{},{})}]),a.factory("Station",["$resource",function(a){return a("/api/stations/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("KeyQuestion",["$resource",function(a){return a("/api/key-questions/:id",{id:"@id"},{update:{method:"PUT"},queryStation:{method:"GET",isArray:!0,url:"/api/stations/:stationId/key-questions"},queryStationConverted:{method:"GET",isArray:!0,url:"/api/stations/:stationId/key-questions/converted"}})}]),a.factory("PervasiveIdea",["$resource",function(a){return a("/api/pervasive-ideas/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("ResourceType",["$resource",function(a){return a("/api/resource-types/:id",{id:"@id"},{update:{method:"PUT"},queryConverted:{method:"GET",isArray:!0,url:"/api/resource-types/converted"}})}]),a.factory("ResourceSource",["$resource",function(a){return a("/api/resource-sources/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("MalcolmSwanCategory",["$resource",function(a){return a("/api/malcolm-swan-categories/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("Tag",["$resource",function(a){return a("/api/tags/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("PublishStatus",["$resource",function(a){return a("/api/publish-statuses",{},{})}]),a.factory("ResourceRelationship",["$resource",function(a){return a("/api/resource-relationships",{},{})}]),a.factory("ResourceLevel",["$resource",function(a){return a("/api/resource-levels",{},{})}]),a.factory("ResourceSectionType",["$resource",function(a){return a("/api/resource-section-types/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("Keyphrase",["$resource",function(a){return a("/api/keyphrases/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("KeyphraseType",["$resource",function(a){return a("/api/keyphrase-types",{},{})}]),a.factory("Contributor",["$resource",function(a){return a("/api/contributors/:id",{id:"@id"},{query:{method:"GET"},queryUser:{method:"GET",url:"/api/contributors/user/:userId"},update:{method:"PUT"}})}]),a.factory("Resource",["$resource",function(a){return a("/api/resources/:id",{id:"@id"},{update:{method:"PUT"},queryStation:{method:"GET",isArray:!0,url:"/api/stations/:stationId/resources"},queryStationAll:{method:"GET",isArray:!0,url:"/api/stations/:stationId/resources/all"},queryStationDetail:{method:"GET",isArray:!0,url:"/api/stations/:stationId/resources/detail"},queryStationAllDetail:{method:"GET",isArray:!0,url:"/api/stations/:stationId/resources/all/detail"},updatePrintableCache:{method:"POST",url:"/api/resources/:id/update-printable-cache"},getList:{method:"GET",url:"/api/resource-list"},listResourceSections:{method:"POST",isArray:!0,url:"/api/list-resource-sections"}})}]),a.factory("ReviewQuestionType",["$resource",function(a){return a("/api/review-question-types/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("ReviewQuestionInfo",["$resource",function(a){return a("/api/review-question-info-entries/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",url:"/api/resources/:resourceId/review-question-info"}})}]),a.factory("ResourceClone",["$resource",function(a){return a("/api/resources/:id/clone",{},{})}]),a.factory("ResourceReplace",["$resource",function(a){return a("/api/resources/:id/replace",{},{})}]),a.factory("ResourceLine",["$resource",function(a){return a("/api/resource-lines/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/lines"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/lines/detail"}})}]),a.factory("ResourceKeyQuestion",["$resource",function(a){return a("/api/resource-key-questions/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/key-questions"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/key-questions/detail"}})}]),a.factory("ResourceRelatedPervasiveIdea",["$resource",function(a){return a("/api/resource-related-pervasive-ideas/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/related-pervasive-ideas"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/related-pervasive-ideas/detail"}})}]),a.factory("ResourceTag",["$resource",function(a){return a("/api/resource-tags/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/tags"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/tags/detail"}})}]),a.factory("ResourceKeyphrase",["$resource",function(a){return a("/api/resource-keyphrases/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/keyphrases"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/keyphrases/detail"}})}]),a.factory("ResourceRelatedResource",["$resource",function(a){return a("/api/resource-related-resources/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/related-resources"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/related-resources/detail"}})}]),a.factory("ResourceMalcolmSwanCategory",["$resource",function(a){return a("/api/resource-malcolm-swan-categories/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/malcolm-swan-categories"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/malcolm-swan-categories/detail"}})}]),a.factory("ResourceContributor",["$resource",function(a){return a("/api/resource-contributors/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/contributors"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/contributors/detail"}})}]),a.factory("ResourceInteractivityLabel",["$resource",function(a){return a("/api/resource-interactivity-labels/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/interactivity-labels"},queryResourceDetail:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/interactivity-labels/detail"}})}]),a.factory("ContributionType",["$resource",function(a){return a("/api/contribution-types",{},{})}]),a.factory("ResourceSection",["$resource",function(a){return a("/api/resource-sections/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/resource-sections"}})}]),a.factory("InternalNoteSection",["$resource",function(a){return a("/api/internal-note-sections/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/internal-note-sections"}})}]),a.factory("ResourceAsset",["$resource",function(a){return a("/api/resources/:resourceId/assets/:name",{},{update:{method:"PUT"}})}]),a.factory("History",["$resource",function(a){return a("/api/history/:id",{id:"@id"},{query:{method:"GET"},previewRestore:{method:"GET",url:"/api/history/restore/:saveId"},restore:{method:"POST",url:"/api/history/restore/:saveId"}})}]),a.factory("AdminSearch",["$resource",function(a){return a("/api/admin-search",{},{query:{method:"GET"}})}]),a.factory("ReviewerSearch",["$resource",function(a){return a("/api/reviewer-search",{},{query:{method:"GET"}})}]),a.factory("ResourceExtra",["$resource",function(a){return a("/api/resource-extras/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",isArray:!0,url:"/api/resources/:resourceId/resource-extras"}})}]),a.factory("Glossary",["$resource",function(a){return a("/api/glossary/:id",{id:"@id"},{query:{isArray:!1},update:{method:"PUT"}})}]),a.factory("TeacherSupport",["$resource",function(a){return a("/api/teacher-notes/:id",{id:"@id"},{update:{method:"PUT"},queryResource:{method:"GET",url:"/api/resources/:resourceId/teacher-notes"},queryStation:{method:"GET",url:"/api/stations/:stationId/teacher-notes"},queryOwner:{method:"GET",url:"/api/teacher-notes/owner/:identifier"}})}]),a.factory("Icon",["$resource",function(a){return a(cmHelper.scriptBaseUrl+"/admin/icons.json",{},{query:{method:"GET",isArray:!1}})}]),a.factory("CachedFile",["$resource",function(a){return a("/cached-files/api/:path",{},{queryOwner:{method:"GET",isArray:!0,url:"/cached-files/api/owner/:owner"},clearOwner:{method:"POST",url:"/cached-files/api/owner/:owner/clear"}})}]),a.factory("Comment",["$resource",function(a){return a("/api/comments/:id",{id:"@id"},{query:{method:"GET"},queryDetail:{method:"GET",url:"/api/comments/detail"},queryRecent:{method:"GET",url:"/api/comments/recent"},update:{method:"PUT"},accept:{method:"POST",url:"/api/comments/:id/accept"},reject:{method:"POST",url:"/api/comments/:id/reject"},queryCommentedItem:{method:"GET",isArray:!0,url:"/api/comments/commented-item/:itemIdentifier"}})}]),a.factory("Search",["$resource",function(a){return a("/api/search/:keyphrase",{},{})}]),a.factory("NewsItem",["$resource",function(a){return a("/api/news-items/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryConverted:{method:"GET",isArray:!1,url:"/api/news-items/converted"}})}]),a.factory("RecentUpdate",["$resource",function(a){return a("/api/recent-updates/:id",{id:"@id"},{query:{method:"GET"},queryDetail:{method:"GET",url:"/api/recent-updates/detail"},update:{method:"PUT"},queryOwner:{method:"GET",isArray:!0,url:"/api/recent-updates/owner/:owner"}})}]),a.factory("Event",["$resource",function(a){return a("/api/events/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryConverted:{method:"GET",isArray:!1,url:"/api/events/converted"}})}]),a.factory("Quote",["$resource",function(a){return a("/api/quotes/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryPublic:{method:"GET",isArray:!1,url:"/api/quotes/public"}})}]),a.factory("UpdateType",["$resource",function(a){return a("/api/update-types",{},{})}]),a.factory("UpdateImportance",["$resource",function(a){return a("/api/update-importances",{},{})}]),a.factory("HelpSection",["$resource",function(a){return a("/api/help-sections/:id",{id:"@id"},{update:{method:"PUT"},queryHelpSection:{method:"GET",isArray:!0,url:"/api/help-sections/:helpSectionId/help-sections"}})}]),a.factory("HelpItem",["$resource",function(a){return a("/api/help-items/:id",{id:"@id"},{query:{method:"GET"},update:{method:"PUT"},queryHelpSection:{method:"GET",isArray:!0,url:"/api/help-sections/:helpSectionId/help-items"}})}]),a.factory("FindAndReplace",["$resource",function(a){return a("/api/find-and-replace",{},{find:{method:"GET",isArray:!0},replace:{method:"POST"}})}]),a.factory("ItemInfo",["$resource",function(a){return a("/api/item-info/:identifier",{},{getByFriendlyUrl:{method:"GET",url:"/api/item-info/by-friendly-url/:url"}})}]),a.factory("LongRunningTask",["$resource",function(a){return a("/api/long-running-tasks/:id",{id:"@id"},{})}]),a.factory("LongRunningTaskType",["$resource",function(a){return a("/api/long-running-task-types",{},{})}]),a.factory("LongRunningTaskStatus",["$resource",function(a){return a("/api/long-running-task-statuses",{},{})}]),a.factory("LongRunningTaskLog",["$resource",function(a){return a("/api/long-running-tasks-log",{},{})}]),a.factory("MetadataHistory",["$resource",function(a){return a("/api/metadata-history/:id",{id:"@id"},{query:{method:"GET"}})}]),a.factory("UrlRedirect",["$resource",function(a){return a("/api/url-redirects/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("UrlRedirectType",["$resource",function(a){return a("/api/url-redirect-types",{},{})}]),a.factory("Component",["$resource",function(a){return a("/api/components/:id",{id:"@id"},{update:{method:"PUT"},queryOwner:{method:"GET",isArray:!0,url:"/api/components/:owner"}})}]),a.factory("Newsletter",["$resource",function(a){return a("/api/newsletters/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryPublic:{method:"GET",isArray:!1,url:"/api/newsletters/public"},getContent:{method:"GET",url:"/api/newsletters/:newsletterId/content"},updateContent:{method:"PUT",url:"/api/newsletters/:newsletterId/content"}})}]),a.factory("Bookmark",["$resource",function(a){return a("/api/bookmarks/:id",{id:"@id"},{update:{method:"PUT"},saveMany:{method:"POST",isArray:!0,url:"/api/bookmarks/many"},queryDetail:{method:"GET",isArray:!1,url:"/api/bookmarks/detail"},queryLite:{method:"GET",isArray:!0,url:"/api/bookmarks/lite"},getDetail:{method:"GET",url:"/api/bookmarks/:id/detail"},getStations:{method:"GET",isArray:!0,url:"/api/bookmarks/stations"},getResourceTypes:{method:"GET",isArray:!0,url:"/api/bookmarks/resource-types"},download:{method:"GET",url:"/api/bookmarks/download",responseType:"text",transformResponse:function(a){return{data:a}}},getNotes:{method:"GET",url:"/api/bookmarks/:bookmarkId/notes"},getNotesConverted:{method:"GET",url:"/api/bookmarks/:bookmarkId/notes/converted"},saveNotes:{method:"GET",url:"/api/bookmarks/:bookmarkId/notes"},updateNotes:{method:"PUT",url:"/api/bookmarks/:bookmarkId/notes"},removeNotes:{method:"DELETE",url:"/api/bookmarks/:bookmarkId/notes"}})}]),a.factory("BookmarkGroup",["$resource",function(a){return a("/api/bookmark-groups/:id",{id:"@id"},{update:{method:"PUT"},clone:{method:"POST",url:"/api/bookmark-groups/:id/clone"}})}]),a.factory("BookmarkGroupPair",["$resource",function(a){return a("/api/bookmark-group-pairs/:id",{id:"@id"},{update:{method:"PUT"},saveMany:{method:"POST",isArray:!0,url:"/api/bookmark-group-pairs/many"}})}]),a.factory("GeneratePrintable",["$resource",function(a){return a("/generate-printable/resource-sections",null,{generateResourceSections:{method:"POST",responseType:"arraybuffer",transformResponse:function(a){return{data:a}}}})}]),a.factory("Analytics",["$resource",function(a){return a("/api/analytics",{},{queryResources:{method:"GET",url:"/api/analytics/resources",isArray:!0},queryCities:{method:"GET",url:"/api/analytics/cities",isArray:!0},getTotal:{method:"GET",url:"/api/analytics/total"}})}]),a.factory("Feature",["$resource",function(a){return a("/api/features/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryConverted:{method:"GET",isArray:!1,url:"/api/features/converted"}})}]),a.factory("FeaturedEvent",["$resource",function(a){return a("/api/featured-events/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryConverted:{method:"GET",isArray:!1,url:"/api/featured-events/converted"}})}]),a.factory("UsefulLink",["$resource",function(a){return a("/api/useful-links/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"}})}]),a.factory("UsefulDownload",["$resource",function(a){return a("/api/useful-downloads/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"}})}]),a.factory("ChampionApplication",["$resource",function(a){return a("/api/champion-applications/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},getByUserId:{method:"GET",url:"/api/champion-applications/user/:userId"}})}]),a.factory("Bundle",["$resource",function(a){return a("/api/bundles/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryDetail:{method:"GET",isArray:!1,url:"/api/bundles/detail"},update:{method:"PUT"}})}]),a.factory("BundleResource",["$resource",function(a){return a("/api/bundle-resources/:id",{id:"@id"},{update:{method:"PUT"},queryBundle:{method:"GET",isArray:!0,url:"/api/bundles/:bundleId/resources"},queryBundleDetail:{method:"GET",isArray:!0,url:"/api/bundles/:bundleId/resources/detail"}})}]),a.factory("BundleEmphasis",["$resource",function(a){return a("/api/bundle-emphases/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("BundleBundleEmphasis",["$resource",function(a){return a("/api/bundle-bundle-emphases/:id",{id:"@id"},{update:{method:"PUT"},queryBundle:{method:"GET",isArray:!0,url:"/api/bundles/:bundleId/emphases"},queryBundleDetail:{method:"GET",isArray:!0,url:"/api/bundles/:bundleId/emphases/detail"}})}]),a.factory("BundleResourceEmphasis",["$resource",function(a){return a("/api/bundle-resource-emphases/:id",{id:"@id"},{update:{method:"PUT"},queryBundleResource:{method:"GET",isArray:!0,url:"/api/bundle-resources/:bundleResourceId/emphases"},queryBundleResourceDetail:{method:"GET",isArray:!0,url:"/api/bundle-resources/:bundleResourceId/emphases/detail"}})}]),a.factory("ConferenceDay",["$resource",function(a){return a("/api/conference-days/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryPublic:{method:"GET",isArray:!1,url:"/api/conference-days/public"}})}]),a.factory("CmSnippets",["$resource",function(a){return a(cmHelper.scriptBaseUrl+"/admin-common/editor/cm-snippets.json",{},{})}]),a.factory("ExtraSiteSection",["$resource",function(a){return a("/api/extra-site-sections/:id",{id:"@id"},{update:{method:"PUT"},queryDetail:{method:"GET",isArray:!0,url:"/api/extra-site-sections/detail"}})}]),a.factory("ExtraSitePage",["$resource",function(a){return a("/api/extra-site-pages/:id",{id:"@id"},{update:{method:"PUT"},queryDetail:{method:"GET",isArray:!0,url:"/api/extra-site-pages/detail"}})}]),a.factory("ExtraSitePageSection",["$resource",function(a){return a("/api/extra-site-page-sections/:id",{id:"@id"},{queryExtraSitePage:{url:"/api/extra-site-pages/:extraSitePageId/sections",method:"GET",isArray:!0}})}]),a.factory("ExtraSitePageInclude",["$resource",function(a){return a("/api/extra-site-page-includes/:id",{id:"@id"},{update:{method:"PUT"},queryExtraSitePage:{url:"/api/extra-site-pages/:extraSitePageId/includes",method:"GET",isArray:!0}})}]),a.factory("ResourceTrialRequest",["$resource",function(a){return a("/api/resource-trial-requests/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryDetail:{method:"GET",isArray:!1,url:"/api/resource-trial-requests/detail"},update:{method:"PUT"},getDetail:{method:"GET",url:"/api/resource-trial-requests/:id/detail"}})}]),a.factory("ResourceTrial",["$resource",function(a){return a("/api/resource-trials/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryDetail:{method:"GET",isArray:!1,url:"/api/resource-trials/detail"},update:{method:"PUT"},getDetail:{method:"GET",url:"/api/resource-trials/:id/detail"}})}]),a.factory("ChampionUsefulFile",["$resource",function(a){return a("/api/champion-useful-files/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"}})}]),a.factory("TeacherPerspective",["$resource",function(a){return a("/api/teacher-perspectives/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryConverted:{method:"GET",isArray:!1,url:"/api/teacher-perspectives/converted"},update:{method:"PUT"},getConverted:{method:"GET",isArray:!1,url:"/api/teacher-perspectives/:friendlyId/converted"},getCategories:{method:"GET",isArray:!0,url:"/api/teacher-perspectives/categories"},getStations:{method:"GET",isArray:!0,url:"/api/teacher-perspectives/stations"},getResourceTypes:{method:"GET",isArray:!0,url:"/api/teacher-perspectives/resource-types"}})}]),a.factory("TeacherPerspectiveCategory",["$resource",function(a){return a("/api/teacher-perspective-categories/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("TeacherPerspectiveCategoryPair",["$resource",function(a){return a("/api/teacher-perspective-category-pairs/:id",{id:"@id"},{update:{method:"PUT"},queryTeacherPerspective:{method:"GET",isArray:!0,url:"/api/teacher-perspectives/:teacherPerspectiveId/categories"},queryTeacherPerspectiveDetail:{method:"GET",isArray:!0,url:"/api/teacher-perspectives/:teacherPerspectiveId/categories/detail"}})}]),a.factory("PedagogyPageOverview",["$resource",function(a){return a("/api/pedagogy-page-overviews/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryConverted:{method:"GET",isArray:!1,url:"/api/pedagogy-page-overviews/converted"},update:{method:"PUT"}})}]),a.factory("PedagogyPageProperty",["$resource",function(a){return a("/api/pedagogy-page-properties/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("PedagogyPageOverviewProperty",["$resource",function(a){return a("/api/pedagogy-page-overview-properties/:id",{id:"@id"},{update:{method:"PUT"},queryOverview:{method:"GET",isArray:!0,url:"/api/pedagogy-page-overviews/:overviewId/properties"},queryOverviewDetail:{method:"GET",isArray:!0,url:"/api/pedagogy-page-overviews/:overviewId/properties/detail"}})}]),a.factory("Webinar",["$resource",function(a){return a("/api/webinars/:id",{id:"@id"},{query:{method:"GET",isArray:!1},queryConverted:{method:"GET",isArray:!1,url:"/api/webinars/converted"},update:{method:"PUT"}})}]),a.factory("ConvertImage",["$resource",function(a){return a("/convert-image",null,{convertImage:{method:"POST"}})}]),a.factory("InteractivityLabel",["$resource",function(a){return a("/api/interactivity-labels/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("ArticleType",["$resource",function(a){return a("/api/article-types/:id",{id:"@id"},{update:{method:"PUT"}})}]),a.factory("Article",["$resource",function(a){return a("/api/articles/:id",{id:"@id"},{query:{method:"GET",isArray:!1},update:{method:"PUT"},queryConverted:{method:"GET",isArray:!1,url:"/api/articles/converted"}})}]),a.factory("NewALevel",["$resource",function(a){return a("/api/new-a-level",{},{update:{method:"PUT"}})}]),a.factory("CopyrightLicence",["$resource",function(a){return a("/api/copyright-licences/:id",{id:"@id"},{update:{method:"PUT"}})}])}(),function(){var a=angular.module("cmAutocomplete",[]),b=function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},c=function(a,b){return a?{suggestions:b.suggestions.filter(function(b){var c=b.value;if(!c)return!1;c=c.toLowerCase();var d=a.toLowerCase();return c.indexOf(" "+d)>=0||c.substr(0,d.length)==d})}:{suggestions:b.suggestions}},d=function(a,b,d){b||d({suggestions:[]}),a.autocompleteCache=a.autocompleteCache||{};var e=$.extend({},a.params||{});e.query=b.substr(0,1);var f=$.param(e);if(a.autocompleteCache[f])return void(a.autocompleteCache[f].data?d(c(b,a.autocompleteCache[f].data)):a.autocompleteCache[f].waiting.push({query:b,callback:d}));a.autocompleteCache[f]={waiting:[{query:b,callback:d}]},$.getJSON(a.serviceUrl+(a.serviceUrl.indexOf("?")>=0?"&":"?")+$.param(e),function(b){a.autocompleteCache[f].data=b,a.autocompleteCache[f].waiting.forEach(function(a){a.callback(c(a.query,b))}),a.autocompleteCache[f].waiting=[]})};a.directive("cmAutocomplete",[function(){return{link:function(a,c,e){var f=a.container||document.body,g=void 0;a.lookup?g=a.lookup:a.singleCharLookup&&(g=function(b,c){d(a,b,c)}),$(c[0]).autocomplete({serviceUrl:a.serviceUrl,onSelect:function(b){a.onSelect&&a.$apply(function(){a.onSelect(b,a.onSelectData)})},formatResult:function(a,c){var d=a.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),e="(\\b"+b(c)+")";return d.replace(new RegExp(e,"gi"),"<strong>$1</strong>")},params:a.params,appendTo:f,triggerSelectOnValidInput:null==a.selectOnValidInput||a.selectOnValidInput,forceFixPosition:!0,lookup:g}),a.$watch("params",function(){$(c[0]).autocomplete().clearCache(),$(c[0]).autocomplete().setOptions({params:a.params})})},scope:{serviceUrl:"@cmAutocomplete",onSelect:"=cmOnSelect",onSelectData:"=?cmOnSelectData",params:"=?cmParams",selectOnValidInput:"=?cmSelectOnValidInput",container:"@cmContainer",lookup:"=?cmLookup",singleCharLookup:"@cmSingleCharLookup"},transclude:!0}}])}(),function(){angular.module("cmBrowseModal",["cmApi","cmAuth"]).controller("BrowseModalController",["$scope","$timeout","Resource","ResourceType","ReviewQuestionType","Line","Station","LineStation","PervasiveIdea","Glossary","Bundle","Auth",function(a,b,c,d,e,f,g,h,i,j,k,l){a.viewModel=a.viewModel||{},a.viewModel.pageSize=25,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.typeOption=null,a.viewModel.resourceTypeIdSelected=null,a.viewModel.reviewQuestionTypeIdSelected=null,a.viewModel.lineIdSelected=null,a.viewModel.stationIdSelected=null,a.viewModel.resourceList=[],a.viewModel.lineStations=[],a.viewModel.lines=[],a.viewModel.stations=[],a.viewModel.pervasiveIdeas=i.query(),a.viewModel.stationList=[],a.viewModel.glossaryList=[],a.viewModel.bundles=[],a.viewModel.autoUpdate=!0;for(var m="abcdefghijklmnopqrstuvwxyz",n=[],o=0;o<m.length;o++)n.push(m.substr(o,1));a.viewModel.letters=n,a.viewModel.letterSelected=null,a.viewModel.otherResourceTypes=[],a.viewModel.browseComponent=cmHelper.templateBaseUrl+"/browse-component.html",a.viewModel.newTabUrl="/browse",a.viewModel.resourceTypes=d.query(function(){a.viewModel.otherResourceTypes=a.viewModel.resourceTypes.filter(function(a){return"review-question"!=a.friendlyId&&a.description})}),a.viewModel.reviewQuestionTypes=e.query(),a.updateStationLines=function(){var b=[];a.viewModel.stations.forEach(function(c){var d={station:c};b.push(d);var e=a.viewModel.lineStations.filter(function(a){return a.stationId==c.id}),f=e.map(function(b){var c=a.viewModel.lines.filter(function(a){return a.id==b.lineId});return c.length>0?c[0]:null});d.lines=f.filter(function(a){return null!=a})}),a.viewModel.stationList=b},a.viewModel.lines=f.query(function(){a.updateStationLines()}),a.viewModel.lineStations=h.query(function(){a.updateStationLines()}),a.viewModel.stations=g.query(function(){a.updateStationLines()}),a.filterStations=function(){return a.viewModel.stationList.filter(function(b){
return!a.viewModel.lineIdSelected||b.lines.filter(function(b){return b.id==a.viewModel.lineIdSelected}).length>0})},a.toggleTypeOption=function(b){if(a.viewModel.typeOption==b)return void(a.viewModel.typeOption=null);a.viewModel.typeOption=b};var p=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b};a.updateBrowseData=function(){if(cmHelper.setSessionStorage("browseModal.results",null),!a.viewModel.typeOption)return cmHelper.setSessionStorage("browseModal.data",null),void(a.viewModel.newTabUrl="/browse");cmHelper.setSessionStorage("browseModal.data",JSON.stringify({typeOption:a.viewModel.typeOption,resourceType:a.viewModel.resourceTypeIdSelected,reviewQuestionType:a.viewModel.reviewQuestionTypeIdSelected,line:a.viewModel.lineIdSelected,station:a.viewModel.stationIdSelected,letter:a.viewModel.letterSelected,currentPage:a.viewModel.currentPage})),a.viewModel.newTabUrl=q()},a.updateBrowseDataResults=function(){if(!a.viewModel.typeOption)return void cmHelper.setSessionStorage("browseModal.results",null);"RichResource"==a.viewModel.typeOption||"ReviewQuestion"==a.viewModel.typeOption?cmHelper.setSessionStorage("browseModal.results",JSON.stringify({list:a.viewModel.resourceList,totalRows:a.viewModel.totalRows})):"Glossary"==a.viewModel.typeOption?cmHelper.setSessionStorage("browseModal.results",JSON.stringify({list:a.viewModel.glossaryList,totalRows:a.viewModel.totalRows})):"Bundle"==a.viewModel.typeOption?cmHelper.setSessionStorage("browseModal.results",JSON.stringify({list:a.viewModel.bundles,totalRows:a.viewModel.totalRows})):cmHelper.setSessionStorage("browseModal.results",null)},a.getBrowseList=function(){a.updateBrowseData(),a.getResourceList(),a.getGlossaryList(),a.getBundleList()},a.getResourceList=function(){if("RichResource"!=a.viewModel.typeOption&&"ReviewQuestion"!=a.viewModel.typeOption)return void(a.viewModel.resourceList=[]);a.viewModel.searching=!0,a.viewModel.pageSize=25,c.getList({startRow:p(),maxRows:a.viewModel.pageSize,typeOption:a.viewModel.typeOption,resourceType:a.viewModel.resourceTypeIdSelected,reviewQuestionType:a.viewModel.reviewQuestionTypeIdSelected,line:a.viewModel.lineIdSelected,station:a.viewModel.stationIdSelected},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.resourceList=c.results,a.viewModel.searching=!1,b(function(){cmSite.processContent()}),a.updateBrowseDataResults()},function(){a.viewModel.searching=!1})},a.getGlossaryList=function(){if("Glossary"!=a.viewModel.typeOption)return void(a.viewModel.glossaryList=[]);a.viewModel.searching=!0,a.viewModel.pageSize=50,j.query({startRow:p(),maxRows:a.viewModel.pageSize,query:a.viewModel.letterSelected,queryType:"MatchStart"},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.glossaryList=c.suggestions.map(function(a){return a.data}),a.viewModel.searching=!1,b(function(){cmSite.processContent()}),a.updateBrowseDataResults()},function(){a.viewModel.searching=!1})},a.getBundleList=function(){if("Bundle"!=a.viewModel.typeOption)return void(a.viewModel.bundles=[]);a.viewModel.searching=!0,a.viewModel.pageSize=25,k.query({startRow:p(),maxRows:a.viewModel.pageSize},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.bundles=c.results,a.viewModel.searching=!1,b(function(){cmSite.processContent()}),a.updateBrowseDataResults()},function(){a.viewModel.searching=!1})};var q=function(){var b="/browse?maxRows="+a.viewModel.pageSize+"&startRow="+p();return a.viewModel.typeOption&&(b+="&typeOption="+a.viewModel.typeOption),a.viewModel.resourceTypeIdSelected&&"RichResource"==a.viewModel.typeOption&&(b+="&resourceType="+a.viewModel.resourceTypeIdSelected),a.viewModel.reviewQuestionTypeIdSelected&&"ReviewQuestion"==a.viewModel.typeOption&&(b+="&reviewQuestionType="+a.viewModel.reviewQuestionTypeIdSelected),a.viewModel.lineIdSelected&&(b+="&line="+a.viewModel.lineIdSelected),a.viewModel.stationIdSelected&&(b+="&station="+a.viewModel.stationIdSelected),a.viewModel.letterSelected&&(b+="&letter="+a.viewModel.letterSelected),b};a.pageChange=function(){a.viewModel.autoUpdate&&a.getBrowseList()},a.$watch("viewModel.typeOption",function(b,c){b!=c&&(a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList()),"function"==typeof ga&&ga("send","event","Browse section","click",a.viewModel.typeOption))}),a.$watch("viewModel.resourceTypeIdSelected",function(b,c){b!=c&&a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList())}),a.$watch("viewModel.reviewQuestionTypeIdSelected",function(b,c){b!=c&&a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList())}),a.$watch("viewModel.lineIdSelected",function(b,c){b!=c&&a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList())}),a.$watch("viewModel.stationIdSelected",function(b,c){b!=c&&a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList())}),a.$watch("viewModel.letterSelected",function(b,c){b!=c&&a.viewModel.autoUpdate&&(a.viewModel.currentPage=0,a.getBrowseList())}),a.getRestrictedAccessWarningText=cmHelper.getRestrictedAccessWarningText,a.getUnderContructionWarningText=cmHelper.getUnderContructionWarningText,a.getResourceRefText=cmHelper.getResourceRefText,a.viewModel.loadSessionData=function(){if(!a.viewModel.typeOption&&sessionStorage["browseModal.data"]){var c=null;try{c=JSON.parse(sessionStorage["browseModal.data"])}catch(e){}if(c){if(a.viewModel.autoUpdate=!1,a.viewModel.resourceTypeIdSelected=c.resourceType,a.viewModel.reviewQuestionTypeIdSelected=c.reviewQuestionType,a.viewModel.lineIdSelected=c.line,a.viewModel.stationIdSelected=c.station,a.viewModel.letterSelected=c.letter,a.viewModel.typeOption=c.typeOption,a.viewModel.currentPage=c.currentPage,b(function(){a.viewModel.autoUpdate=!0}),!sessionStorage["browseModal.results"])return void a.getBrowseList();var d=null;try{d=JSON.parse(sessionStorage["browseModal.results"])}catch(e){}if(!d||!d.list||0==d.list.length)return void a.getBrowseList();"RichResource"==a.viewModel.typeOption||"ReviewQuestion"==a.viewModel.typeOption?(a.viewModel.resourceList=d.list,a.viewModel.totalRows=d.totalRows,b(function(){cmSite.processContent()})):"Glossary"==a.viewModel.typeOption?(a.viewModel.glossaryList=d.list,a.viewModel.totalRows=d.totalRows,b(function(){cmSite.processContent()})):"Bundle"==a.viewModel.typeOption?(a.viewModel.bundles=d.list,a.viewModel.totalRows=d.totalRows,b(function(){cmSite.processContent()})):a.getBrowseList()}}},a.viewModel.browseFor=function(c){a.viewModel.autoUpdate=!1,a.viewModel.resourceTypeIdSelected=c.resourceType,a.viewModel.reviewQuestionTypeIdSelected=c.reviewQuestionType,a.viewModel.lineIdSelected=c.line,a.viewModel.stationIdSelected=c.station,a.viewModel.letterSelected=c.letter,a.viewModel.typeOption=c.typeOption,a.viewModel.currentPage=0,b(function(){a.viewModel.autoUpdate=!0}),a.getBrowseList()},a.getInteractivityLabelString=function(a){return a.interactivityLabels&&0!=a.interactivityLabels.length?"Contains interactive elements - "+a.interactivityLabels.map(function(a){return a.name}).join(", "):null}}]);var a=function(){var a=this;a.modal=new CmModal({blockHeaderMenu:!1}),a.hasShown=!1,a.viewModel={},a.contentElement=null,$.get("/static/spa-templates/cm-browse-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,d){var e=b.$new();e.viewModel=a.viewModel,d(c)(e),a.modal.setContent(c[0]),a.contentElement=c[0]}])})};a.prototype.show=function(){var a=this;a.modal.show(),a.hasShown||(a.viewModel.loadSessionData&&a.viewModel.loadSessionData(),a.hasShown=!0)},a.prototype.hide=function(){this.modal.hide()},a.prototype.getContentElement=function(){return this.contentElement},a.prototype.browse=function(a){var b=this;b.viewModel.browseFor&&b.viewModel.browseFor(a)},window.CmBrowseModal=a}(),function(){var a=function(a){var b=this;b.cardsElement=$(a),b.locked=!1,b.initializeCards(),$(window).on("load",function(){b.positionCards()}),$(window).resize(function(){b.positionCards()}),cmSite.on("processDone",function(){b.cardsElement.find('[data-cm-element="card"] img').each(function(){$(this).on("load",function(){b.positionCards()})}),b.positionCards(),setTimeout(function(){cmSite.typesetMath()},0)}),MathJax.Hub.Register.MessageHook("End Process",function(){b.positionCards()})};a.create=function(b){var c=$(b).data("cm-cards");if(c)return c.positionCards(),c;var d=new a(b);return $(b).data("cm-cards",d),d};var b=function(a){var b={h:"",v:""};if(!a)return b;var c=a.split(" ");return b="center"==a||"centre"==a?{h:"center",v:""}:"left"==a?{h:"left",v:""}:"right"==a?{h:"right",v:""}:"top"==a?{h:"top",v:""}:"middle"==a?{h:"middle",v:""}:"bottom"==a?{h:"bottom",v:""}:2!=c.length?{h:"",v:""}:"centre"==c[1]?{h:"center",v:c[0]}:{h:c[1],v:c[0]}};a.prototype.initializeCards=function(){var a=this;a.cardsOuterElement=a.cardsElement.children('[data-cm-element="cards-outer"]'),a.cardsInnerElement=a.cardsOuterElement.children('[data-cm-element="cards-inner"]'),a.options={},a.options.maxWidth=Number(a.cardsElement.attr("data-cm-max-width"))||null,a.options.minWidth=Number(a.cardsElement.attr("data-cm-min-width"))||null,a.options.minHeight=Number(a.cardsElement.attr("data-cm-min-height"))||null,a.options.cardWidth=Number(a.cardsElement.attr("data-cm-card-width"))||null,a.options.cardMaxWidth=Number(a.cardsElement.attr("data-cm-card-max-width"))||null,a.options.cardMinWidth=Number(a.cardsElement.attr("data-cm-card-min-width"))||null,a.options.cardMinHeight=Number(a.cardsElement.attr("data-cm-card-min-height"))||null,a.options.wrap=a.cardsElement.attr("data-cm-wrap")||"auto",a.options.sortable=!1,"true"==a.cardsElement.attr("data-cm-sortable")&&(a.options.sortable=!0,a.cardsElement.addClass("cards-sortable")),a.options.fitToScreen=!1,"true"==a.cardsElement.attr("data-cm-fit-to-screen")?a.options.fitToScreen=!0:"false"==a.cardsElement.attr("data-cm-fit-to-screen")&&(a.options.fitToScreen=!1),a.options.fontSize=a.cardsElement.attr("data-cm-font-size")||null,a.options.fontSize&&a.cardsElement.addClass("cards-font-size-"+a.options.fontSize);var c=a.cardsElement.attr("data-cm-card-padding"),i=[];if(c&&(i=c.split(" ").map(function(a){return isNaN(a)?null:Number(a)}).filter(function(a){return null!=a})),1==i.length){var j=i[0];a.options.cardPadding=[j,j,j,j]}else if(2==i.length){var k=i[0],l=i[1];a.options.cardPadding=[k,l,k,l]}else 4!=i.length?a.options.cardPadding=[30,30,30,30]:a.options.cardPadding=i;var m=a.cardsElement.attr("data-cm-card-spacing");if(m){var n=m.split(" ");a.options.cardHSpacing=Number(n[0]),a.options.cardVSpacing=Number(n[n.length-1])}if((null==a.options.cardHSpacing||isNaN(a.options.cardHSpacing))&&(a.options.cardHSpacing=10),(null==a.options.cardVSpacing||isNaN(a.options.cardVSpacing))&&(a.options.cardVSpacing=a.options.cardHSpacing),a.options.cardRowSpacing=Number(a.cardsElement.attr("data-cm-card-row-spacing")),isNaN(a.options.cardRowSpacing)&&(a.options.cardRowSpacing=0),a.options.backgroundImage=a.cardsElement.attr("data-cm-background-image")||null,a.options.backgroundImageFit=a.cardsElement.attr("data-cm-background-image-fit")||null,a.options.backgroundImage){a.backgroundImageContainer=$('<div class="cm-cards-background-image-container"></div>').css("position","absolute").css("z-index","0").css("left","0").css("top","0").css("right","0").css("bottom","0").appendTo(a.cardsInnerElement);var o="100% 100%",p=null;"cover"==a.options.backgroundImageFit?(o="cover",p="cover"):"contain"==a.options.backgroundImageFit&&(o="contain",p="contain"),$('<img alt="Cards background image" />').css("width","100%").css("height","100%").css("margin","0").css("max-width","none").attr("src",a.options.backgroundImage).css("object-fit",p).appendTo(a.backgroundImageContainer),a.backgroundImageBgContainer=$('<div class="cm-cards-background-image-bg"></div>').css("position","absolute").css("z-index","1").css("left","0").css("top","0").css("right","0").css("bottom","0").appendTo(a.backgroundImageContainer),a.backgroundImageBgContainer.css("background-image",'url("'+a.options.backgroundImage+'")').css("background-size",o)}a.options.style=a.cardsElement.attr("data-cm-style")||null,a.options.style&&a.cardsElement.addClass("cards-style-"+a.options.style),a.options.spaceRight=Number(a.cardsElement.attr("data-cm-space-right")),isNaN(a.options.spaceRight)&&(a.options.spaceRight=5),a.options.spaceBottom=Number(a.cardsElement.attr("data-cm-space-bottom")),isNaN(a.options.spaceBottom)&&(a.options.spaceBottom=5),a.options.spaceLeft=Number(a.cardsElement.attr("data-cm-space-left")),isNaN(a.options.spaceLeft)&&(a.options.spaceLeft=5),a.options.spaceTop=Number(a.cardsElement.attr("data-cm-space-top")),isNaN(a.options.spaceTop)&&(a.options.spaceTop=5),a.options.align=a.cardsElement.attr("data-cm-align")||null,a.options.align&&a.cardsElement.addClass("cards-align-"+a.options.align),a.options.sortArrows=a.cardsElement.attr("data-cm-sort-arrows")||null;var q=a.cardsElement.attr("data-cm-background-image-margin")||null,r=[];if(q&&(r=q.split(" ").map(function(a){return isNaN(a)?null:Number(a)}).filter(function(a){return null!=a})),1==r.length){var j=r[0];a.options.backgroundImageMargin=[j,j,j,j]}else if(2==r.length){var k=r[0],l=r[1];a.options.backgroundImageMargin=[k,l,k,l]}else 4!=r.length?a.options.backgroundImageMargin=[0,0,0,0]:a.options.backgroundImageMargin=r;a.backgroundImageContainer&&a.backgroundImageContainer.css("left",a.options.backgroundImageMargin[0]+"px").css("top",a.options.backgroundImageMargin[1]+"px").css("right",a.options.backgroundImageMargin[2]+"px").css("bottom",a.options.backgroundImageMargin[3]+"px"),a.options.layout=a.cardsElement.attr("data-cm-layout")||null,a.options.fitToCards=!a.options.sortable&&"stacked"!=a.options.layout,"true"==a.cardsElement.attr("data-cm-fit-to-cards")?a.options.fitToCards=!0:"false"==a.cardsElement.attr("data-cm-fit-to-cards")&&(a.options.fitToCards=!1);var s=b(a.cardsElement.attr("data-cm-card-content-align"));a.options.cardContentHAlign=s.h,a.options.cardContentVAlign=s.v,a.options.cardContentHAlign&&a.cardsElement.attr("data-cm-card-content-h-align",a.options.cardContentHAlign),a.options.cardContentVAlign&&a.cardsElement.attr("data-cm-card-content-v-align",a.options.cardContentVAlign),a.options.minWidthBehaviour=a.cardsElement.attr("data-cm-min-width-behaviour")||a.cardsElement.attr("data-cm-min-width-behavior")||null,"scroll"==a.options.minWidthBehaviour&&a.cardsOuterElement.css("overflow-x","auto"),a.options.resizable=!1,a.options.sortable&&"true"==a.cardsElement.attr("data-cm-resizable")&&(a.options.resizable=!0),a.cards=[];var t=0;a.cardsElement.find('[data-cm-element="card"]').each(function(){var c=$(this),f={element:c};f.depth=t+1,f.row=Number(c.attr("data-cm-row"))||0,f.column=Number(c.attr("data-cm-column"))||0;var g=b(f.element.attr("data-cm-content-align"));if(f.contentHAlign=g.h,f.contentVAlign=g.v,f.contentHAlign&&f.element.attr("data-cm-content-h-align",f.contentHAlign),f.contentVAlign&&f.element.attr("data-cm-content-v-align",f.contentVAlign),f.fontSize=f.element.attr("data-cm-font-size")||null,f.fontSize&&f.element.addClass("card-font-size-"+f.fontSize),f.dragData=null,f.parent=a,f.element.on("mouseenter",function(a){d(f,a)}),f.element.on("mousedown touchstart",function(a){e(f,a)}),f.marker=c.attr("data-cm-marker"),f.marker){var i=$('<div class="cm-card-marker"></div>').text(f.marker);f.element.prepend(i),f.marker.length>3&&i.attr("data-cm-border",!1)}var j=c.attr("data-cm-toggle");if("off"==j||"on"==j){f.initialToggle=j;var k=$('<a tabindex="0" class="cm-card-toggle-button"></a>');f.element.append(k),f.toggleButtonElement=k,k.click(function(){h(f)})}f.element.css("padding",a.options.cardPadding[1]+"px "+a.options.cardPadding[2]+"px "+a.options.cardPadding[3]+"px "+a.options.cardPadding[0]+"px"),f.style=c.attr("data-cm-style"),f.style&&f.element.addClass("card-style-"+f.style),"standard"==a.options.sortArrows&&(f.sortArrowRightElement=$('<div class="card-sort-arrow" data-cm-card-sort-arrow=""></div>').hide(),a.cardsElement.append(f.sortArrowRightElement),f.sortArrowLeftElement=$('<div class="card-sort-arrow" data-cm-card-sort-arrow=""></div>').hide(),a.cardsElement.append(f.sortArrowLeftElement)),a.cards.push(f),t++}),$(window).on("mouseup touchend",function(b){a.cards.forEach(function(a){g(a,b)})}),$(window).on("mousemove touchmove",function(b){a.cards.forEach(function(a){f(a,b)})});var u=null;a.cardRows=[];var v=null;a.cards.forEach(function(b){var c=b.row;c===u&&v||(v=[],a.cardRows.push(v),u=c),v.push(b)}),a.toolsElement=$('<div class="cm-cards-tools" data-cm-cards-tools=""></div>').appendTo(a.cardsElement),a.resetButton=$('<a tabindex="0"></a>').append('<span class="icon-reset"></span><span class="cm-tooltip" style="margin-left:-30px;">Reset</span>'),a.resetButton.hide(),a.resetButton.appendTo(a.toolsElement),a.resetButton.click(function(){CmModal.showConfirm("Are you sure?","Are you sure you want to reset the cards?",function(){a.unlock()})}),a.showCardsButton=$('<a tabindex="0"></a>').append('<span class="icon-view"></span><span class="cm-tooltip" style="margin-left:-70px;">Show all hidden cards</span>'),a.showCardsButton.hide(),a.showCardsButton.appendTo(a.toolsElement),a.showCardsButton.click(function(){a.showAllCards()}),a.exportImageButton=$('<a tabindex="0"></a>').append('<span class="icon-file-image"></span><span class="cm-tooltip" style="margin-left:-70px;">Export image</span>'),a.exportImageButton.appendTo(a.toolsElement),a.exportImageButton.hide(),a.exportImageButton.click(function(){a.exportImage()}),a.printButton=$('<a tabindex="0"></a>').append('<span class="icon-print"></span><span class="cm-tooltip" style="margin-left:-30px;">Print</span>'),a.printButton.appendTo(a.toolsElement),a.printButton.hide(),a.printButton.click(function(){a.printCards()}),a.options.resizable&&(a.resizeBottomBar={dragData:null},a.resizeBottomBar.element=$('<div class="cm-cards-resize-bottom-bar"><div class="cm-cards-resize-bottom-bar-inner"><span class="icon-ellipsis"></span></div></div>').appendTo(a.cardsElement),a.resizeBottomBar.element.on("mousedown",function(b){console.log("mousedown");var c={x:b.pageX,y:b.pageY};void 0===b.pageX&&b.originalEvent&&b.originalEvent.touches&&b.originalEvent.touches.length>0&&(c={x:b.originalEvent.touches[0].pageX,y:b.originalEvent.touches[0].pageY});var d=a.resizeBottomBar.element.offset();a.resizeBottomBar.dragData={startPosition:{x:c.x-d.left,y:c.y-d.top},started:!1},b.preventDefault()}),$(window).on("mouseup touchend",function(b){a.resizeBottomBar.dragData&&(a.resizeBottomBar.dragData=null)}),$(window).on("mousemove touchmove",function(b){if(a.resizeBottomBar.dragData){var c={x:b.pageX,y:b.pageY};void 0===b.pageX&&b.originalEvent&&b.originalEvent.touches&&b.originalEvent.touches.length>0&&(c={x:b.originalEvent.touches[0].pageX,y:b.originalEvent.touches[0].pageY});var d=c.x-a.resizeBottomBar.dragData.startPosition.x,e=c.y-a.resizeBottomBar.dragData.startPosition.y,f=a.resizeBottomBar.element.offset();if(a.resizeBottomBar.dragData.started||Math.abs(e-f.top)>1&&(a.resizeBottomBar.dragData.started=!0,a.lock()),a.resizeBottomBar.dragData.started){var g=a.cardsElement.offset();d-=g.left,e-=g.top;var h=a.cardsElement.outerHeight()-a.cardsInnerElement.outerHeight();e>100&&(a.cardsElement.css("height",e+"px"),a.cardsInnerElement.css("height",e-h+"px"))}b.preventDefault()}})),a.resetCardVisibilities(),a.updateShowCardsButton(),a.updateCardDepths(),a.positionCards()},a.prototype.lock=function(){var a=this;a.locked||(a.locked=!0,a.cardsInnerElement.css("width",a.cardsInnerElement.width()+"px"),a.cardsInnerElement.css("height",a.cardsInnerElement.height()+"px"),a.cardsElement.css("width",a.cardsElement.outerWidth()+"px"),a.cardsElement.css("height",a.cardsElement.outerHeight()+"px"),a.resetButton.show(),a.exportImageButton.show(),a.printButton.show(),a.cardsElement.find("[data-cm-card-sort-arrow]").hide())},a.prototype.unlock=function(){var a=this;a.locked&&(a.locked=!1,a.cardsInnerElement.css("width","auto"),a.cardsInnerElement.css("height","auto"),a.cardsElement.css("width","auto"),a.cardsElement.css("height","auto"),a.resetButton.hide(),a.exportImageButton.hide(),a.printButton.hide(),a.resetCardVisibilities(),a.updateShowCardsButton(),a.resetCardDepths(),a.positionCards())},a.prototype.resetCardDepths=function(){var a=this,b=0;a.cards.forEach(function(a){a.depth=b+1,b++}),a.updateCardDepths()},a.prototype.updateCardDepths=function(){this.cards.forEach(function(a){a.element.css("z-index",a.depth.toString())})},a.prototype.moveCardToFront=function(a){var b=this,c=b.cards.slice(0),d=c.indexOf(a);if(!(d<0)){c.splice(d,1),c.sort(function(a,b){return a.depth-b.depth}),c.push(a);var e=0;c.forEach(function(a){a.depth=e+1,e++}),b.updateCardDepths()}},a.prototype.showAllCards=function(){this.cards.forEach(function(a){a.toggleable&&!a.visible&&h(a)})},a.prototype.positionCards=function(){var a=this;if(!a.locked){for(var b=0,c=0;c<a.cardRows.length;c++)b=Math.max(b,a.cardRows[c].length);var d=a.options.maxWidth?a.options.maxWidth:null;a.cardsElement.css("max-width",d?d+"px":"none"),a.cardsElement.css("min-width","0"),a.cardsInnerElement.css("min-width","0"),"scroll"==a.options.minWidthBehaviour?(d=a.cardsElement.outerWidth()-2,a.cardsElement.css("max-width",d+"px"),a.cardsInnerElement.css("min-width",a.options.minWidth?a.options.minWidth+"px":"0"),a.cardsElement.css("min-width","0")):(a.cardsInnerElement.css("min-width","0"),a.cardsElement.css("min-width",a.options.minWidth?a.options.minWidth+"px":"0"));var e=a.cardsInnerElement.width(),f=a.options.cardHSpacing,g=a.options.cardVSpacing,h=a.options.cardRowSpacing,i=a.options.cardMaxWidth||a.options.cardWidth||e;i=Math.min(i,a.options.cardMaxWidth||i),i=Math.min(i,a.options.cardWidth||i);var j=0;j=Math.max(j,a.options.cardMinWidth||j),j=Math.max(j,a.options.cardWidth||j);var k=Math.min(i,a.options.cardWidth||i);k=Math.max(k,j);var l=a.options.spaceLeft,m=a.options.spaceTop,n=0,o=j+a.options.spaceLeft+a.options.spaceRight;"none"==a.options.wrap&&(o=j+10*b+a.options.spaceLeft+a.options.spaceRight),e<o&&(e=o,a.cardsInnerElement.css("min-width",o+"px"));for(var p=0,q=0,r=k,c=0;c<a.cardRows.length;c++){var s=a.cardRows[c],t="stacked"==a.options.layout?e-a.options.spaceLeft-a.options.spaceRight-10:(e-a.options.spaceLeft-a.options.spaceRight)/s.length-f*(s.length-1)/s.length;r=Math.min(r,t)}r>i&&(r=i),r<j&&(r=j);for(var u=a.options.cardMinHeight||0,c=0;c<a.cardRows.length;c++)for(var s=a.cardRows[c],v=0;v<s.length;v++){var w=s[v].element;w.children("[data-cm-card-spacer]").remove(),w.css("top",m+"px").css("left",l+"px").css("width",r+"px").css("height","auto"),s[v].autoHeight=w.outerHeight(),u=Math.max(w.outerHeight(),u)}q=u,m=a.options.spaceTop;for(var c=0;c<a.cardRows.length;c++){var s=a.cardRows[c];l=a.options.spaceLeft;for(var v=0;v<s.length;v++){var w=s[v].element;if("stacked"==a.options.layout)n=Math.max(n,l+r+a.options.spaceRight),w.css("top",m+"px").css("left",l+"px").css("width",r+"px").css("height",u+"px"),l+=10;else if(r*s.length+f*(s.length-1)<=e-a.options.spaceRight-a.options.spaceLeft)n=Math.max(n,l+r+a.options.spaceRight),w.css("top",m+"px").css("left",l+"px").css("width",r+"px").css("height",u+"px"),l+=r+f;else if("none"!=a.options.wrap)v>0&&l+r>e-a.options.spaceRight&&(p++,l=a.options.spaceLeft,m+=u+g),n=Math.max(n,l+r+a.options.spaceRight),w.css("top",m+"px").css("left",l+"px").css("width",r+"px").css("height",u+"px"),l+=r+f;else{var x=e-r-a.options.spaceRight-a.options.spaceLeft,y=0;s.length>1&&(y=x/(s.length-1)),n=Math.max(n,l+r+a.options.spaceRight),w.css("top",m+"px").css("left",l+"px").css("width",r+"px").css("height",u+"px"),l+=y}}p++,m+=u,c<a.cardRows.length-1&&(m+=g+h)}var z=Math.max(m+a.options.spaceBottom,a.options.minHeight||0);if(a.options.fitToScreen){var A=Math.max($(window).height()-60,a.options.minHeight||0),B=a.cardsInnerElement.offset();if(A=Math.max(A,q+20*p),z>A&&p>1){for(var C=z-A,D=C/(p-1),E=null,F=0,G=a.options.spaceTop,c=0;c<a.cardRows.length;c++){for(var s=a.cardRows[c],v=0;v<s.length;v++){var w=s[v].element,H=w.offset().top;null!=E&&H>E&&F++;var I=w.offset().top-B.top-D*F;F>0&&I<G+20&&(I=G+20),w.css("top",I.toString()+"px"),E=H}G=I}z=A}}a.cardsInnerElement.css("height",z+"px"),1==a.options.fitToCards&&(d=Math.min(n+2,d||n+2),a.cardsElement.css("max-width",d+"px"));for(var c=0;c<a.cardRows.length;c++){var s=a.cardRows[c];l=0;for(var v=0;v<s.length;v++){var w=s[v].element,J=w.outerHeight();if(J-s[v].autoHeight>=2){var K=s[v].contentVAlign||a.options.cardContentVAlign,L=(J-s[v].autoHeight)/2;"top"==K?L=0:"bottom"==K&&(L=J-s[v].autoHeight),w.prepend($('<div data-cm-card-spacer=""></div>').css("height",L+"px"))}}}a.positionSortArrows()}},a.prototype.positionSortArrows=function(){var a=this;if("standard"==a.options.sortArrows)for(var b=a.cardsInnerElement.offset(),c=null,d=0,e=0;e<a.cardRows.length;e++){var f=a.cardRows[e];x=0;for(var g=0;g<f.length;g++){var h=f[g].sortArrowRightElement,i=f[g].sortArrowLeftElement,j=f[g].element,k=j.outerHeight(),l=j.outerWidth(),m=j.offset(),n=m.top;null!=c&&n>c?(d++,i&&(i.css("left",m.left-b.left-10+"px").css("top",m.top-b.top+k/2-10+"px"),i.show())):i&&i.hide(),e<a.cardRows.length-1||g<f.length-1?h&&(h.css("left",m.left-b.left+l-3+"px").css("top",m.top-b.top+k/2-10+"px"),h.show()):h&&h.hide(),c=n}}},a.prototype.updateShowCardsButton=function(){var a=this;if(a.showCardsButton){var b=!1;a.cards.forEach(function(a){a.toggleable&&!a.visible&&(b=!0)}),b?a.showCardsButton.show():a.showCardsButton.hide()}},a.prototype.resetCardVisibilities=function(){this.cards.forEach(function(a){var b=a.initialToggle;b&&("off"==b?(a.toggleable=!0,a.visible=!1,a.element.addClass("cm-toggle-off"),a.element.removeClass("cm-toggle-on")):(a.toggleable=!0,a.visible=!0,a.element.addClass("cm-toggle-on"),a.element.removeClass("cm-toggle-off")),i(a))})};var c=function(a,b){var c=a.element.outerWidth(),d=a.element.outerHeight(),e=a.parent.cardsInnerElement.offset(),f=a.parent.cardsInnerElement.width(),g=a.parent.cardsInnerElement.height(),h=b.x-e.left,i=b.y-e.top;h<-c/2&&(h=-c/2),h>f-c/2&&(h=f-c/2),i<-d/2&&(i=-d/2),i>g-d/2&&(i=g-d/2),a.element.css("left",h+"px").css("top",i+"px")},d=function(a,b){a.parent.options.sortable&&a.element.css("cursor","move").css("cursor","grab").css("cursor","-webkit-grab").css("cursor","-moz-grab")},e=function(a,b){if(a.parent.moveCardToFront(a),a.parent.options.sortable&&(!b.target||!b.target.nodeName||"a"!=b.target.nodeName.toLowerCase())){var c={x:b.pageX,y:b.pageY};void 0===b.pageX&&b.originalEvent&&b.originalEvent.touches&&b.originalEvent.touches.length>0&&(c={x:b.originalEvent.touches[0].pageX,y:b.originalEvent.touches[0].pageY});var d=a.element.offset();a.dragData={startPosition:{x:c.x-d.left,y:c.y-d.top},started:!1},b.preventDefault()}},f=function(a,b){if(a.parent.options.sortable&&a.dragData){var d={x:b.pageX,y:b.pageY};void 0===b.pageX&&b.originalEvent&&b.originalEvent.touches&&b.originalEvent.touches.length>0&&(d={x:b.originalEvent.touches[0].pageX,y:b.originalEvent.touches[0].pageY});var e=d.x-a.dragData.startPosition.x,f=d.y-a.dragData.startPosition.y,g=a.element.offset();a.element.css("cursor","move").css("cursor","grabbing").css("cursor","-webkit-grabbing").css("cursor","-moz-grabbing"),a.dragData.started||(Math.abs(e-g.left)>1||Math.abs(f-g.top)>1)&&(a.dragData.started=!0,a.parent.lock()),a.dragData.started&&c(a,{x:e,y:f}),b.preventDefault()}},g=function(a,b){a.parent.options.sortable&&a.dragData&&(a.dragData=null,a.element.css("cursor","move").css("cursor","grab").css("cursor","-webkit-grab").css("cursor","-moz-grab"))},h=function(a){a.visible?(a.element.removeClass("cm-toggle-on"),a.element.addClass("cm-toggle-off"),a.visible=!1):(a.element.removeClass("cm-toggle-off"),a.element.addClass("cm-toggle-on"),a.visible=!0),a.parent.lock(),a.parent.updateShowCardsButton(),i(a)},i=function(a){a.toggleButtonElement&&(a.toggleButtonElement.empty(),$("<span></span>").addClass(a.visible?"icon-hide":"icon-view").appendTo(a.toggleButtonElement),a.visible?$("<span></span>").text("Hide card").appendTo(a.toggleButtonElement):$("<span></span>").text("Show card").appendTo(a.toggleButtonElement))};a.prototype.exportImageInternal=function(){var a=this;a.toolsElement.hide();var b=function(b){if(a.exportedImageDataUrl&&a.exportImageWindow&&a.exportImageWindowLoaded){var c=a.exportImageWindow.document.body,d=a.exportImageWindow.document.createElement("img");d.setAttribute("alt","Cards image export"),d.setAttribute("src",a.exportedImageDataUrl),c.innerHTML="",c.appendChild(d)}};html2canvas(a.cardsElement,{onrendered:function(c){a.exportedImageDataUrl=c.toDataURL("image/png"),a.toolsElement.show(),b()}})},a.prototype.exportImage=function(){var a=this;a.exportedImageDataUrl=null,a.exportImageWindow=window.open("/placeholders/blank-page"),a.exportImageWindowLoaded=!1;var b=function(){if(a.exportImageWindowLoaded=!0,a.exportImageWindow.document.title="Cards image export",!a.exportedImageDataUrl){a.exportImageWindow.document.body.innerHTML='<div style="padding:10px;"><span class="icon-waiting cm-spin"></span> Generating cards image export. This may take a few seconds.</div>'}};a.exportImageWindow.addEventListener?a.exportImageWindow.addEventListener("DOMContentLoaded",b):a.exportImageWindow.attachEvent&&a.exportImageWindow.attachEvent("onload",b);var c="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js",d=function(){window.html2canvas?a.exportImageInternal():$.getScript(c,function(){a.exportImageInternal()})};window.Promise?d():$.getScript("https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.2.2/es6-promise.min.js",function(){d()})},a.prototype.printCards=function(){var a=this,b=$('<div class="cm-content" data-cm-content=""></div>').css("background-color","#ffffff").addClass("print-only"),c=a.cardsElement.clone();c.find("[data-cm-cards-tools]").hide();var d=[];c.find("img").each(function(){var a={element:$(this),loaded:!1};d.push(a),$(this).on("load",function(){a.loaded=!0,e()})}),b.append(c),$(document.body).append(b),$(document.body).addClass("print-hide-non-print-only");var e=function(){var a=!0;d.forEach(function(b){if(!b.loaded)return a=!1,!1}),a&&g()},f=!1,g=function(){f||(h&&clearTimeout(h),f=!0,window.print(),b.remove(),$(document.body).removeClass("print-hide-non-print-only"))},h=setTimeout(function(){g()},4e3);e()},window.CmCards=a}(),function(){angular.module("cmCommentsModal",["cmApi","cmAuth"]).controller("CommentsModalController",["$scope","$element","$timeout","$sce",function(a,b,c,d){a.viewModel=a.viewModel||{},a.viewModel.numComments=0,a.viewModel.introText=null,a.viewModel.commentedItemType=null,a.viewModel.promptLogin=function(){a.promptLogin("ToggleComments")},a.viewModel.promptRegister=function(){a.promptRegister()},a.$watch("viewModel.commentedItemIdentifier",function(){if(!a.viewModel.commentedItemIdentifier)return void(a.viewModel.commentedItemType=null);var b=cmHelper.parseIdentifierStringFriendly(a.viewModel.commentedItemIdentifier);b&&(a.viewModel.commentedItemType=b.typeFriendlyId),a.updateIntroText()}),a.updateIntroText=function(){var b="";b=a.viewModel.numComments>0?"resource"==a.viewModel.commentedItemType?"<p>Share your experience of using this resource in the classroom!</p><ul><li>How did you introduce the resource?</li> <li>What were the most interesting points in the lesson?</li></ul>":"station"==a.viewModel.commentedItemType?"Have you used these resources in a sequence of lessons? <br /> Share your experience!":"":"resource"==a.viewModel.commentedItemType?"<p>Be the first to share your experience of using this resource in the classroom!</p><ul><li>How did you introduce the resource?</li> <li>What were the most interesting points in the lesson?</li></ul>":"station"==a.viewModel.commentedItemType?"Have you used these resources in a sequence of lessons? <br /> Be the first to share your experience!":"Be the first to comment!",a.viewModel.introText=d.trustAsHtml(b)},a.updateNumberOfComments=function(d){a.viewModel.numComments=d,a.setNumberOfComments(d),
a.updateIntroText(),$(b[0]).closest(document).length>0&&c(function(){cmSite.processContent(b[0])})},a.updateIntroText()}]);var a=function(){var a=this;a.modal=new CmModal({blockHeaderMenu:!1}),a.viewModel={},a.viewModel.commentedItemIdentifier=null,a.viewModel.commentedItemTitle=null,$.get("/static/spa-templates/cm-comments-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,d){var e=b.$new();e.viewModel=a.viewModel,d(c)(e),a.modal.setContent(c[0])}])})};a.prototype.setCommentedItem=function(a,b){var c=this;c.viewModel.commentedItemIdentifier=a,c.viewModel.commentedItemTitle=b},a.prototype.show=function(){this.modal.show(),setTimeout(function(){cmSite.processContent()})},a.prototype.hide=function(){this.modal.hide()},window.CmCommentsModal=a}(),function(){var a=angular.module("cmCore",["ngSanitize","cmApi","cmAuth","cmUserMenu","cmPager","cmResourceTypesToggle","cmHelpSectionToggle","cmAutocomplete","cmAdminModalToggle","cmSearchModal","cmLoginRegisterModal","cmCommentsModal","cmBrowseModal","cmElements","cmBookmarkManager","cmBookmarkNotesModal","cmBookmarks","cmFeatures"]);a.config(["$locationProvider","$httpProvider",function(a,b){a.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1}),b.defaults.headers.common[cmSite.csrfTokenHeaderName]=function(){return Cookies.get(cmSite.csrfTokenCookieName)}}]),a.run(["$rootScope","$timeout","PublishStatus","UserAccount","BookmarkManager","ItemInfo","Auth",function(a,b,c,d,e,f,g){window.spaSetup&&(g.setCurrentUser(window.spaSetup.currentUser),g.setAccountSettings(window.spaSetup.accountSettings),a.appSettings=window.spaSetup.appSettings),a.spaSetup=window.spaSetup||{},a.rootViewModel={breadcrumb:[],showHomeInBreadcrumb:!0,title:null,headerMenuItemSelected:null,stationIdSelected:null,previousUrl:null,twoPreviousUrl:null,itemInfo:null},a.rootViewModel.adminData={currentPage:{editLink:null,editContentLink:null,publishStatus:null},adminModal:{sectionOpen:"Content"},showTools:null,itemInfo:{}},a.getTemplateUrl=function(a){return cmHelper.templateBaseUrl+a},a.rootViewModel.mapModal=new CmMapModal,a.rootViewModel.mapModal.modal.on("hidden",function(){"Map"==a.rootViewModel.headerMenuItemSelected&&(a.rootViewModel.headerMenuItemSelected=null,b(function(){}))}),a.rootViewModel.mapModal.modal.on("shown",function(){a.rootViewModel.headerMenuItemSelected="Map",b(function(){}),"function"==typeof ga&&ga("send","event","Menu button","click","Map")}),a.rootViewModel.searchModal=new CmSearchModal,a.rootViewModel.searchModal.modal.on("hidden",function(){"Search"==a.rootViewModel.headerMenuItemSelected&&(a.rootViewModel.headerMenuItemSelected=null,b(function(){}))}),a.rootViewModel.searchModal.modal.on("shown",function(){a.rootViewModel.headerMenuItemSelected="Search",b(function(){}),"function"==typeof ga&&ga("send","event","Menu button","click","Search")}),a.search=function(b){a.rootViewModel.searchModal.search(b),"Search"!=a.rootViewModel.headerMenuItemSelected&&a.toggleHeaderMenuItem("Search")},a.rootViewModel.browseModal=new CmBrowseModal,a.rootViewModel.browseModal.modal.on("hidden",function(){"Browse"==a.rootViewModel.headerMenuItemSelected&&(a.rootViewModel.headerMenuItemSelected=null,b(function(){}))}),a.rootViewModel.browseModal.modal.on("shown",function(){a.rootViewModel.headerMenuItemSelected="Browse",b(function(){}),"function"==typeof ga&&ga("send","event","Menu button","click","Browse")}),a.browse=function(b){a.rootViewModel.browseModal.browse(b),"Browse"!=a.rootViewModel.headerMenuItemSelected&&a.toggleHeaderMenuItem("Browse")},a.rootViewModel.loginRegisterModal=new CmLoginRegisterModal,a.rootViewModel.loginRegisterModal.modal.on("hidden",function(){"User"==a.rootViewModel.headerMenuItemSelected&&(a.rootViewModel.headerMenuItemSelected=null,b(function(){}))}),a.rootViewModel.loginRegisterModal.modal.on("shown",function(){a.rootViewModel.headerMenuItemSelected="User",b(function(){}),"function"==typeof ga&&ga("send","event","Menu button","click","User")}),a.promptLogin=function(b){if(a.currentUser.isLoggedIn())return void CmModal.showAlert("You are already logged in","Please log out first if you wish to log in as someone else.");a.rootViewModel.loginRegisterModal.setNewOrExisting("Existing"),"User"!=a.rootViewModel.headerMenuItemSelected&&a.toggleHeaderMenuItem("User"),a.rootViewModel.loginRegisterModal.setLoginAction(b)},a.promptRegister=function(){if(a.currentUser.isLoggedIn())return void CmModal.showAlert("You are already registered","Please contact the webmaster if you are having difficulties with your account. Please log out if you really want to create another account.");a.rootViewModel.loginRegisterModal.setNewOrExisting("New"),"User"!=a.rootViewModel.headerMenuItemSelected&&a.toggleHeaderMenuItem("User")},a.$watch("rootViewModel.headerMenuItemSelected",function(b,c){b!=c&&(cmHelper.setSessionStorage("root.headerMenuItemSelected",JSON.stringify(a.rootViewModel.headerMenuItemSelected)),cmHelper.setSessionStorage("root.previousHeaderMenuItemSelected",null))}),a.toggleHeaderMenuItem=function(b){a.rootViewModel.headerMenuItemSelected==b?a.rootViewModel.headerMenuItemSelected=null:a.rootViewModel.headerMenuItemSelected=b,a.updateHeaderDisplay()},a.hideHeaderItems=function(){a.rootViewModel.mapModal.hide(),a.rootViewModel.searchModal.hide(),a.rootViewModel.browseModal.hide(),a.rootViewModel.loginRegisterModal.hide(),a.rootViewModel.commentsModal&&a.rootViewModel.commentsModal.hide()},a.updateHeaderDisplay=function(){a.hideHeaderItems();var b=a.rootViewModel.headerMenuItemSelected;"Map"==b?a.rootViewModel.mapModal.show():"Search"==b?a.rootViewModel.searchModal.show():"Browse"==b?a.rootViewModel.browseModal.show():"User"!=b||a.currentUser.isLoggedIn()?"Comments"==b&&a.rootViewModel.commentsModal&&a.rootViewModel.commentsModal.show():a.rootViewModel.loginRegisterModal.show()},a.showMapWithLineSelected=function(b){a.toggleHeaderMenuItem("Map"),a.rootViewModel.mapModal.setSelectedLine(b)},a.rootViewModel.commentsModal=null,a.setCommentedItem=function(c,d){if(!c)return void(a.rootViewModel.commentsModal&&(a.rootViewModel.commentsModal.modal.remove(),a.rootViewModel.commentsModal=null));a.rootViewModel.commentedItemIdentifier=c,a.rootViewModel.commentsModal||(a.rootViewModel.commentsModal=new CmCommentsModal,a.rootViewModel.commentsModal.modal.on("hidden",function(){"Comments"==a.rootViewModel.headerMenuItemSelected&&(a.rootViewModel.headerMenuItemSelected=null,b(function(){}))}),a.rootViewModel.commentsModal.modal.on("shown",function(){a.rootViewModel.headerMenuItemSelected="Comments",b(function(){}),"function"==typeof ga&&ga("send","event","Menu button","click","Discuss")})),a.rootViewModel.commentsModal.setCommentedItem(c,d),"Comments"==a.rootViewModel.headerMenuItemSelected&&a.updateHeaderDisplay()},a.rootViewModel.numberOfComments=0,a.setNumberOfComments=function(b){a.rootViewModel.numberOfComments=b};var h=null,i=function(b){var c=$("#header");h&&$(h).closest(c).length>0||b&&b.closest(c).length>0||("User"==a.rootViewModel.headerMenuItemSelected&&a.currentUser.isLoggedIn()||"More"==a.rootViewModel.headerMenuItemSelected)&&a.toggleHeaderMenuItem(null)};$("body").on("mousedown touchstart",function(a){h=a.target}),$("body").on("mouseup touchend",function(b){a.$apply(function(){i($(b.target))})});var j=function(){if(sessionStorage["root.previousUrl"])try{a.rootViewModel.twoPreviousUrl=JSON.parse(sessionStorage["root.previousUrl"])}catch(e){}if(sessionStorage["root.currentUrl"])try{a.rootViewModel.previousUrl=JSON.parse(sessionStorage["root.currentUrl"]),cmHelper.setSessionStorage("root.previousUrl",JSON.stringify(a.rootViewModel.previousUrl))}catch(e){}if(a.rootViewModel.previousUrl==location.pathname+location.search&&(cmHelper.setSessionStorage("root.previousHeaderMenuItemSelected",null),cmHelper.setSessionStorage("root.headerMenuItemSelected",null)),sessionStorage["root.previousHeaderMenuItemSelected"]){var c=null;try{c=JSON.parse(sessionStorage["root.previousHeaderMenuItemSelected"])}catch(e){}c&&a.rootViewModel.twoPreviousUrl==location.pathname+location.search&&a.rootViewModel.headerMenuItemSelected!=c&&("Search"!=c&&"Browse"!=c||b(function(){a.toggleHeaderMenuItem(c)}))}if(cmHelper.setSessionStorage("root.previousHeaderMenuItemSelected",sessionStorage["root.headerMenuItemSelected"]),cmHelper.setSessionStorage("root.headerMenuItemSelected",JSON.stringify(a.rootViewModel.headerMenuItemSelected)),cmHelper.setSessionStorage("root.currentUrl",JSON.stringify(location.pathname+location.search)),a.updateItemInfoFromFriendlyUrl(location.pathname+location.search),sessionStorage["root.loadAction"]){var d=null;try{d=JSON.parse(sessionStorage["root.loadAction"])}catch(e){}cmHelper.setSessionStorage("root.loadAction",null),"ToggleComments"==d&&b(function(){a.toggleHeaderMenuItem("Comments")})}};if($(document).on("click","a[href]",function(b){if(!b.isDefaultPrevented()){if(b.target){var c=a.rootViewModel.searchModal.getContentElement();if(c&&$(b.target).closest(c).length>0)return;var d=a.rootViewModel.browseModal.getContentElement();if(c&&$(b.target).closest(d).length>0)return}cmHelper.setSessionStorage("root.previousHeaderMenuItemSelected",null),cmHelper.setSessionStorage("root.headerMenuItemSelected",null)}}),sessionStorage["root.headerMenuItemToSelectOnLoad"]){var k=null;try{k=JSON.parse(sessionStorage["root.headerMenuItemToSelectOnLoad"])}catch(r){}k&&a.rootViewModel.headerMenuItemSelected!=k&&a.toggleHeaderMenuItem(k),cmHelper.setSessionStorage("root.headerMenuItemToSelectOnLoad",null)}var l=null;if(a.updateItemInfoFromFriendlyUrl=function(b){if(l!=b){l=b;var c="/admin";b.substr(0,c.length)!=c&&"/"!=b&&a.currentUser.isInAnyRole(["AssistantAuthor","Author","Webmaster","ChampionManager"])&&(a.rootViewModel.itemInfo=f.getByFriendlyUrl({url:b},function(b){a.rootViewModel.adminData.itemInfo=b;var c=cmHelper.parseIdentifierStringFriendly(b.identifier);a.rootViewModel.adminData.currentPage.allowedEditRoles=b.allowedEditRoles||[],b.editBreadcrumb&&b.editBreadcrumb.length>0&&("resource-section"==c.typeFriendlyId||"internal-note-section"==c.typeFriendlyId?a.rootViewModel.adminData.currentPage.editLink=b.editBreadcrumb[b.editBreadcrumb.length-2].url:a.rootViewModel.adminData.currentPage.editLink=b.editBreadcrumb[b.editBreadcrumb.length-1].url),a.rootViewModel.adminData.currentPage.editContentLink=b.editContentBreadcrumbEntry?b.editContentBreadcrumbEntry.url:null,a.rootViewModel.adminData.currentPage.publishStatus=b.publishStatus}))}},a.$on("$locationChangeSuccess",j),a.$watch("rootViewModel.adminData.adminModal.sectionOpen",function(){cmHelper.setLocalStorage("adminModal.sectionOpen",JSON.stringify(a.rootViewModel.adminData.adminModal.sectionOpen))}),localStorage["adminModal.sectionOpen"])try{a.rootViewModel.adminData.adminModal.sectionOpen=JSON.parse(localStorage["adminModal.sectionOpen"])}catch(r){}var m=function(){var b=a.rootViewModel.mapModal.map;b&&b.setSelectedStation(a.rootViewModel.stationIdSelected)};a.$watch("rootViewModel.stationIdSelected",function(){m()}),a.refreshPage=function(){location.href=location.href};var n=function(){var b=[{name:"Public User",value:"PublicUser"},{name:"Champion Status Viewer",value:"Champion"},{name:"Academic Reviewer",value:"AcademicReviewer"},{name:"Internal Reviewer",value:"InternalReviewer"},{name:"Assistant Author",value:"AssistantAuthor"},{name:"Author",value:"Author"},{name:"Webmaster",value:"Webmaster"},{name:"Champion Team Member",value:"ChampionTeamMember"},{name:"Champion Manager",value:"ChampionManager"},{name:"Contact Manager",value:"ContactManager"},{name:"Event Manager",value:"EventManager"},{name:"Guest Blogger",value:"GuestBlogger"},{name:"Mathematical Thinking Admin",value:"MathematicalThinkingAdmin"},{name:"Mathematical Thinking Attendee",value:"MathematicalThinkingUser"}];if(a.currentUser.originalRoles&&a.currentUser.originalRoles.indexOf("Webmaster")>=0)return b;var c=[{original:"Author",allowedRoles:["PublicUser","Champion","AcademicReviewer","InternalReviewer","AssistantAuthor","Author","EventManager","ChampionTeamMember","CommentModerator","GuestBlogger","MathematicalThinkingAdmin","MathematicalThinkingUser"]},{original:"AssistantAuthor",allowedRoles:["PublicUser","Champion","AcademicReviewer","InternalReviewer","AssistantAuthor"]},{original:"ChampionManager",allowedRoles:["PublicUser","Champion","ChampionTeamMember","GuestBlogger"]},{original:"CommentModerator",allowedRoles:["PublicUser","CommentModerator"]},{original:"ContactManager",allowedRoles:["PublicUser","ContactManager"]},{original:"EventManager",allowedRoles:["PublicUser","EventManager"]},{original:"FullTimeTeamMember",allowedRoles:["PublicUser","FullTimeTeamMember"]},{original:"FeedbackManager",allowedRoles:["PublicUser","FeedbackManager"]},{original:"MathematicalThinkingAdmin",allowedRoles:["PublicUser","MathematicalThinkingUser"]}],d=[];return c.forEach(function(b){a.currentUser.originalRoles&&a.currentUser.originalRoles.indexOf(b.original)>=0&&(d=d.concat(b.allowedRoles.filter(function(a){return d.indexOf(a)<0})))}),b.filter(function(a){return d.indexOf(a.value)>=0})};a.rootViewModel.allowedUserRoles=n(),a.currentUser.originalRoles&&0!=a.currentUser.originalRoles.length?0==a.currentUser.roles.length?a.rootViewModel.newUserRole="PublicUser":JSON.stringify(a.currentUser.originalRoles)!=JSON.stringify(a.currentUser.roles)?a.rootViewModel.newUserRole=a.currentUser.roles[a.currentUser.roles.length-1]:a.rootViewModel.newUserRole=null:a.rootViewModel.newUserRole=null;var o=!1,p=function(c,e){d.switchRoles(c,function(){a.refreshPage()},function(d){if(d.data&&d.data.errorMessages&&("LoginRequired"==d.data.errorType||"PasswordLogin"!=a.currentUser.origin&&"AccessDenied"==d.data.errorType))return void g.confirmLogin(function(){p(c)},function(){o=!0,a.rootViewModel.newUserRole=e,b(function(){o=!1})});o=!0,a.rootViewModel.newUserRole=e,b(function(){o=!1})})};if(a.$watch("rootViewModel.newUserRole",function(b,c){if(c!=b&&!o){var d=a.rootViewModel.newUserRole?[a.rootViewModel.newUserRole]:[];p(d,c)}}),a.rootViewModel.publishStatuses=c.query(),a.getPublishStatusText=function(b){var c=a.rootViewModel.publishStatuses.filter(function(a){return a.value==b});return c.length>0?c[0].name:null},a.getPublishStatusIconClass=function(a){return"Public"==a?null:"icon-forbidden"},a.$watch("rootViewModel.adminData.showTools",function(){cmHelper.setLocalStorage("adminData.showTools",JSON.stringify(a.rootViewModel.adminData.showTools))}),localStorage["adminData.showTools"])try{a.rootViewModel.adminData.showTools=JSON.parse(localStorage["adminData.showTools"])}catch(r){}null==a.rootViewModel.adminData.showTools&&(a.rootViewModel.adminData.showTools=!0),a.bookmarkManager=new e(a.currentUser.userId),a.sendPrintableAnalytics=function(a){if(a){var b=a;"/"!=a.substr(0,1)&&a.indexOf("//")<0&&(b=location.pathname&&"/"==location.pathname.substr(location.pathname.length-1,1)?location.pathname+a:location.pathname+"/"+a),"function"==typeof ga&&ga("send","event","Printables","download",b)}};var q=null;if(localStorage["root.analyticsUserType"])try{q=JSON.parse(localStorage["root.analyticsUserType"])}catch(r){}q||(q="NeverLoggedIn"),a.currentUser&&a.currentUser.isInAnyRole(["AcademicReviewer","InternalReviewer","AssistantAuthor","Author","Webmaster","FullTimeTeamMember","CommentModerator"])?q="TeamMember":a.currentUser&&a.currentUser.isLoggedIn()&&(q="HasLoggedInPublicUser"),cmHelper.setLocalStorage("root.analyticsUserType",JSON.stringify(q)),document.addEventListener("play",function(a){a.target&&a.target.tagName&&"video"==a.target.tagName.toLowerCase()&&"function"==typeof ga&&ga("send","event","Video","play",$(a.target).find("source").attr("src"))},!0),"function"==typeof ga&&(ga("set","dimension1",q),ga("send","pageview"))}]),a.directive("cmClickEnter",function(){return function(a,b,c){b.on("keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.cmClickEnter)}),b.preventDefault())}),b.on("click",function(b){a.$apply(function(){a.$eval(c.cmClickEnter)})})}}),a.directive("cmBreadcrumb",[function(){return{link:function(a,b,c){a.$watchCollection("breadcrumb",function(){if(a.breadcrumb&&a.breadcrumb.length){b.empty();var c=$("<ul></ul>").appendTo(b);a.breadcrumb.forEach(function(a){var b=$("<li></li>").appendTo(c),d=$("<a></a>").appendTo(b);d.attr("href",a.url).text(a.text),a.icon&&d.prepend('<span class="icon-'+a.icon+'"></span>')})}})},scope:{breadcrumb:"=cmBreadcrumb"}}}]),a.directive("cmPlay",function(){return function(a,b,c){b.on("play",function(b){a.$apply(function(){a.$eval(c.cmPlay)})})}}),a.directive("cmPause",function(){return function(a,b,c){b.on("pause",function(b){a.$apply(function(){a.$eval(c.cmPause)})})}})}();var cmElementsHelper={};!function(){cmElementsHelper.addCustomVideoControls=function(a,b,c){var d=$(a);if(0!=d.length&&!d.data("custom-controls")){b&&d.on("contextmenu",function(a){a.preventDefault()});var e=d.parent();if(0!=e.length){d.data("custom-controls",!0),"absolute"!=e.css("position")&&e.css("position","relative");if(document.createElement("video").canPlayType){var f=$('<ul class="cm-video-controls"></ul>'),g=$('<a tabindex="0" data-cm-paused="true"><span class="sr-only">Play/Pause</span></a>');$('<li class="cm-video-play-pause"></li>').append(g).appendTo(f);var h=$('<div class="cm-video-progress-bar"></div>'),i=$('<div class="cm-video-progress-bar-inner"></div>').appendTo(h),j=$("<span></span>").appendTo(i);$('<li class="cm-video-progress"></li>').append(h).appendTo(f);var k=$('<a tabindex="0" data-cm-muted="false"><span class="sr-only">Mute/unmute</span></a>');$('<li class="cm-video-mute"></li>').append(k).appendTo(f);var l=$('<div class="cm-video-progress-bar"></div>'),m=$('<div class="cm-video-progress-bar-inner"></div>').appendTo(l),n=$("<span></span>").appendTo(m);$('<li class="cm-video-volume-progress"></li>').append(l).appendTo(f);var o=$('<a tabindex="0"><span class="sr-only">Fullscreen</span></a>');$('<li class="cm-video-fullscreen"></li>').append(o).appendTo(f),d[0].controls=!1,g.on("click",function(a){d[0].paused||d[0].ended?d[0].play():d[0].pause()}),d.on("play",function(){g.attr("data-cm-paused",!1)}),d.on("pause",function(){g.attr("data-cm-paused",!0)}),d.on("loadedmetadata",function(){var a=null==d[0].volume?1:d[0].volume;n.css("width",Math.floor(100*a)+"%")}),d.on("timeupdate",function(){j.css("width",Math.floor(d[0].currentTime/d[0].duration*100)+"%")}),h.on("click",function(a){if(d[0].duration){var b=(a.pageX-i.offset().left)/i.width();b<0&&(b=0),b>1&&(b=1),d[0].currentTime=b*d[0].duration}}),k.on("click",function(a){d[0].muted?(d[0].muted=!1,k.attr("data-cm-muted",!1)):(d[0].muted=!0,k.attr("data-cm-muted",!0))}),l.on("click",function(a){var b=(a.pageX-m.offset().left)/m.width(),c=b;c>1&&(c=1),c<0&&(c=0),d[0].volume=c,n.css("width",Math.floor(100*d[0].volume)+"%"),d[0].muted&&(d[0].muted=!1,k.attr("data-cm-muted",!1))});!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitSupportsFullscreen||document.webkitFullscreenEnabled||document.createElement("video").webkitRequestFullScreen)||o.hide(),o.on("click",function(a){p()});var p=function(){if(q())document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),r(!1),b||c?(e.removeClass("fullscreen"),e.removeClass("video-container-fullscreen")):(f.show(),d[0].controls=!1);else{var g=d[0];b&&(g=e[0]),g.requestFullscreen?g.requestFullscreen():g.mozRequestFullScreen?g.mozRequestFullScreen():g.webkitRequestFullScreen?g.webkitRequestFullScreen():g.msRequestFullscreen&&g.msRequestFullscreen(),r(!0),b||c?(e.addClass("fullscreen"),e.addClass("video-container-fullscreen")):(f.hide(),d[0].controls=!0),cmElementsHelper.resizeCustomVideoControls(a)}},q=function(){return!!(document.fullScreen||document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},r=function(a){e.attr("data-fullscreen",a)};$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange msfullscreenchange",function(g){q()||(r(!1),b||c?(e.removeClass("fullscreen"),e.removeClass("video-container-fullscreen")):(f.show(),d[0].controls=!1),cmElementsHelper.resizeCustomVideoControls(a))}),e.append(f),cmElementsHelper.resizeCustomVideoControls(a)}}}},cmElementsHelper.resizeCustomVideoControls=function(a){var b=$(a),c=b.parent();if(0!=b.length&&b.data("custom-controls")&&0!=c.length){var d=c.find("ul.cm-video-controls");if(0!=d.length){var e=b.offset().left-c.offset().left,f=b.outerWidth();d.css("left",e+"px").css("right","auto").css("width",f+"px")}}}}(),function(){var a=angular.module("cmElements",["cmApi","cmAuth"]);a.controller("HelpItemModalController",["$scope","$element","$timeout","$sce","HelpItem","Content","Auth",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,a.viewModel.helpItem=e.get({id:a.viewModel.helpItemFriendlyId},function(){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("help-item",a.viewModel.helpItem.id)},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})})}),a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack()}]),$(document).on("click","[data-cm-help-item-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-help-item-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/help-item-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={helpItemFriendlyId:c,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(b)(f),d.setContent(b[0])}])})}}),$(document).on("click","[data-cm-new-tab-links] a",function(a){$(this).attr("target","_blank")}),a.controller("TeacherSupportModalController",["$scope","$element","$timeout","$sce","TeacherSupport","Content","Auth",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,a.viewModel.title=null,a.viewModel.newTabUrl=null,a.viewModel.printableUrl=null;var h=function(){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("teacher-support",a.viewModel.teacherSupport.id)},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})});var e=cmHelper.parseIdentifierStringFriendly(a.viewModel.teacherSupport.owner);"station"==e.typeFriendlyId?(a.viewModel.title="Station guide",a.viewModel.newTabUrl="/"+a.viewModel.teacherSupportOwnerFriendlyRef.split("_").join("/")+"/station-guide",a.viewModel.printableUrl="/"+a.viewModel.teacherSupportOwnerFriendlyRef.split("_").join("/")+"/download/station-guide.pdf","function"==typeof ga&&ga("send","pageview",a.viewModel.newTabUrl)):"resource"==e.typeFriendlyId?(a.viewModel.title="Teacher notes",a.viewModel.newTabUrl="/"+a.viewModel.teacherSupportOwnerFriendlyRef.split("_").join("/")+"/teacher-notes",a.viewModel.printableUrl="/"+a.viewModel.teacherSupportOwnerFriendlyRef.split("_").join("/")+"/download/teacher-notes.pdf","function"==typeof ga&&ga("send","pageview",a.viewModel.newTabUrl)):a.viewModel.title="Teacher notes"};a.viewModel.teacherSupportOwnerFriendlyRef?a.viewModel.teacherSupport=e.get({id:a.viewModel.teacherSupportOwnerFriendlyRef},h):a.viewModel.teacherSupport=e.queryOwner({identifier:a.viewModel.teacherSupportOwner},h),a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack(),a.viewModel.modal.on("hidden",function(){"function"==typeof ga&&ga("send","pageview",location.pathname+location.search)})}]),$(document).on("click","[data-cm-teacher-support-toggle], [data-cm-teacher-support-owner-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-teacher-support-toggle"),d=$(this).attr("data-cm-teacher-support-owner-toggle");if(c||d){var e=new CmModal;e.setContentLoading(),CmModal.hideContainingModal(this,!0),e.show(),$(this).data("cm-modal",e),$.get("/static/spa-templates/teacher-support-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,f){var g=a.$new();g.viewModel={teacherSupportOwnerFriendlyRef:c,teacherSupportOwner:d,modal:e},e.on("shown",function(){g.viewModel.updateCanGoBack&&g.viewModel.updateCanGoBack()}),f(b)(g),e.setContent(b[0])}])})}}}),a.controller("PervasiveIdeaModalController",["$scope","$element","$timeout","$sce","PervasiveIdea","Content","Auth",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,a.viewModel.printableUrl="/pervasive-ideas/"+a.viewModel.pervasiveIdeaFriendlyId+"/download/"+a.viewModel.pervasiveIdeaFriendlyId+".pdf",a.viewModel.pervasiveIdea=e.get({id:a.viewModel.pervasiveIdeaFriendlyId},function(){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("pervasive-idea",a.viewModel.pervasiveIdea.id)},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})})}),a.doSearch=function(){a.viewModel.pervasiveIdea.title&&(a.viewModel.modal.hide(),a.search(a.viewModel.pervasiveIdea.title.toLowerCase()))},a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack(),"function"==typeof ga&&ga("send","pageview","/pervasive-ideas/"+a.viewModel.pervasiveIdeaFriendlyId),a.viewModel.modal.on("hidden",function(){"function"==typeof ga&&ga("send","pageview",location.pathname+location.search)});new PervasiveIdeasWheel($(b[0]).find("[data-cm-pervasive-ideas-wheel]")[0])}]),$(document).on("click","[data-cm-pervasive-idea-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-pervasive-idea-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/pervasive-idea-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={pervasiveIdeaFriendlyId:c,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(b)(f),d.setContent(b[0])}])})}}),a.controller("TagModalController",["$scope","$element","$timeout","$sce","Tag","Content","Auth",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,a.viewModel.tag=e.get({id:a.viewModel.tagFriendlyId},function(){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("tag",a.viewModel.tag.id)},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})})}),a.doSearch=function(){a.viewModel.tag.title&&(a.viewModel.modal.hide(),a.search(a.viewModel.tag.title.toLowerCase()))},a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack(),"function"==typeof ga&&ga("send","pageview","/tags/"+a.viewModel.tagFriendlyId),a.viewModel.modal.on("hidden",function(){"function"==typeof ga&&ga("send","pageview",location.pathname+location.search)})}]),$(document).on("click","[data-cm-tag-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-tag-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/tag-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={tagFriendlyId:c,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(b)(f),d.setContent(b[0])}])})}}),a.controller("PervasiveIdeaExplanationModalController",["$scope","$element","$timeout","$sce","Auth",function(a,b,c,d,e){a.viewModel=a.viewModel||{},a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack(),"function"==typeof ga&&ga("send","pageview","/pervasive-ideas-explanation"),a.viewModel.modal.on("hidden",function(){"function"==typeof ga&&ga("send","pageview",location.pathname+location.search)});new PervasiveIdeasWheel($(b[0]).find("[data-cm-pervasive-ideas-wheel]")[0])}]),$(document).on("click","[data-cm-pervasive-idea-explanation-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=new CmModal;c.setContentLoading(),CmModal.hideContainingModal(this,!0),c.show(),$(this).data("cm-modal",c),$.get("/static/spa-templates/pervasive-idea-explanation-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,d){var e=a.$new();e.viewModel={modal:c},c.on("shown",function(){e.viewModel.updateCanGoBack&&e.viewModel.updateCanGoBack()}),d(b)(e),c.setContent(b[0])}])})}}),a.controller("GlossaryModalController",["$scope","$element","$timeout","$sce","Glossary","Content","Auth",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,a.viewModel.printableUrl="/glossary/"+a.viewModel.glossaryFriendlyId+"/download/"+a.viewModel.glossaryFriendlyId+".pdf",a.viewModel.glossary=e.get({id:a.viewModel.glossaryFriendlyId},function(){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("glossary",a.viewModel.glossary.id)},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})})}),a.viewModel.updateCanGoBack=function(){c(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack(),"function"==typeof ga&&ga("send","pageview","/glossary/"+a.viewModel.glossaryFriendlyId),a.viewModel.modal.on("hidden",function(){"function"==typeof ga&&ga("send","pageview",location.pathname+location.search)})}]),$(document).on("click","[data-cm-glossary-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-glossary-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/glossary-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){
var f=a.$new();f.viewModel={glossaryFriendlyId:c,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(b)(f),d.setContent(b[0])}])})}}),a.controller("ContentModalController",["$scope","$element","$timeout","$sce","Content","Auth",function(a,b,c,d,e,f){a.viewModel=a.viewModel||{},a.viewModel.convertedContent=null,e.getConverted({identifier:a.viewModel.owner},function(e){a.viewModel.convertedContent=d.trustAsHtml(e.content),c(function(){cmSite.processContent(b[0])})}),a.viewModel.newTabUrl=null,a.currentUser.isInAnyRole(["AssistantAuthor","Author","Webmaster"])&&(a.viewModel.newTabUrl="/admin/view-content/"+a.viewModel.owner)}]),$(document).on("click","[data-cm-content-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void b.show();b.remove()}var c=$(this).attr("data-cm-content-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/content-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={owner:c,modal:d},e(b)(f),d.setContent(b[0])}])})}}),$(document).on("click","[data-cm-map-toggle]",function(a){a.preventDefault(),$(this).hasClass("disabled")||$(this).closest(".fade-out").length>0||angular.element(document).injector().invoke(["$rootScope",function(b){b.toggleHeaderMenuItem&&(CmModal.hideContainingModal(a.target,!0),b.toggleHeaderMenuItem("Map"))}])}),$(document).on("click","[data-cm-search-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).attr("data-cm-search-toggle");angular.element(document).injector().invoke(["$rootScope",function(c){c.search&&(CmModal.hideContainingModal(a.target,!0),c.search(b))}])}}),$(document).on("click","[data-cm-browse-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=null;try{b=JSON.parse($(this).attr("data-cm-browse-toggle"))}catch(c){}angular.element(document).injector().invoke(["$rootScope",function(c){c.browse&&(CmModal.hideContainingModal(a.target,!0),c.browse(b||{}))}])}}),$(document).on("click","[data-cm-prompt-register-toggle]",function(a){a.preventDefault(),$(this).hasClass("disabled")||$(this).closest(".fade-out").length>0||angular.element(document).injector().invoke(["$rootScope",function(b){b.promptRegister&&(CmModal.hideContainingModal(a.target,!0),b.promptRegister())}])}),$(document).on("click","[data-cm-prompt-login-toggle]",function(a){a.preventDefault(),$(this).hasClass("disabled")||$(this).closest(".fade-out").length>0||angular.element(document).injector().invoke(["$rootScope",function(b){b.promptLogin&&(CmModal.hideContainingModal(a.target,!0),b.promptLogin())}])}),$(document).on("click","[data-cm-commented-item-link]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).attr("data-cm-commented-item-link");b&&(cmHelper.setSessionStorage("root.headerMenuItemToSelectOnLoad",JSON.stringify("Comments")),location.href=b)}}),$(document).ready(function(){var a=!1;MathJax.Hub.Register.MessageHook("Math Processing Error",function(b){if(!a){var c=null;if(sessionStorage["mathjax.shownErrorMessageDate"])try{c=JSON.parse(sessionStorage["mathjax.shownErrorMessageDate"])}catch(e){}var d=(new Date).getTime();if(c&&c>d-36e5)return;a=!0,cmHelper.setSessionStorage("mathjax.shownErrorMessageDate",JSON.stringify(d)),CmModal.showConfirmYesFirst("Error processing mathematics","<p>There was an error processing some of the mathematics on this page. This is sometimes fixed by reloading the page. If this does not fix the problem, please contact the webmaster.</p> <p>Would you like to reload the page?</p>",function(){location.reload(!0)})}}),cmSite.processContent()}),$(document).on("click","[data-cm-content] a",function(a){var b=$(this),c=b.attr("href");if(c&&"#"==c.substr(0,1)){a.preventDefault();var d=b.closest("[data-cm-content]").find('[data-cm-name="'+c.substr(1)+'"], '+c);0!=d.length&&d[0].scrollIntoView(!0)}}),$(document).on("click",'[data-cm-element="toggle"]',function(a){var b=$(this),c=this;if(!b.data("cm-loaded")){var d=b.children('[data-cm-element="toggle-button"]'),e=b.children('[data-cm-element="toggle-content"]'),f=!1,g=function(){b.toggleClass("open"),e.toggle({complete:function(){f||(b.hasClass("open")&&(e.find('[data-cm-element="geogebra"] iframe').each(function(){$(this).attr("src",$(this).attr("src"))}),f=!0),cmSite.updateContentLayout(c))}})};d.click(g),a.target&&$(a.target).closest(d).length>0&&g(),b.data("cm-loaded",!0)}}),$(document).on("click",'[data-cm-element="hint-answer"]',function(a){var b=$(this);if(!b.data("cm-loaded")){var c=b.children('[data-cm-element="hint"]'),d=b.children('[data-cm-element="answer"]'),e=b.children('[data-cm-element="hint-answer-buttons"]').children('[data-cm-element="hint-toggle"]'),f=b.children('[data-cm-element="hint-answer-buttons"]').children('[data-cm-element="answer-toggle"]');e.click(function(){c.toggle({}),b.toggleClass("hint-open")}),f.click(function(){d.toggle({}),b.toggleClass("answer-open")}),a.target&&$(a.target).closest(e).length>0&&(c.toggle({}),b.toggleClass("hint-open")),a.target&&$(a.target).closest(f).length>0&&(d.toggle({}),b.toggleClass("answer-open")),b.data("cm-loaded",!0)}});var b=function(a){if(!a)return null;var c=a.closest("li");if(0==c.length)return null;var d=c.find("[data-cm-dropdown]"),e=!1;return d.each(function(){if($(this).closest("li").is(c))return e=!0,!1}),e?c:b(c.parent())};$(document).on("click","[data-cm-dropdown]",function(){if(!$(this).data("cm-loaded")){var a=$(this).closest("li");$("body").on("mousedown touchstart",function(b){$(b.target).closest(a).length>0||a.removeClass("open")}),a.on("click","[data-cm-dismiss-dropdown]",function(c){if("all"!=$(this).attr("data-cm-dismiss-dropdown")){var d=b($(this));if(!d||!a.is(d))return}a.removeClass("open")}),$(this).click(function(){a.toggleClass("open")}),a.addClass("open"),$(this).data("cm-loaded",!0)}}),$(document).on("click",'input[type="number"]',function(){$(this).focus()}),a.directive("cmHowToHighlightToggle",["$timeout",function(a){return{link:function(b,c,d){if(b.viewModel){var e=d.cmHowToHighlightToggle,f=function(){a(function(){})};b.$watch("viewModel.howToItemHighlighted",function(){b.viewModel.howToItemHighlighted==e?c.addClass("active"):c.removeClass("active")}),$(document).click(function(a){b.viewModel.howToItemHighlighted&&(a.target&&$(a.target).closest("[data-cm-how-to-highlight-toggle]").length>0||(b.viewModel.howToItemHighlighted=null,f()))}),c.click(function(){if(b.viewModel.howToItemHighlighted==e)return b.viewModel.howToItemHighlighted=null,void f();b.viewModel.howToItemHighlighted=e,f()}),c.on("mouseenter",function(){b.viewModel.howToItemHighlightedTemp=e,f()}),c.on("mouseleave",function(){b.viewModel.howToItemHighlightedTemp=null,f()})}}}}]),$(document).on("click",'td[data-cm-click-highlight="true"], th[data-cm-click-highlight="true"]',function(a){var b=$(this);if(!b.data("cm-click-highlight-loaded")){var c=function(){b.toggleClass("click-highlighted")};b.click(c),c(),b.data("cm-click-highlight-loaded",!0)}}),$(document).on("mousedown touchstart",'td[data-cm-editable="true"], th[data-cm-editable="true"]',function(a){var b=$(this),c=this;if(!b.data("cm-editable-loaded")){c.contentEditable=!0;var d=function(){b.data("cm-content",b.html()),cmSite.processContent(c)};b.on("blur",d),b.on("focus",function(){b.html(b.data("cm-content"))}),b.data("cm-editable-loaded",!0)}})}(),function(){var a=angular.module("cmHelpSectionToggle",["cmApi","cmAuth"]);a.controller("HelpSectionController",["$scope","$timeout","$element","HelpSection","HelpItem","Content",function(a,b,c,d,e,f){if(a.viewModel=a.viewModel||{},!a.viewModel.helpSectionFriendlyId){var g=cmHelper.getUrlParameters("/help",["friendlyId"]);a.viewModel.helpSectionFriendlyId=g.friendlyId}a.viewModel.helpItems=[],a.viewModel.childSections=[],a.viewModel.helpHierarchy=[],a.viewModel.newTabUrl="/help/"+a.viewModel.helpSectionFriendlyId;var h=function(){0!=a.viewModel.helpHierarchy.length&&a.viewModel.helpHierarchy[0].parentId&&d.get({id:a.viewModel.helpHierarchy[0].parentId},function(b){a.viewModel.helpHierarchy.unshift(b),h()})};a.viewModel.helpSectionFriendlyId&&d.get({id:a.viewModel.helpSectionFriendlyId},function(g){a.helpSection=g,a.viewModel.helpHierarchy.unshift(g),h(),a.viewModel.childSections=d.queryHelpSection({helpSectionId:g.id}),a.viewModel.helpItems=e.queryHelpSection({helpSectionId:g.id},function(){a.viewModel.helpItems.forEach(function(a){f.getConverted({identifier:cmHelper.getIdentifierStringFriendly("help-item",a.id)},function(d){a.content=d.content,b(function(){cmSite.processContent(c[0])})})})})}),a.viewModel.updateCanGoBack=function(){b(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack()}]),$(document).on("click","[data-cm-help-section-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).attr("data-cm-help-section-toggle");if(!CmModal.getContainingModal(this)&&cmHelper.getUrlParameters("/help",["friendlyId"]).friendlyId)return void(location.href="/help/"+b);var c=$(this).data("cm-modal");if(c){if(void 0===$(this).attr("data-cm-recreate")||!1===$(this).attr("data-cm-recreate"))return CmModal.hideContainingModal(this,!0),void c.show();c.remove()}var d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/help-section-modal.html",function(a){var c=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={helpSectionFriendlyId:b,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(c)(f),d.setContent(c[0])}])})}}),a.directive("cmHelpContent",["$rootScope","$compile","$http",function(a,b,c){return{link:function(a,b,c){a.$watch("helpContent",function(){var c=a.helpContent||"",d=$("<div></div>").html(c);b.empty(),b.append(d)})},scope:{helpContent:"=?cmHelpContent"}}}])}();var cmHelper={};!function(){cmHelper.compareInsensitiveAlphaNumeric=function(a,b){if(!a)return b?-1:0;if(!b)return 1;var c=a.toLowerCase(),d=b.toLowerCase(),e=/^\d+/.exec(c);if(e){var f=Number(e[0]),g=c.substr(e.length),h=/^\d+/.exec(d);if(h){var i=Number(h[0]),j=d.substr(h.length);return f==i?this.compareInsensitiveAlphaNumeric(g,j):f>i?1:-1}}return c.substr(0,1)==d.substr(0,1)?this.compareInsensitiveAlphaNumeric(c.substr(1),d.substr(1)):c.substr(0,1)>d.substr(0,1)?1:-1},cmHelper.templateBaseUrl="/static/spa-templates",cmHelper.scriptBaseUrl="/static/js",cmHelper.getUrlParameters=function(a,b){var c=a;"/"!=c.substr(c.length-1,1)&&(c+="/");var d=location.pathname,e=new RegExp("^"+c);if(!e.test(d))return{};for(var f=d.replace(e,""),g=f.split("/"),h={},i=0;i<g.length&&i<b.length;i++)h[b[i]]=decodeURIComponent(g[i]);return h},cmHelper.getQueryStringParameters=function(){var a=location.search;if(!a)return{};a=a.substr(1);var b=a.split("&"),c={};return b.forEach(function(a){var b=a.split("="),d=b.shift();d&&(c[d]=decodeURIComponent(b.join("=")))}),c},cmHelper.parseIdentifierStringFriendly=function(a){if(!a)return null;var b=a.split("-");if(b.length<2)return null;var c=Number(b[b.length-1]);return isNaN(c)?null:{typeFriendlyId:b.slice(0,b.length-1).join("-"),id:c}},cmHelper.getIdentifierStringFriendly=function(a,b){return a+"-"+b.toString()},cmHelper.getFriendlyIdentifierText=function(a){return a?a.split("_").reverse().join(", "):""},cmHelper.getFriendlyIdentifierFromText=function(a){return a?a.split(", ").reverse().join("_"):null},cmHelper.parseDate=function(a){if(!a)return null;if(a.getTime)return a;var b=a.trim(),c=b.split("/");if(3==c.length){var d=Number(c[0]),e=Number(c[1]),f=Number(c[2]);return f<100&&(f+=f<71?2e3:1900),isNaN(d)||isNaN(e)||isNaN(f)?null:new Date(f,e-1,d)}},cmHelper.parseTime=function(a){if(!a)return null;var b=a.trim(),c=b.split(":");if(!(c.length<2)){var d=Number(c[0]),e=Number(c[1]),f=c.length>=3?Number(c[2]):0;return isNaN(d)||isNaN(e)||isNaN(f)?null:60*d*60+60*e+f}},cmHelper.parseDateTime=function(a){if(!a)return null;if(a.getTime)return a;var b=a.trim(),c=b.split(" ");if(!(c.length>2)){var d=cmHelper.parseDate(c[0]);if(!d)return null;var e=0;return c.length>=2&&(null==(e=cmHelper.parseTime(c[1]))||void 0==e)?null:(d.setSeconds(e),d)}},cmHelper.parseISODate=function(a){if(!a)return null;if(a.getTime)return a;var b=null;try{b=new Date(a)}catch(c){b=null}return b},cmHelper.stripLatexDollars=function(a){if(!a)return a;var b=a.split("$"),c="",d=!1,e=0,f=!1;return b.forEach(function(a){var g=0==e?"":e==b.length-1&&d?"$":f?"$":"";"\\"==a.substr(a.length-1)?(c+=g+a.substr(0,a.length-1),e++,f=!0):(c+=g+a,d=!d,e++,f=!1)}),c},cmHelper.getRestrictedAccessWarningText=function(a){switch(a){case"Public":return"";case"ChampionReview":return"This item is not ready for public viewing. It is for champion review only.";case"AcademicReview":return"This item is not ready for public viewing. It is for academic review only.";case"AuthorReview":return"This item is not ready for public viewing. It is for author review only.";case"Unpublished":return"This item is not ready for public viewing. It is unpublished.";case"Dropped":return"This item has been dropped.";default:return"This item is not ready for public viewing."}},cmHelper.getUnderConstructionWarningText=function(a){switch(a){case"CmItemResource":return"Resources under construction may not yet have been fully reviewed.";default:return"This item is under construction."}},cmHelper.getResourceRefText=function(a){return"R"+a},cmHelper.getResourceRefTextFriendly=function(a){return cmHelper.getResourceRefText(a).toLowerCase()},cmHelper.isExternalUrl=function(a){return!!a&&a.indexOf("//")>=0},cmHelper.isAbsoluteUrl=function(a){return!!a&&(cmHelper.isExternalUrl(a)||"/"==a.substr(0,1))},cmHelper.setLocalStorage=function(a,b){var c=!1;try{localStorage[a]=b,c=!0}catch(d){}return c},cmHelper.setSessionStorage=function(a,b){var c=!1;try{sessionStorage[a]=b,c=!0}catch(d){}return c},cmHelper.scrollToSection=function(a){var b=$("#"+a);0!=b.length&&$("html, body").animate({scrollTop:b.offset().top},300)},cmHelper.autoFormatQuotes=function(a,b){if(!a)return a;var c;if(b){if("'"!=a[a.length-1])return a;c=[a,""]}else c=a.split("'");var d="";return c.forEach(function(a,b){var e="'";b>=c.length-1?e="":a.match(/\s+$/)||!a?e="":a.match(/\s+$/)||(e=""),d+=a+e}),d},cmHelper.textToHtml=function(a){return a?$("<div></div>").text(a).html():""},cmHelper.convertMarkdownToHtml=function(a){if(!a)return a||"";if(!window.markdownit)return a;var b=window.markdownit(),c=cmHelper.textToHtml(a);try{c=b.render(a)}catch(d){}return c},cmHelper.convertMarkdownLineToHtml=function(a){if(!a)return a||"";if(!window.markdownit)return a;var b=window.markdownit(),c=cmHelper.textToHtml(a);try{c=b.renderInline(a)}catch(d){}return c},cmHelper.convertMarkdownToText=function(a){if(!a)return a||"";if(!window.markdownit)return a;var b=window.markdownit(),c=cmHelper.textToHtml(a);try{c=b.render(a)}catch(e){}var d=$("<div></div>");return d.html(c),d.text()}}(),function(){var a=function(){};a.iframesManaged=[],a.positionResponsiveIframesOnLoad=function(){$('[data-cm-element="iframe"][data-cm-responsive="true"] > iframe').on("load",function(){var b=this;setTimeout(function(){a.positionResponsiveIframe(b)},1)})},a.positionResponsiveIframes=function(){$('[data-cm-element="iframe"][data-cm-responsive="true"] > iframe').each(function(){a.positionResponsiveIframe(this)})},a.positionResponsiveIframe=function(b){if(b&&b.contentWindow&&b.contentWindow.document&&b.contentWindow.document.body){var c=b.contentWindow.document.body.offsetHeight+5;$(b).css("height",c+"px"),a.iframesManaged.indexOf(b)<0&&(a.iframesManaged.push(b),b.contentWindow.addEventListener("cmLayoutChanged",function(){a.positionResponsiveIframe(b)}))}},$(window).on("resize",function(){a.positionResponsiveIframes()}),window.CmIframe=a}(),function(){var a=angular.module("cmLoginRegisterModal",["cmApi","cmAuth"]);a.controller("LoginRegisterModalController",["$scope","$element","$timeout","UserAccount","Auth",function(a,b,c,d,e){a.viewModel=a.viewModel||{},a.loginRegisterViewModel=a.viewModel,a.viewModel.newOrExisting=a.viewModel.newOrExisting||"Existing",a.viewModel.focusUsernameText=function(){b.find('[name="username"]').focus()}}]),a.controller("LoginModalController",["$scope","$element","Auth","UserAccount",function(a,b,c,d){a.viewModel={},a.viewModel.loginFormTemplate=cmHelper.templateBaseUrl+"/account/login-form.html",a.userLogin={},a.viewModel.errors=[],a.clearErrors=function(){a.viewModel.errors=[]},a.logIn=function(){a.clearErrors(),a.viewModel.loginForm.$valid&&d.logIn(a.userLogin,function(d){c.setCurrentUser(d);var e=a.loginRegisterViewModel.loginAction;if(CmModal.hideContainingModal(b),a.currentUser.passwordExpiryImminent())CmModal.showMultiOptionModal("Warning",'Your password will expire soon. Please change it <a href="/user/edit">here</a> as soon as possible.',[{label:"Close",buttonClass:"cm-button-cancel",callback:a.refreshPage}],a.refreshPage);else if("/user"==location.pathname)location.href="/user";else if("/user/login"==location.pathname){var f=cmHelper.getQueryStringParameters();!f.requestedUrl||"/"!=f.requestedUrl.substr(0,1)&&f.requestedUrl!=location.origin&&f.requestedUrl.substr(0,location.origin.length+1)!=location.origin+"/"?location.href="/user":location.href=f.requestedUrl}else e&&cmHelper.setSessionStorage("root.loadAction",JSON.stringify(e)),location.href=location.href},function(b){b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to log in."],a.viewModel.loginForm.$setPristine(),a.viewModel.loginForm.$setUntouched(),a.userLogin.password=null})}}]),a.controller("RegisterModalController",["$scope","$element","Auth","User","UserAccount","UserType",function(a,b,c,d,e,f){a.viewModel={},a.viewModel.registerFormTemplate=cmHelper.templateBaseUrl+"/account/register-form.html",a.viewModel.userTypes=f.query(),a.user=new d,a.user.receiveNewsletter=!1,a.viewModel.errors=[],a.viewModel.savingRegistration=!1;var g=function(){var a=Math.floor(10*Math.random()+1),b=Math.floor(10*Math.random()+1),c=Math.floor(3*Math.random()),d="Plus";return 1==c?d="Times":2==c&&(d="Minus"),{num1:a,num2:b,type:d}};a.user.antiSpamQuestion=g(),a.getAntiSpamQuestionText=function(a){return a?a.num1.toString()+" "+a.type.toLowerCase()+" "+a.num2.toString()+" is":""},a.clearErrors=function(){a.viewModel.errors=[]},a.onSchoolSelect=function(b){a.user.school=b.value},a.register=function(){a.clearErrors(),a.viewModel.registerForm.$valid&&!a.viewModel.savingRegistration&&(a.viewModel.savingRegistration=!0,a.user.createdDate=new Date,a.user.$save(function(){CmModal.hideContainingModal(b),e.logIn({username:a.user.username,password:a.user.newPassword},function(b){a.viewModel.savingRegistration=!1,c.setCurrentUser(b.userIdentity),location.href="/user?message=AccountCreated"},function(){a.viewModel.savingRegistration=!1})},function(b){a.viewModel.savingRegistration=!1,b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to create the user account."]}))}}]);var b=function(){var a=this;a.modal=new CmModal({blockHeaderMenu:!1}),a.loginRegisterViewModel={},$.get("/static/spa-templates/cm-login-register-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,d){var e=b.$new();e.viewModel=a.loginRegisterViewModel,d(c)(e),a.modal.setContent(c[0])}])}),a.modal.on("hidden",function(){a.loginRegisterViewModel.loginAction=null})};b.prototype.setNewOrExisting=function(a){this.loginRegisterViewModel.newOrExisting=a},b.prototype.setLoginAction=function(a){this.loginRegisterViewModel.loginAction=a},b.prototype.show=function(){var a=this;a.modal.show(),a.loginRegisterViewModel.focusUsernameText&&a.loginRegisterViewModel.focusUsernameText()},b.prototype.hide=function(){this.modal.hide()},window.CmLoginRegisterModal=b}(),function(){var a=function(){var a=this;a.modal=new CmModal({blockHeaderMenu:!1}),a.mapContainer=$("<div></div>").addClass("cm-map-modal"),a.closeButton=$('<a tabindex="0" data-cm-modal-dismiss="" class="cm-modal-close-button"></a>').appendTo(a.mapContainer),a.closeButton.append('<span class="icon-cross"></span>').append('<span class="sr-only">Close</span>'),a.map=new Map(a.mapContainer),a.map.setZoomEnabled(!0),a.modal.setContent(a.mapContainer),$(window).resize(function(){a.resizeMapContainer(),a.map.updateLayout()}),a.modal.on("hidden",function(){a.map.reset()}),a.modal.on("shown",function(){a.resizeMapContainer(),a.map.updateLayout()})};a.prototype.show=function(){this.modal.show()},a.prototype.hide=function(){this.modal.hide()},a.prototype.setSelectedLine=function(a){this.map.setSelectedLine(a)},a.prototype.resizeMapContainer=function(){var a=this,b=(a.modal.container.height(),a.modal.container.width()),c=a.map.getNativeDimensions(),d=c.width/c.height,e=0,f=0,g=50;b<600&&(g=20),b<400&&(g=10),f=b-2*g,f>800&&(f=800),e=f/d,e<300&&(e=300),a.mapContainer.css("height",e+"px").css("width",f+"px")},window.CmMapModal=a}(),function(){var a=function(a){var b=this;b.outerContainer=null,b.defaultOptions={content:null,closeOnClickOutside:!0,hideParent:!0,blockHeaderMenu:!0,addToHistory:!0},b.options=$.extend({},b.defaultOptions,a),b.handlers=[],b.mousedownTarget=null,b.container=$('<div data-cm-modal="" class="cm-modal-container"></div>').hide(),b.options.blockHeaderMenu||b.container.addClass("cm-modal-below-header"),b.container.data("cm-modal",b),b.container.on("mouseup touchend",function(a){b.mousedownTarget&&(b.mousedownTarget&&$(b.mousedownTarget).closest(b.contentElement).length>0||!b.options.closeOnClickOutside||b.contentElement&&$(a.target).closest(b.contentElement).length>0||0==$(a.target).closest("body").length||(a.preventDefault(),b.hide()))}),b.container.on("mousedown touchstart",function(a){b.mousedownTarget=a.target}),b.container.on("scroll",function(a){b.mousedownTarget=null}),b.contentElement=null,b.setContent(b.options.content),b.attached=!1,b.visible=!1};a.getContainingModal=function(a){if(!a)return null;var b=$(a).closest("[data-cm-modal]").data("cm-modal");return b||null},a.hideContainingModal=function(b,c){var d=a.getContainingModal(b);d&&d.hide(c)},a.history=[],a.addToHistory=function(b){a.history.length>=1&&a.history[a.history.length-1]==b||a.history.push(b)},a.removeFromHistory=function(b){var c=a.history.lastIndexOf(b);c<0||a.history.splice(c,1)},a.goBackInHistory=function(){var b=a.history.filter(function(a){return a.options.addToHistory});if(!(b.length<=1)){var c=b[b.length-1],d=b[b.length-2];c.hide(),d.show()}},a.canGoBackInHistory=function(){return a.history.filter(function(a){return a.options.addToHistory}).length>1},a.prototype.setContent=function(a){var b=this;b.options.content=a,b.contentElement&&b.contentElement.remove(),null!=a&&(b.contentElement=$(a),b.container.append(b.contentElement))},a.prototype.setContentLoading=function(){var a=this,b=$("<div></div>").addClass("cm-modal-loading-wrapper").text("Loading...");a.setContent(b[0])},a.prototype.on=function(a,b){var c=this;c.off(a,b),c.handlers.push({eventName:a,callback:b})},a.prototype.off=function(a,b){var c=this;c.handlers=c.handlers.filter(function(c){return!(c.eventName==a&&c.callback==b)})},a.prototype.invokeEvent=function(a){this.handlers.forEach(function(b){b.eventName==a&&b.callback&&b.callback()})},a.getDefaultContainer=function(){var a=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;return a||document.body},a.prototype.attach=function(b){var c=this;c.remove(),c.outerContainer=b?$(b):$(a.getDefaultContainer()),c.outerContainer.append(c.container),c.attached=!0},a.prototype.remove=function(b){var c=this;b||a.removeFromHistory(c),c.attached&&(c.hide(),c.container.remove(),c.attached=!1)},a.prototype.show=function(b){var c=this;c.visible||(c.attached||c.attach(b),c.container.show(),c.visible=!0,a.addToHistory(c),$(document.body).addClass("cm-modal-open"),a.history.forEach(function(a){a.setInactive()}),c.setActive(),c.invokeEvent("shown"))},a.prototype.hide=function(b){var c=this;if(c.visible){c.container.hide(),c.visible=!1,b||a.removeFromHistory(c),c.setInactive();var d=a.history.filter(function(a){return a.visible});d.length>0?d[d.length-1].setActive():$(document.body).removeClass("cm-modal-open"),c.invokeEvent("hidden")}},a.prototype.setActive=function(){this.container.addClass("active")},a.prototype.setInactive=function(){this.container.removeClass("active")},a.showMultiOptionModal=function(b,c,d,e,f){var g=!1,h='<div class="cm-modal-standard"><div class="cm-modal-standard-header"><h3></h3></div><div class="cm-modal-standard-content"></div></div>',i=$('<a tabindex="0" class="cm-modal-close-button" data-cm-modal-dismiss=""><span class="icon-cross"></span><span class="sr-only">Close</span></a>'),j=$(h);j.find(".cm-modal-standard-header h3").text(b),j.find(".cm-modal-standard-content").html(c),j.find(".cm-modal-standard-content").append($('<div class="cm-centered"></div>')),j.find(".cm-modal-standard-header").append(i),$.each(d,function(a,b){var c="cm-button";(b.buttonClass||""==b.buttonClass)&&(c=b.buttonClass);var d=$('<button type="button" data-cm-modal-dismiss=""></button>').text(b.label).addClass(c);b.callback&&d.click(function(){b.callback(),g=!0}),j.find(".cm-centered").append(d)});var k=new a({content:j[0],closeOnClickOutside:!!f});k.on("hidden",function(){e&&!g&&e(),k.remove()}),k.show()},a.showConfirm=function(b,c,d,e,f){a.showMultiOptionModal(b,c,[{label:"No",buttonClass:"cm-button-cancel",callback:e},{label:"Yes",buttonClass:"cm-button-submit",callback:d}],e,f)},a.showConfirmYesFirst=function(b,c,d,e,f){a.showMultiOptionModal(b,c,[{label:"Yes",buttonClass:"cm-button-submit",callback:d},{label:"No",buttonClass:"cm-button-cancel",callback:e}],e,f)},a.showAlert=function(b,c,d,e){a.showMultiOptionModal(b,c,[{label:"Ok",buttonClass:"cm-button-submit",callback:d}],d,e)},$(document).on("click","[data-cm-modal-back-toggle]",function(b){$(this).hasClass("disabled")||$(this).closest(".fade-out").length>0||a.goBackInHistory()}),$(document).on("click","[data-cm-modal-dismiss]",function(b){$(this).hasClass("disabled")||$(this).closest(".fade-out").length>0||a.hideContainingModal(this)}),$(document).keyup(function(b){if(27==b.keyCode){var c=a.history.filter(function(a){return a.visible});c.length>0&&c[c.length-1].hide()}}),window.CmModal=a}(),function(){var a=angular.module("cmPager",[]);a.controller("PagerController",["$scope","$timeout",function(a,b){a.maxPagesToShow=10,a.getNumPages=function(){return a.totalRows&&a.pageSize?Math.ceil(a.totalRows/a.pageSize):0},a.getPageRangeTruncated=function(){if(!a.totalRows||!a.pageSize)return[0];var b=a.getNumPages(),c=a.currentPage-Math.floor(a.maxPagesToShow/2),d=a.currentPage+Math.floor(a.maxPagesToShow/2);d>b-1&&(d=b-1,c=d-a.maxPagesToShow),c<0&&(c=0,(d=c+a.maxPagesToShow-1)>b-1&&(d=b-1)),d-c>=a.maxPagesToShow&&(a.currentPage>b-Math.floor(a.maxPagesToShow/2)-1?c=d-(a.maxPagesToShow-1):d=c+a.maxPagesToShow-1),c<0&&(c=0),d>b-1&&(d=b-1);for(var e=[],f=0;f<=d-c;f++)e.push(f+c);return e},a.setCurrentPage=function(c){var d=a.currentPage!==c;a.currentPage=c,d&&b(function(){a.onPageChange&&a.onPageChange()})};var c=function(){var b=a.pageSize||0;return(a.currentPage||0)*b},d=function(){if(a.pageSize&&a.totalRows&&c()>=a.totalRows){var b=Math.ceil(a.totalRows/a.pageSize)-1;b<0&&(b=0),a.setCurrentPage(b)}};a.$watch("totalRows",function(){a.totalRows&&d()}),a.$watch("pageSize",function(){a.pageSize&&d()}),a.$watch("currentPage",function(){a.currentPage&&d()})}]),a.directive("cmPager",[function(){return{controller:"PagerController",templateUrl:cmHelper.templateBaseUrl+"/pager.html",scope:{currentPage:"=cmCurrentPage",pageSize:"=cmPageSize",totalRows:"=cmTotalRows",onPageChange:"=cmOnPageChange"}}}])}(),function(){angular.module("cmResourceTypesToggle",["cmApi","cmAuth"]).controller("ResourceTypesModalController",["$scope","$timeout","ResourceType",function(a,b,c){a.viewModel=a.viewModel||{},a.viewModel.resourceTypeIdSelected=null,c.queryConverted(function(b){a.viewModel.resourceTypes=b.filter(function(a){return!!a.description}),a.viewModel.resourceTypeFriendlyId&&a.viewModel.resourceTypes.forEach(function(b){b.friendlyId==a.viewModel.resourceTypeFriendlyId&&(a.viewModel.resourceTypeIdSelected=b.id)})}),a.toggleResourceTypeSelected=function(b){if(a.viewModel.resourceTypeIdSelected==b)return void(a.viewModel.resourceTypeIdSelected=null);a.viewModel.resourceTypeIdSelected=b},a.viewModel.updateCanGoBack=function(){b(function(){a.viewModel.canGoBack=CmModal.canGoBackInHistory()})},a.viewModel.updateCanGoBack()}]),$(document).on("click","[data-cm-resource-types-toggle]",function(a){if(a.preventDefault(),!($(this).hasClass("disabled")||$(this).closest(".fade-out").length>0)){var b=$(this).data("cm-modal");if(b)return CmModal.hideContainingModal(this,!0),void b.show();var c=$(this).attr("data-cm-resource-types-toggle"),d=new CmModal;d.setContentLoading(),CmModal.hideContainingModal(this,!0),d.show(),$(this).data("cm-modal",d),$.get("/static/spa-templates/resource-types-modal.html",function(a){var b=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={resourceTypeFriendlyId:c,modal:d},d.on("shown",function(){f.viewModel.updateCanGoBack&&f.viewModel.updateCanGoBack()}),e(b)(f),d.setContent(b[0])}])})}})}(),function(){angular.module("cmSearchModal",["cmApi","cmAuth"]).controller("SearchModalController",["$scope","$element","$timeout","$sce","Search","Auth",function(a,b,c,d,e,f){a.viewModel=a.viewModel||{},a.searchData={searchText:null},a.searchResults=[],a.viewModel.pageSize=20,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.hasSearched=!1,a.viewModel.searching=!1,a.viewModel.newTabUrl="/search",a.keyphraseSelected=function(b){a.searchData.searchText=b.value,a.search()};var g=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b};a.pageChange=function(){i()},a.search=function(){a.searchData.searchText&&(a.viewModel.currentPage=0,i())},a.clearSearch=function(){a.searchData.searchText=null,a.searchResults=[],a.viewModel.totalRows=0,a.viewModel.currentPage=0,cmHelper.setSessionStorage("searchModal.data",null)};var h=function(){return"/search/"+encodeURIComponent(a.searchData.searchText)+(a.viewModel.currentPage>0?"?currentPage="+a.viewModel.currentPage:"")},i=function(){a.searchData.searchText&&(cmHelper.setSessionStorage("searchModal.data",JSON.stringify({searchText:a.searchData.searchText,currentPage:a.viewModel.currentPage})),a.viewModel.newTabUrl=h(),a.viewModel.hasSearched=!0,a.viewModel.searching=!0,e.get({keyphrase:a.searchData.searchText,startRow:g(),maxRows:a.viewModel.pageSize},function(b){a.viewModel.totalRows=b.totalRows,a.searchResults=b.results,a.searchResults.forEach(function(a){a.trustedHtml=d.trustAsHtml(a.html)}),a.viewModel.searching=!1,c(function(){cmSite.processContent()}),cmHelper.setSessionStorage("searchModal.results",JSON.stringify({list:a.searchResults.map(function(a){return{score:a.score,url:a.url,html:a.html}}),totalRows:a.viewModel.totalRows}))},function(){a.viewModel.searching=!1,a.searchResults=[],a.viewModel.totalRows=0,cmHelper.setSessionStorage("searchModal.results",null)}),0==a.viewModel.currentPage&&"function"==typeof ga&&ga("send","event","Search","invoke",a.searchData.searchText))}
;a.viewModel.focusSearchText=function(){b.find("[data-cm-search-modal-text]").focus(),a.searchData.searchText&&b.find("[data-cm-search-modal-text]").select()},a.viewModel.searchFor=function(b){a.searchData.searchText=b,a.search()},a.viewModel.loadSessionData=function(){if(!a.searchData.searchText&&sessionStorage["searchModal.data"]){var b=null;try{b=JSON.parse(sessionStorage["searchModal.data"])}catch(f){}if(b){if(a.searchData.searchText=b.searchText,a.viewModel.currentPage=b.currentPage,!sessionStorage["searchModal.results"])return void i();var e=null;try{e=JSON.parse(sessionStorage["searchModal.results"])}catch(f){}if(!e||!e.list||0==e.list.length)return void i();e.list.forEach(function(a){a.trustedHtml=d.trustAsHtml(a.html)}),a.searchResults=e.list,a.viewModel.totalRows=e.totalRows,c(function(){cmSite.processContent()})}}}}]);var a=function(){var a=this;a.modal=new CmModal({blockHeaderMenu:!1}),a.hasShown=!1,a.searchViewModel={},a.contentElement=null,$.get("/static/spa-templates/cm-search-modal.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,d){var e=b.$new();e.viewModel=a.searchViewModel,d(c)(e),a.modal.setContent(c[0]),a.contentElement=c[0]}])})};a.prototype.show=function(){var a=this;a.modal.show(),a.hasShown||(a.searchViewModel.loadSessionData&&a.searchViewModel.loadSessionData(),a.hasShown=!0),a.searchViewModel.focusSearchText&&setTimeout(function(){a.searchViewModel.focusSearchText()},0)},a.prototype.hide=function(){this.modal.hide()},a.prototype.search=function(a){var b=this;b.searchViewModel.searchFor&&b.searchViewModel.searchFor(a)},a.prototype.getContentElement=function(){return this.contentElement},window.CmSearchModal=a}(),function(){var a=window.cmSite||{};a.initialProcessDone=!1,a.handlers=[],a.on=function(b,c){a.off(b,c),a.handlers.push({eventName:b,callback:c}),"initialProcessDone"==b&&a.initialProcessDone&&c&&c()},a.off=function(b,c){a.handlers=a.handlers.filter(function(a){return!(a.eventName==b&&a.callback==c)})},a.invokeEvent=function(b){a.handlers.forEach(function(a){a.eventName==b&&a.callback&&a.callback()})},a.csrfTokenCookieName="CM-XSRF-TOKEN",a.csrfTokenHeaderName="X-CM-XSRF-TOKEN",$.ajaxSetup({beforeSend:function(b){b.setRequestHeader(a.csrfTokenHeaderName,Cookies.get(a.csrfTokenCookieName))}}),a.typesetMath=function(a){var b=a||document;MathJax.Hub.Queue(["Typeset",MathJax.Hub,b])},a.processContent=function(b,c){var d=b||document;$(d).find("img[data-cm-scale]").each(function(){var a=$(this),b=Number(a.attr("data-cm-scale"));if(!(isNaN(b)||b<=0))if(this.naturalWidth>0){var c=this.naturalWidth;a.css("width",(c/b).toFixed(2)+"px")}else a.on("load",function(){var c=this.naturalWidth;a.css("width",(c/b).toFixed(2)+"px")})}),$(d).find("[data-cm-content] ol").each(function(){"I"!=$(this).attr("type")&&"A"!=$(this).attr("type")||$(this).addClass("upper");var a=$(this).attr("start");null==a||isNaN(a)||$(this).css("counter-reset","cm-ol-counter "+(Number(a)-1)),$(this).children("li").each(function(){var a=$(this).contents();a.length>0&&a[0]&&(3==a[0].nodeType||a[0].tagName&&["span","strong"].indexOf(a[0].tagName.toLowerCase())>=0&&["block","table","none"].indexOf($(a[0]).css("display"))<0)?$(this).addClass("inline-marker"):1==a.length&&a[0]&&a[0].tagName&&"p"==a[0].tagName.toLowerCase()&&$(this).addClass("inline-marker")})}),$(d).find("video[data-cm-controls]").each(function(){var a=$(this),b=a.attr("data-cm-controls");"custom"==b?cmElementsHelper.addCustomVideoControls(this,!1,!1):"no-download"==b?cmElementsHelper.addCustomVideoControls(this,!0,!0):"custom-always"==b&&cmElementsHelper.addCustomVideoControls(this,!1,!0)}),a.typesetMath(b),$(d).find('[data-cm-element="cards"]').each(function(){CmCards.create(this)}),CmIframe.positionResponsiveIframesOnLoad(),CmIframe.positionResponsiveIframes(),MathJax.Hub.Queue(function(){c&&c(),a.invokeEvent("processDone"),a.initialProcessDone||(a.initialProcessDone=!0,a.invokeEvent("initialProcessDone"))})},a.updateContentLayout=function(a){var b=a||document;$(b).find('[data-cm-element="cards"]').each(function(){CmCards.create(this)})},$(window).on("resize",function(){$(document.body).find("video[data-cm-controls]").each(function(){var a=$(this),b=a.attr("data-cm-controls");"custom"==b?cmElementsHelper.resizeCustomVideoControls(this):"no-download"==b?cmElementsHelper.resizeCustomVideoControls(this):"custom-always"==b&&cmElementsHelper.resizeCustomVideoControls(this)})}),window.cmSite=a}(),function(){angular.module("cmUserMenu",["cmApi","cmAuth"]).controller("UserMenuController",["$scope","$timeout","Auth","UserAccount",function(a,b,c,d){a.viewModel={};var e=function(){d.logOut(function(){c.setCurrentUser(null),location.href=location.href})};a.confirmLogOut=function(){CmModal.showConfirm("Log out","Are you sure you want to log out?",function(){e()})}}])}(),function(){var a=angular.module("cmCommenter",["cmCore"]);a.controller("CommenterController",["$scope","$rootScope","$q","$timeout","$element","Comment","Auth",function(a,b,c,d,e,f,g){a.viewModel={},a.viewModel.errors=[],a.viewModel.commentFormErrors=[],a.viewModel.commentList=[],a.viewModel.commentClippedList=[],a.viewModel.commentDetailList=[],a.viewModel.numCommentPagesToShow=1,a.clearErrors=function(){a.viewModel.errors=[],a.viewModel.commentFormErrors=[]},a.getReplies=function(b){return a.viewModel.commentClippedList.filter(function(a){return a.comment.replyToCommentId==b.id})},a.canCurrentUserEditComment=function(a){return!a.isInsertedComment&&(!!b.currentUser.isInAnyRole(["Webmaster","Author","AssistantAuthor","CommentModerator"])||"Pending"==a.comment.moderationStatus&&a.comment.createdByUserId==b.currentUser.userId)},a.canCurrentUserCreateComment=function(){return b.currentUser.verified&&b.currentUser.userId},a.getNumCommentsToShow=function(){return isNaN(a.maxComments)?null:Number(a.maxComments)*a.viewModel.numCommentPagesToShow},a.getComments=function(){if(!a.commentedItem)return void(a.viewModel.commentList=[]);a.viewModel.commentClippedList=[],a.viewModel.commentDetailList=[];var b=!!a.insertRelatedComments;a.viewModel.commentList=f.queryCommentedItem({itemIdentifier:a.commentedItem,insertRelatedComments:b},function(){if(a.updateCommentDetailList(),a.onLoadComments){var b=0;a.viewModel.commentList.forEach(function(a){a.isInsertedComment?b+=a.insertedCommentCount:b++}),a.onLoadComments(b)}})},a.updateCommentDetailList=function(){var b=a.getNumCommentsToShow();null!=b&&b<a.viewModel.commentList.length?a.viewModel.commentClippedList=a.viewModel.commentList.slice(a.viewModel.commentList.length-b):a.viewModel.commentClippedList=a.viewModel.commentList.slice(0),a.viewModel.commentDetailList=a.viewModel.commentClippedList.filter(function(b){return!(b.comment.replyToCommentId&&a.viewModel.commentClippedList.filter(function(a){return a.comment.id==b.comment.replyToCommentId}).length>0)}),$(e[0]).closest(document).length>0&&d(function(){cmSite.processContent(e[0])})},a.canShowMoreComments=function(){var b=a.getNumCommentsToShow();return null!=b&&b<a.viewModel.commentList.length},a.showMoreComments=function(){a.viewModel.numCommentPagesToShow++,a.updateCommentDetailList()},a.canShowFewerComments=function(){return a.viewModel.numCommentPagesToShow>1},a.showFewerComments=function(){a.viewModel.numCommentPagesToShow--,a.updateCommentDetailList()},a.$watch("commentedItem",function(b,c){b!=c&&a.getComments()});var h=function(b){f.remove({id:b},function(){a.getComments()},function(c){if(c.data&&c.data.errorMessages){if("LoginRequired"==c.data.errorType)return void g.confirmLogin(function(){a.deleteComment(b)},function(){a.viewModel.errors=c.data.errorMessages});a.viewModel.errors=c.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to delete the comment."]})};a.confirmDeleteComment=function(b,c){a.clearErrors(),CmModal.showConfirm("Warning","Are you sure you want to delete the comment "+c+"?",function(){h(b)})},a.showAddCommentForm=function(){a.viewModel.selectedComment=null,a.viewModel.comment=new f,a.viewModel.comment.moderationStatus="Pending",a.viewModel.comment.commentedItemIdentifier=a.commentedItem,a.viewModel.comment.createdDate=new Date,a.viewModel.action="Add"},a.hideCommentForm=function(){a.viewModel.selectedComment=null,a.viewModel.comment=null,a.viewModel.action=null},a.updateComment=function(){if(a.clearErrors(),a.viewModel.commentForm.$valid){var b=function(){a.getComments(),a.hideCommentForm(),a.onCommentModified&&a.onCommentModified()},c=function(b){if(b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void g.confirmLogin(a.updateComment,function(){a.viewModel.commentFormErrors=b.data.errorMessages});a.viewModel.commentFormErrors=b.data.errorMessages}else a.viewModel.commentFormErrors=["An error occured whilst trying to submit the comment."]};"Edit"==a.viewModel.action?a.viewModel.comment.$update(b,c):a.viewModel.comment.$save(b,c)}},a.showEditCommentForm=function(b){a.viewModel.selectedComment=b,a.viewModel.comment=angular.extend(new f,b),a.viewModel.action="Edit"},a.showReplyToCommentForm=function(b){a.viewModel.selectedComment=b,a.viewModel.comment=new f,a.viewModel.comment.moderationStatus="Pending",a.viewModel.comment.commentedItemIdentifier=a.commentedItem,a.viewModel.comment.createdDate=new Date,a.viewModel.comment.replyToCommentId=b.id,a.viewModel.action="Reply"},a.getCommentFormHeading=function(){return"Add"==a.viewModel.action?"Add comment":"Reply"==a.viewModel.action?"Add reply":a.viewModel.selectedComment?"Edit comment - "+a.viewModel.selectedComment.title:""},a.getComments();var i=function(){c.all([a.viewModel.commentList.$promise]).then(function(){if(a.initialSelectedCommentId){var b=a.viewModel.commentList.filter(function(b){return b.comment.id==a.initialSelectedCommentId});if(0!=b.length){var c=b[0].comment;"Edit"==a.initialAction?a.showEditCommentForm(c):a.hideCommentForm(),d(function(){$("[data-cm-comment-id]").removeClass("selected");var b=$('[data-cm-comment-id="'+a.initialSelectedCommentId+'"]');b.length>0&&(b[0].scrollIntoView(!0),b.addClass("selected"))})}}})};a.promptLogin=function(){a.onPromptLogin&&a.onPromptLogin()},a.promptRegister=function(){a.onPromptRegister&&a.onPromptRegister()},a.$watch("initialSelectedCommentId",i),a.$watch("initialAction",i)}]),a.directive("cmCommenter",[function(){return{scope:{commentedItem:"=cmCommenter",initialSelectedCommentId:"=cmSelectedCommentId",initialAction:"=cmAction",onCommentModified:"=cmOnCommentModified",onPromptLogin:"=cmOnPromptLogin",onPromptRegister:"=cmOnPromptRegister",onLoadComments:"=cmOnLoadComments",maxComments:"=cmMaxComments",insertRelatedComments:"=cmInsertRelatedComments"},controller:"CommenterController",templateUrl:cmHelper.templateBaseUrl+"/commenter.html"}}])}(),function(){angular.module("cmFeatures",["cmApi","cmAuth"]).controller("FeaturesController",["$scope","$timeout","$element","$sce","Feature","Content",function(b,c,d,e,f,g){b.viewModel=b.viewModel||{},b.viewModel.featureSelected=null,b.viewModel.pageSize=7,b.viewModel.totalRows=0,b.viewModel.currentPage=0,b.viewModel.initalized=!1,b.viewModel.featuresList=[],b.viewModel.loaded=!1,b.viewModel.getCurrentRow=function(){var a=b.viewModel.pageSize||0;return(b.viewModel.currentPage||0)*a},b.viewModel.pageChange=function(){b.getFeatures()},b.getFeatures=function(){b.viewModel.initialized=!0,f.queryConverted({startRow:b.viewModel.getCurrentRow(),maxRows:b.viewModel.pageSize},function(a){b.viewModel.featuresList=a.results,b.viewModel.totalRows=a.totalRows,b.viewModel.featuresList.forEach(function(a){a.convertedContent=e.trustAsHtml(a.convertedContent),a.moreButtonHtml=b.getMoreButtonHtml(a)}),h(b.viewModel.featuresList.length>0?b.viewModel.featuresList[0]:null),c(function(){cmSite.processContent(),b.viewModel.parent&&(b.viewModel.parent.updateItems(),b.viewModel.parent.startScrolling(),d.find("video").each(function(){cmElementsHelper.addCustomVideoControls(this)}))}),b.viewModel.loaded=!0},function(){b.viewModel.loaded=!0})};var h=function(a){b.viewModel.featureSelected=a,b.viewModel.parent&&b.viewModel.parent.positionItems(!0)};b.setSelectedFeature=function(a){b.viewModel.parent&&b.viewModel.parent.stopScrolling(),h(a)},b.viewModel.moveToNextFeature=function(){if(0!=b.viewModel.featuresList.length){var a=0;b.viewModel.featureSelected&&(a=b.viewModel.featuresList.indexOf(b.viewModel.featureSelected)),a<0&&(a=0);var d=a+1;d>=b.viewModel.featuresList.length&&(d=0),c(function(){h(b.viewModel.featuresList[d])})}},b.getMoreButtonHtml=function(b){var c=b.feature,d=a.getMoreButtonHtml(c);return d?e.trustAsHtml(d):null},b.startScrolling=function(){b.viewModel.moveToNextFeature(),b.viewModel.parent&&b.viewModel.parent.startScrolling()},b.viewModel.updateScrolling=function(a){c(function(){b.viewModel.scrolling=a})},b.viewModel.initialized||b.getFeatures()}]);var a=function(a){var b=this;b.container=$(a),b.items=[],b.viewModel={parent:b,scrolling:!0},b.userSelected=!1,b.$scope=null,$.get("/static/spa-templates/features.html",function(a){var c=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,d){var e=a.$new();e.viewModel=b.viewModel,d(c)(e),b.container.empty(),b.container.append(c),b.$scope=e}])}),b.onWindowResize=function(){b.positionItems()},$(window).on("resize",b.onWindowResize)};a.getMoreButtonHtml=function(a){if(!a.moreButtonType||!a.moreButtonText||!a.moreButtonLink)return null;var b=null;return"SameTabLink"==a.moreButtonType?b=$('<a class="cm-button-primary"></a>').text(a.moreButtonText).attr("href",a.moreButtonLink):"NewTabLink"==a.moreButtonType&&(b=$('<a class="cm-button-primary"></a>').text(a.moreButtonText).attr("href",a.moreButtonLink).attr("target","_blank")),b?b[0].outerHTML:null},a.prototype.destroy=function(){var a=this;a.container&&(a.stopScrolling(),a.container.empty(),$(window).off("resize",a.onWindowResize),a.container=null,a.$scope&&a.$scope.$destroy())},a.prototype.startScrolling=function(){var a=this;a.userSelected=!1,a.viewModel.updateScrolling&&a.viewModel.updateScrolling(!0),a.scrollInterval&&clearInterval(a.scrollInterval),a.scrollInterval=setInterval(function(){if(a.userSelected)return clearInterval(a.scrollInterval),void(a.scrollInterval=null);a.container&&a.container.closest(".cm-modal-open").length>0||a.viewModel.moveToNextFeature&&a.viewModel.moveToNextFeature()},1e4)},a.prototype.stopScrolling=function(){var a=this;a.userSelected=!0,a.viewModel.updateScrolling&&a.viewModel.updateScrolling(!1)},a.prototype.updateItems=function(){var a=this;if(a.container&&a.viewModel.featuresList&&0!=a.viewModel.featuresList.length){var b=[];$(a.container).find("[data-cm-features-item]").each(function(){b.push({element:$(this),id:Number($(this).attr("data-cm-features-item")),x:null}),$(this).off("click","a"),$(this).on("click","a",function(){a.stopScrolling()}),$(this).find("video").off("play"),$(this).find("video").on("play",function(){a.stopScrolling()})}),0!=b.length&&(a.items=b,a.positionItems())}},a.prototype.positionItems=function(a){var b=this;if(b.container){var c=b.items;if(0!=c.length){b.aninationInterval&&clearInterval(b.aninationInterval);var d=b.viewModel.featureSelected||b.viewModel.featuresList[0],e=0;c.some(function(a,b){if(a.id==d.feature.id)return e=b,!0});var f=c[e],g=b.container.find("[data-cm-features-wrapper]").width(),h=g/2-f.element.outerWidth(!0)/2;if(a){var i=0;b.aninationInterval=setInterval(function(){var a,c=f.x||0,d=20;c>h?(a=c-d)<h+5&&(a=h):(a=c+d)>h-5&&(a=h),Math.abs(a-h)<5||i>=5e3?(b.positionItemsDirect(e,h),clearInterval(b.aninationInterval),b.aninationInterval=null):b.positionItemsDirect(e,a),i+=20},20)}else b.positionItemsDirect(e,h)}}},a.prototype.positionItemsDirect=function(a,b){var c=this;if(c.container){var d=c.container.find("[data-cm-features-wrapper]").width(),e=0,f=0,g=c.items;g.forEach(function(a){a.element.css("display","block"),a.width=a.element.outerWidth(!0),e+=a.width});for(var h=b,i=a,j=0;j<g.length;j++){var k=g[i];h>d/2+e/2-k.width/2+10&&(h=b-(e-f)),k.x=h,k.element.css("left",h+"px"),h+=k.width,f+=k.width,i++,i>=g.length&&(i=0)}}},window.Features=a}(),function(){angular.module("cmFileBrowser",["cmFileManagerComponent"]).factory("FileBrowser",["$rootScope","$http","$compile","$timeout",function(a,b,c,d){var e={},f=null,g=null,h=null,i=function(a){f.hide(),d(function(){h&&h(a)})};return e.browse=function(a){if(a){if(f)return g.fileManager=a,h=a.onSelect,g.fileManager.onSelect=i,void f.show();f=new CmModal,f.setContentLoading(),f.show(),$.get("/static/spa-templates/file-browser.html",function(b){var c=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){g=b.$new(),g.fileManager=a,h=a.onSelect,g.fileManager.onSelect=i;var j=function(){g.fileManager.onClose&&d(g.fileManager.onClose)};f.on("hidden",j),e(c)(g),f.setContent(c[0])}])})}},e}])}(),function(){var a=angular.module("cmFileManagerComponent",["cmAuth","cmApi"]);a.directive("cmFileManager",[function(){return{scope:{fileManagerObject:"=?cmFileManager"},controller:"FileManagerComponentController",templateUrl:cmHelper.templateBaseUrl+"/file-manager-component.html"}}]),a.controller("FileManagerComponentController",["$scope","$rootScope","$timeout","FileSystem","Image","Auth",function(a,c,d,e,f,g){a.viewModel={},a.viewModel.errors=[],a.viewModel.filesAndDirectoriesAll=[],a.viewModel.filesAndDirectories=[],a.viewModel.currentDirectory=null,a.viewModel.currentVirtualPathComponents=[],a.viewModel.createDirectoryOpen=!1,a.viewModel.createDirectoryName=null,a.viewModel.upload={inProgress:!1,percentComplete:0,aborted:!1,xhr:null},a.viewModel.processingSpecialAction=null,a.viewModel.gettingFiles=!1,a.viewModel.pageSize=50,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.onSelect=null,a.viewModel.selectText=null,a.viewModel.showVirtualUrls=!1,a.viewModel.showDirectory=!0,a.viewModel.allowEdit=!0,a.viewModel.uploadSizeLimit=1073741824,a.viewModel.allowedFileExtensions=null,a.currentVirtualPath=null,a.rootVirtualPath=null,a.viewModel.imageSourcesParentDirectory=null,a.clearErrors=function(){a.viewModel.errors=[]},a.getDefaultAllowedFileExtensions=function(){return c.currentUser.isInAnyRole(["AssistantAuthor","Author","Webmaster","ChampionManager","EventManager"])?null:["doc","docx","odf","xls","xlsx","pdf","jpg","jpeg","gif","png","svg","mp4","avi","mov","ppt","pptx","txt","md","htm","html"]},a.updateFilesAndDirectories=function(){var b=a.viewModel.filesAndDirectoriesAll;a.viewModel.showVirtualUrls||(b=b.filter(function(a){return"VirtualFileUrl"!=a.type&&"VirtualDirectoryUrl"!=a.type})),a.viewModel.totalRows=b.length;var c=h();a.viewModel.filesAndDirectories=b.slice(c,c+a.viewModel.pageSize)};var h=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b};a.pageChange=function(){a.updateFilesAndDirectories()},a.getImageSourcesParentDirectory=function(){null!=a.currentVirtualPath&&f.getImageSourcesParent({virtualPath:a.currentVirtualPath},function(b){b.virtualPath.join("/").substr(0,a.rootVirtualPath.length)!=a.rootVirtualPath?(console.log(b.virtualPath.join("/").substr(0,a.rootVirtualPath.length)),console.log(a.rootVirtualPath),a.viewModel.imageSourcesParentDirectory=null):a.viewModel.imageSourcesParentDirectory=b},function(){a.viewModel.imageSourcesParentDirectory=null})},a.getCurrentDirectory=function(){a.clearErrors(),a.viewModel.currentDirectory=null,null!=a.currentVirtualPath&&(e.get({virtualPath:a.currentVirtualPath},function(b){a.viewModel.currentDirectory=b},function(b){if(b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void g.confirmLogin(a.getCurrentDirectory,function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to get the directory information."]}),a.getImageSourcesParentDirectory())},a.isVirtualDirectory=function(a){return["VirtualDirectoryNormal","VirtualDirectorySpecial","VirtualDirectoryUrl"].indexOf(a.type)>=0},a.getFiles=function(){a.clearErrors(),null==a.currentVirtualPath||a.viewModel.gettingFiles||(a.viewModel.filesAndDirectoriesAll=[],a.viewModel.currentPage=0,a.updateFilesAndDirectories(),a.viewModel.gettingFiles=!0,e.getDirectoryChildren({virtualPath:a.currentVirtualPath},function(b){a.viewModel.gettingFiles=!1,a.viewModel.filesAndDirectoriesAll=b,a.updateFilesAndDirectories()},function(b){if(a.viewModel.gettingFiles=!1,b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void g.confirmLogin(a.getFiles,function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to get the directory contents."]}))},a.updateAll=function(){a.getCurrentDirectory(),a.getFiles()},a.$watch("currentVirtualPath",function(){a.currentVirtualPath&&(a.fileManagerObject.currentVirtualPath=a.currentVirtualPath),a.updateAll(),a.viewModel.currentVirtualPathComponents=a.getVirtualPathComponents(a.currentVirtualPath)}),a.$watch("rootVirtualPath",function(b,c){null!=a.currentVirtualPath&&null!=a.rootVirtualPath&&a.currentVirtualPath.substr(0,a.rootVirtualPath.length)!=a.rootVirtualPath&&(a.currentVirtualPath=a.rootVirtualPath)}),a.canSelectItem=function(b){return!(null==a.currentVirtualPath||!a.viewModel.onSelect||!a.viewModel.selectText)&&("VirtualDirectorySpecial"!=b.type&&(0!=a.viewModel.showVirtualUrls||"VirtualFileNormal"==b.type)&&!(a.currentVirtualPath.split("/").indexOf("private")>=0||a.currentVirtualPath.split("/").indexOf("image-sources")>=0||a.currentVirtualPath.split("/").indexOf("printable-images")>=0))},a.$watch("fileManagerObject",function(){null!=a.fileManagerObject&&(a.fileManagerObject.refresh=function(){a.updateAll()},a.fileManagerObject.getFileCount=function(){return a.viewModel.filesAndDirectoriesAll.length})}),a.$watch("fileManagerObject.currentVirtualPath",function(){a.currentVirtualPath=a.fileManagerObject.currentVirtualPath}),a.$watch("fileManagerObject.rootVirtualPath",function(){a.rootVirtualPath=a.fileManagerObject.rootVirtualPath}),a.$watch("fileManagerObject.selectText",function(){a.viewModel.selectText=a.fileManagerObject.selectText}),a.$watch("fileManagerObject.onSelect",function(){a.viewModel.onSelect=a.fileManagerObject.onSelect}),a.$watch("fileManagerObject.showVirtualUrls",function(){a.viewModel.showVirtualUrls=a.fileManagerObject.showVirtualUrls}),a.$watch("fileManagerObject.showDirectory",function(){if(null==a.fileManagerObject.showDirectory)return void(a.viewModel.showDirectory=!0);a.viewModel.showDirectory=a.fileManagerObject.showDirectory}),a.$watch("fileManagerObject.allowEdit",function(){if(null==a.fileManagerObject.allowEdit)return void(a.viewModel.allowEdit=!0);a.viewModel.allowEdit=a.fileManagerObject.allowEdit}),a.$watch("fileManagerObject.allowedFileExtensions",function(){a.viewModel.allowedFileExtensions=a.fileManagerObject.allowedFileExtensions}),a.getVirtualPathComponents=function(b){if(null==b||null==a.rootVirtualPath)return[];var c=b.substr(a.rootVirtualPath.length),d=c.split("/").filter(function(a){return!!a}),e=a.rootVirtualPath.split("/").filter(function(a){return!!a}),f=[],g=e;return d.forEach(function(a){g.push(a),f.push(g.slice(0))}),f},a.openDirectory=function(b){null==b||a.viewModel.gettingFiles||(a.currentVirtualPath=b.join("/"))},a.getParentPath=function(){if(null==a.currentVirtualPath)return null;var b=a.currentVirtualPath.split("/").filter(function(a){return!!a});return 0==b.length?null:b.slice(0,b.length-1).join("/")},a.canGoUp=function(){if(null==a.currentVirtualPath||null==a.rootVirtualPath)return!1;var b=a.rootVirtualPath.split("/").filter(function(a){return!!a});return!(a.currentVirtualPath.split("/").filter(function(a){return!!a}).length<=b.length)},a.openParentDirectory=function(){if(a.canGoUp()&&!a.viewModel.gettingFiles){var b=a.getParentPath();null!=b&&(a.currentVirtualPath=b)}},a.getName=function(a){return null==a?null:a.length>0?a[a.length-1]:null},a.getDownloadUrl=function(a){return a.meta&&a.meta.downloadUrl?a.meta.downloadUrl:"/file-system/file/"+a.virtualPath.join("/")},a.itemSelected=function(b){if(a.viewModel.onSelect){var c=b.virtualPath;b.meta&&b.meta.canonicalPath&&(c=b.meta.canonicalPath),a.viewModel.onSelect(c)}};var i=function(b){e.remove({virtualPath:b.virtualPath.join("/")},function(){a.getFiles(),a.viewModel.imageSourcesParentDirectory&&a.currentVirtualPath&&a.currentVirtualPath.indexOf("image-sources")>0&&a.generateImages()},function(c){if(c.data&&c.data.errorMessages){if("LoginRequired"==c.data.errorType)return void g.confirmLogin(function(){i(b)},function(){a.viewModel.errors=c.data.errorMessages});a.viewModel.errors=c.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to delete the item."]})};a.confirmDeleteFileOrDirectory=function(b,c){a.clearErrors(),CmModal.showConfirm("Warning","Are you sure you want to delete the item "+c+"?",function(){i(b)})},a.uploadFile=function(){if(!a.viewModel.upload.inProgress&&null!=a.currentVirtualPath){a.clearErrors();for(var b=document.getElementById("files-to-upload"),c=b.files,d=c.length,f=[],g=0;g<c.length;g++)!function(b){var c={name:b.name,exists:null,existingName:null};f.push(c),e.doesFileExist({strict:"False",virtualPath:a.currentVirtualPath+"/"+b.name},function(a){c.exists=a.exists,c.existingName=a.name,h()},h)}(c[g]);var h=function(){if(!(--d>0)){for(var a=[],b=0;b<f.length;b++)!0===f[b].exists?a.push("A file with name "+f[b].existingName+" already exists. This will be overwitten by the file "+f[b].name+"."):!1!==f[b].exists&&a.push("A file with name "+f[b].existingName+" may already exist. This may be overwitten by the file "+f[b].name+".");a.length>0?CmModal.showConfirm("Warning",a.join("<br/>\n")+"<br/>\nAre you sure you wish to continue?",j):j()}}}};var j=function(){if(!a.viewModel.upload.inProgress&&null!=a.currentVirtualPath){for(var b=document.getElementById("files-to-upload"),c=b.files,e=new FormData,f=0,h=[],i=0;i<c.length;i++){var j=c[i],k=j.name?j.name.split(".").pop().toLowerCase():"",l=a.viewModel.allowedFileExtensions||a.getDefaultAllowedFileExtensions();l&&l.indexOf(k)<0&&h.push("File extension for file "+j.name+" is not allowed"),j.size&&j.size>a.viewModel.uploadSizeLimit&&h.push("File "+j.name+" exceeds the file size limit of "+(a.viewModel.uploadSizeLimit/1024/1024).toFixed(1)+"MB"),e.append("files-to-upload-"+f.toString(),j,j.name),f++}if(h.length>0)return void(a.viewModel.errors=h);if(0!=f){a.viewModel.upload.aborted=!1;var m=new XMLHttpRequest;a.viewModel.upload.xhr=m,m.onreadystatechange=function(){m.readyState<4||d(function(){var c=m.status;if(a.viewModel.upload.inProgress=!1,a.viewModel.upload.percentComplete=0,a.viewModel.upload.xhr=null,a.getFiles(),a.viewModel.imageSourcesParentDirectory&&a.currentVirtualPath&&a.currentVirtualPath.indexOf("image-sources")>0&&(a.getImageSourcesParentDirectory(),a.generateImages()),c>=200&&c<300||304===c)b.outerHTML=b.outerHTML;else{if(a.viewModel.upload.aborted)return void(b.outerHTML=b.outerHTML);var d=null;try{d=JSON.parse(m.responseText)}catch(e){d=null}if(d&&d.errorMessages){if("LoginRequired"==d.errorType)return void g.confirmLogin(a.uploadFile,function(){a.viewModel.errors=result.data.errorMessages});a.viewModel.errors=result.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to upload the file."]}})},m.upload.onprogress=function(b){b.lengthComputable&&d(function(){a.viewModel.upload.percentComplete=b.loaded/b.total*100})},m.open("POST","/file-system/file/"+a.currentVirtualPath,!0),m.setRequestHeader(cmSite.csrfTokenHeaderName,Cookies.get(cmSite.csrfTokenCookieName)),m.send(e),a.viewModel.upload.percentComplete=0,a.viewModel.upload.inProgress=!0}}};a.cancelUpload=function(){a.viewModel.upload.inProgress&&a.viewModel.upload.xhr&&(a.viewModel.upload.aborted=!0,a.viewModel.upload.xhr.abort())},a.editFile=function(b){a.clearErrors(),b.newName=a.getName(b.virtualPath),b.editing=!0},a.updateFile=function(b){if(b.editing&&(a.clearErrors(),b.newName)){b.editing=!1;var c=a.getName(b.virtualPath);if(b.newName!=c){var d=b.newName?b.newName.split(".").pop().toLowerCase():"";if(a.viewModel.allowedFileExtensions&&a.viewModel.allowedFileExtensions.indexOf(d)<0)return void a.viewModel.errors.push("File extension for file "+b.newName+" is not allowed");e.update({virtualPath:a.currentVirtualPath+"/"+c},{name:b.newName},function(){a.getFiles()},function(c){if(c.data&&c.data.errorMessages){if("LoginRequired"==c.data.errorType)return void g.confirmLogin(function(){a.updateFile(b)},function(){a.viewModel.errors=c.data.errorMessages});a.viewModel.errors=c.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to update the item."]})}}},a.cancelEditFile=function(b){a.clearErrors(),b.editing=!1},a.createDirectory=function(b){a.viewModel.createDirectoryOpen&&(a.clearErrors(),a.viewModel.createDirectoryName&&(a.viewModel.createDirectoryOpen=!1,e.save({virtualPath:a.currentVirtualPath},{name:a.viewModel.createDirectoryName},function(){a.getFiles()},function(c){if(c.data&&c.data.errorMessages){if("LoginRequired"==c.data.errorType)return void g.confirmLogin(function(){a.createDirectory(b)},function(){a.viewModel.errors=c.data.errorMessages});a.viewModel.errors=c.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to create the folder."]})))},a.generateImages=function(){!a.viewModel.processingSpecialAction&&a.viewModel.imageSourcesParentDirectory&&(a.clearErrors(),a.viewModel.processingSpecialAction="GenerateImages",f.generateImages({virtualPath:a.viewModel.imageSourcesParentDirectory.virtualPath.join("/")},null,function(){a.viewModel.processingSpecialAction=null,a.updateAll()},function(b){if(a.viewModel.processingSpecialAction=null,b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void g.confirmLogin(function(){a.generateImages()},function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to generate the images."]}))},a.clearImages=function(){!a.viewModel.processingSpecialAction&&a.viewModel.imageSourcesParentDirectory&&(a.viewModel.processingSpecialAction="ClearImages",f.clearImages({virtualPath:a.viewModel.imageSourcesParentDirectory.virtualPath.join("/")},null,function(){a.viewModel.processingSpecialAction=null,a.updateAll()},function(b){if(a.viewModel.processingSpecialAction=null,b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void g.confirmLogin(function(){a.clearImages()},function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to clear the images."]}))},a.confirmClearImages=function(){a.clearErrors(),CmModal.showConfirm("Warning","Are you sure you want to clear all the auto-generated images associated with this directory?",function(){a.clearImages()})},a.formatFileSize=function(a){if(null==a)return null;var b=a/1e3;return b>=1e4?Math.round(b/1e3).toFixed(1)+"MB":Math.round(b).toFixed(0)+"kB"},a.isConvertibleImage=function(a){return!(a.virtualPath.indexOf("image-sources")>=0)&&[".jpg",".jpeg",".png"].indexOf(b(a.virtualPath))>=0},a.convertImageViewModel={},a.convertImageViewModel.successCallback=function(){a.getFiles()},a.promptConvertImage=function(b){a.convertImageViewModel.inputVirtualPath=b.virtualPath.slice(0);var c=new CmModal;c.setContentLoading(),c.show(),a.convertImageViewModel.modal=c,$.get("/static/spa-templates/convert-image-modal.html",function(b){var d=$(b);angular.element(document).injector().invoke(["$rootScope","$compile",function(b,e){var f=b.$new();f.viewModel=a.convertImageViewModel,e(d)(f),c.setContent(d[0])}])}),c.show()}}]);var b=function(a){if(!a||0==a.length)return"";var b=a[a.length-1].split(".");return(b.length>1?"."+b[b.length-1]:"").toLowerCase()},c=function(a){if(!a||0==a.length)return"";var b=a[a.length-1].split(".");return b.length>1?b.slice(0,b.length-1).join("."):b.join(".")
};a.controller("ConvertImageModalController",["$scope","$rootScope","$timeout","ConvertImage","FileSystem","Auth",function(a,d,e,f,g,h){if(a.viewModel=a.viewModel||{},a.viewModel.errors=[],a.viewModel.convertImageOptions={},a.viewModel.convertImageOptions.quality=80,a.viewModel.outputFilename=null,a.viewModel.imageType="Jpeg",a.viewModel.title="Create a converted version",a.viewModel.inputVirtualPath){a.viewModel.convertImageOptions.inputVirtualPath=a.viewModel.inputVirtualPath;var i=b(a.viewModel.inputVirtualPath);".png"==i&&(a.viewModel.imageType="Png");var j=c(a.viewModel.inputVirtualPath);a.viewModel.outputFilename=j+"-converted",a.viewModel.title="Create a converted version of the image "+j+i}a.clearErrors=function(){a.viewModel.errors=[]},a.convertImage=function(){a.clearErrors(),a.viewModel.convertImageForm.$valid&&!a.viewModel.convertingImage&&(a.viewModel.convertImageOptions.inputVirtualPath||(a.viewModel.errors=["An input image is required"]),a.viewModel.convertImageOptions.outputVirtualPath=a.viewModel.convertImageOptions.inputVirtualPath.slice(0,a.viewModel.convertImageOptions.inputVirtualPath.length-1).concat([a.viewModel.outputFilename+a.getOutputFileExtension()]),g.doesFileExist({strict:"True",virtualPath:a.viewModel.convertImageOptions.outputVirtualPath.join("/")},function(a){var b=[];!0===a.exists?b.push("A file with name "+a.name+" already exists. This will be overwitten."):!1!==a.exists&&b.push("A file with name "+a.name+" may already exist. This may be overwitten."),b.length>0?CmModal.showConfirm("Warning",b.concat("Are you sure you want to continue?").join("<br />"),k):k()},k))};var k=function(){a.viewModel.convertingImage=!0;var b=$.extend({},a.viewModel.convertImageOptions);"Jpeg"!=a.viewModel.imageType&&(b.quality=null),f.convertImage(b,function(){a.viewModel.convertingImage=!1,a.viewModel.modal&&a.viewModel.modal.hide(),a.viewModel.successCallback&&a.viewModel.successCallback()},function(b){if(a.viewModel.convertingImage=!1,b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void h.confirmLogin(k,function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to convert the image."]})};a.getOutputFileExtension=function(){return"Png"==a.viewModel.imageType?".png":".jpg"},a.cancelConvertImage=function(){a.viewModel.modal&&a.viewModel.modal.hide()}}])}(),function(){var a="http://www.w3.org/2000/svg",b=function(a,b){return new RegExp("(\\s|^)"+b+"(\\s|$)").test(a.getAttributeNS(null,"class"))},c=function(a,c){b(a,c)||a.setAttributeNS(null,"class",a.getAttributeNS(null,"class")+" "+c)},d=function(a,c){var d=a.getAttributeNS(null,"class").replace(new RegExp("(\\s|^)"+c+"(\\s|$)","g"),"$2");b(a,c)&&a.setAttributeNS(null,"class",d)},e=function(a){var b=this;this.nativeDimensions={width:906,height:820},this.enableZoom=!1,this.maxScale=.85,this.scale=this.maxScale,this.origin={x:0,y:0},this.center=null,this.map=null,this.selectedLine=null,this.lineButtons=null,this.dragData=null,this.eventListeners=[],this.stations=[],this.lines=[],this.pervasiveIdeas=[],this.pervasiveIdeasCenter={x:283,y:640},this.pervasiveIdeasRadius=68,this.stationElements=[],this.pervasiveIdeaElements=[],this.fontSize=14,this.smallFontSize=13,this.footerFontSize=12,this.buttonFontSize=15,this.headingFontSize=18,this.maxFontSizeScale=19/14,this.selectedStation=null,this.hadPanned=!1,this.preventClickEvent=!1,this.pervasiveIdeaExplanationLink=null,this.pervasiveIdeasHeading=null,this.hasUserScaled=!1,this.defaultMinAutoScale=.5,this.minAutoScale=this.defaultMinAutoScale,this.downloadUrl="/static/files/map/map-poster.pdf",this.downloadLink=null,this.loadedStations=!1,this.loadedLines=!1,this.loadedPervasiveIdeas=!1,this.loadedUser=!1,this.loadedMap=!1,this.outerContainer=$(a),this.container=$("<div></div>").css("position","relative").css("overflow","hidden").css("width","100%").css("height","100%").appendTo(this.outerContainer),this.panContainer=$("<div></div>").css("position","relative").css("width","100%").css("height","100%"),this.container.append(this.panContainer),this.mapContainer=$("<div></div>").css("width",this.nativeDimensions.width+"px").css("height",this.nativeDimensions.height+"px").addClass("map-container"),this.mapContainer.css("position","absolute").css("backgrond-color","transparent"),this.setOrigin({x:0,y:0}),this.stopDrag=function(){b.dragData=null,b.canScroll()?b.mapContainer.css("cursor","grab").css("cursor","-webkit-grab"):b.mapContainer.css("cursor","default")},this.mapContainer.on("mouseenter",function(a){b.canScroll()?b.mapContainer.css("cursor","move").css("cursor","grab").css("cursor","-webkit-grab").css("cursor","-moz-grab"):b.mapContainer.css("cursor","default")}),this.mapContainer.on("mousedown touchstart",function(a){if((!a.target||!a.target.nodeName||"a"!=a.target.nodeName.toLowerCase())&&(b.preventClickEvent=!1,b.canScroll())){var c={x:a.pageX,y:a.pageY};void 0===a.pageX&&a.originalEvent&&a.originalEvent.touches&&a.originalEvent.touches.length>0&&(c={x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY});var d=b.pageToPanContainerPosition({x:c.x,y:c.y});b.dragData={startPosition:{x:d.x-b.origin.x,y:d.y-b.origin.y},started:!1},a.preventDefault()}}),$(window).on("mouseup touchend",function(a){b.dragData&&(b.dragData.started&&(b.preventClickEvent=!0),b.stopDrag())}),$(window).on("mousemove touchmove",function(a){if(b.dragData){var c={x:a.pageX,y:a.pageY};void 0===a.pageX&&a.originalEvent&&a.originalEvent.touches&&a.originalEvent.touches.length>0&&(c={x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY});var d=(b.container.width(),b.container.height(),b.pageToPanContainerPosition({x:c.x,y:c.y})),e=d.x-b.dragData.startPosition.x,f=d.y-b.dragData.startPosition.y;b.mapContainer.css("cursor","move").css("cursor","grabbing").css("cursor","-webkit-grabbing").css("cursor","-moz-grabbing"),b.dragData.started?b.setOrigin({x:e,y:f}):(Math.abs(e-b.origin.x)>1||Math.abs(f-b.origin.y)>1)&&(b.dragData.started=!0,b.hasPanned=!0),a.preventDefault()}}),this.mapContainer.click(function(a){var c=b.pageToMapPosition({x:a.pageX,y:a.pageY});b.preventClickEvent||b.invokeEvent("click",{position:c}),b.preventClickEvent=!1}),this.panContainer.append(this.mapContainer),this.updateControls(),$.get("/static/img/map.svg",function(a){b.loadedMap=!0;var c=$(a).children("svg");0==c.length&&(c=$(a)),b.mapContainer.append(c),b.map=c}).always(function(){b.loadedMap=!0,b.updateIfLoaded()}),this.currentUser=null,this.getCurrentUser=function(){$.getJSON("/account/api/users/current",function(a){a&&a.username?b.currentUser=a:b.currentUser=null}).fail(function(){b.currentUser=null}).always(function(){b.loadedUser=!0,b.updateIfLoaded()})},this.getCurrentUser(),$.getJSON("/api/stations",function(a){a&&Array.isArray(a)&&(b.stations=a)}).always(function(){b.loadedStations=!0,b.updateIfLoaded()}),$.getJSON("/api/lines/detail",function(a){a&&Array.isArray(a)&&(b.lines=a)}).always(function(){b.loadedLines=!0,b.updateIfLoaded()}),$.getJSON("/api/pervasive-ideas",function(a){a&&Array.isArray(a)&&(b.pervasiveIdeas=a)}).always(function(){b.loadedPervasiveIdeas=!0,b.updateIfLoaded()})};e.prototype.updateIfLoaded=function(){var a=this;a.loadedUser&&a.loadedMap&&a.loadedLines&&a.loadedStations&&a.loadedPervasiveIdeas&&a.update()},e.prototype.reset=function(){this.hasUserScaled=!1,this.hasPanned=!1,this.selectedLine&&this.clearSelectedLine(),this.updateLayout()},e.prototype.update=function(){var a=this;a.updateStations(),a.updatePervasiveIdeas(),a.updateLineButtons(),a.updateFooter(),a.updateDownloadLink(),a.updateLayout()},e.prototype.updateLayout=function(){this.doAutoScale(!0),this.updatePervasiveIdeasLayout(),this.updateStationsLayout(),this.updateControls();var a=this.scale||1,b=Math.min(this.buttonFontSize/a,this.maxFontSizeScale*this.buttonFontSize);if(this.container.find("[data-cm-line-button]").css("font-size",b.toFixed(1)+"px"),!this.selectedStation&&!this.hasPanned){var c=this.getDimensions();this.setOrigin({x:c.width/2,y:c.height/2})}if(this.footer){var d=Math.min(this.footerFontSize/a,this.maxFontSizeScale*this.footerFontSize);this.footer.css("font-size",d)}},e.prototype.setMinAutoScale=function(a){this.minAutoScale=a||this.defaultMinAutoScale,this.minAutoScale<.1&&(this.minAutoScale=.1),this.minAutoScale>1&&(this.minAutoScale=1),this.updateLayout()},e.prototype.doAutoScale=function(a){if(this.hasUserScaled)return void this.setScale(this.scale,a);var b=this.container.width()/this.nativeDimensions.width;this.nativeDimensions.height*b>this.container.height()&&(b=this.container.height()/this.nativeDimensions.height),b<this.minAutoScale&&(b=this.minAutoScale),this.setScale(b,a)},e.prototype.setSelectedStation=function(a){this.selectedStation=a,this.hasPanned=!1,this.updateStations()},e.prototype.setZoomEnabled=function(a){this.enableZoom=a},e.prototype.updateControls=function(){var a=this;if(!a.controls){a.controls=$("<div></div>").addClass("map-controls").appendTo(a.container),a.zoomButtons=$("<div></div>").addClass("map-zoom-buttons").appendTo(a.controls);$('<a tabindex="0"><span class="icon-plus"></span><span class="sr-only">Zoom In</span></a>').addClass("map-zoom-in-button").appendTo(a.zoomButtons).click(function(){var b=a.scale||1;a.hasUserScaled=!0,a.setScale(1.2*b),a.invokeEvent("zoom")});$('<a tabindex="0"><span class="icon-minus"></span><span class="sr-only">Zoom Out</span></a>').addClass("map-zoom-out-button").appendTo(a.zoomButtons).click(function(){var b=a.scale||1;a.hasUserScaled=!0,a.setScale(.8*b),a.invokeEvent("zoom")}),a.centerButton=$('<a tabindex="0"><span class="icon-target"></span><span class="sr-only">Center Map</span></a>').addClass("map-center-button").appendTo(a.controls),a.centerButton.click(function(){a.setCenter(a.center),a.invokeEvent("center")})}if(!(a.canZoom()||a.center&&a.canScroll()))return void a.controls.hide();a.controls.show(),a.center&&a.canScroll()?a.centerButton.css("display","inline-block"):a.centerButton.hide(),a.canZoom()&&a.enableZoom?a.zoomButtons.show():a.zoomButtons.hide()},e.prototype.getStations=function(){return this.stations},e.prototype.on=function(a,b){this.eventListeners.push({eventName:a,callback:b})},e.prototype.off=function(a,b){this.eventListeners=this.eventListeners.filter(function(c){return c.eventName==a&&(!b||c.callback==b)})},e.prototype.invokeEvent=function(a,b){this.eventListeners.forEach(function(c){c.eventName==a&&c.callback(b)})},e.prototype.pageToPanContainerPosition=function(a){return{x:a.x-this.panContainer.offset().left,y:a.y-this.panContainer.offset().top}},e.prototype.pageToMapPosition=function(a){var b=this,c=this.pageToPanContainerPosition(a),d=this.scale||1,e=b.container.width(),f=b.container.height(),g=e/2-b.getDimensions().width/2,h=f/2-b.getDimensions().height/2;return{x:(c.x-this.origin.x-g)/d,y:(c.y-this.origin.y-h)/d}},e.prototype.getNativeDimensions=function(){return this.nativeDimensions},e.prototype.getDimensions=function(){this.scale;return{width:this.scale*this.nativeDimensions.width,height:this.scale*this.nativeDimensions.height}},e.prototype.canZoom=function(){if(this.scale<this.maxScale)return!0;var a=this.getDimensions();return a.width>this.container.width()+1||a.height>this.container.height()+1},e.prototype.setScale=function(a,b){var c=this.scale||1,d={x:(this.container.width()/2-this.origin.x)/c,y:(this.container.height()/2-this.origin.y)/c},e=a||1;e<.1&&(e=.1);var f=Math.min(this.container.width()/this.nativeDimensions.width,this.container.height()/this.nativeDimensions.height);e<f&&(e=f),e>this.maxScale&&(e=this.maxScale),this.scale=e,this.mapContainer.css("transform","scale("+this.scale.toFixed(3)+", "+this.scale.toFixed(3)+")").css("transform-origin","0 0"),this.mapContainer.css("-webkit-transform","scale("+this.scale.toFixed(3)+", "+this.scale.toFixed(3)+")").css("-webkit-transform-origin","0 0"),this.mapContainer.css("-ms-transform","scale("+this.scale.toFixed(3)+", "+this.scale.toFixed(3)+")").css("-ms-transform-origin","0 0"),this.setOrigin({x:this.container.width()/2-d.x*this.scale,y:this.container.height()/2-d.y*this.scale}),b||this.updateLayout()},e.prototype.getOrigin=function(){return this.origin},e.prototype.setOrigin=function(a){var b=this,c=a?a.x:0,d=a?a.y:0,e=b.container.width(),f=b.container.height(),g=e/2-b.getDimensions().width/2,h=f/2-b.getDimensions().height/2;c+b.getDimensions().width<e&&b.getDimensions().width<=e&&(c=e-b.getDimensions().width),c+b.getDimensions().width+g<e&&b.getDimensions().width>e&&(c=e-b.getDimensions().width-g),d+b.getDimensions().height<f&&b.getDimensions().height<=f&&(d=f-b.getDimensions().height),d+b.getDimensions().height+h<f&&b.getDimensions().height>f&&(d=f-b.getDimensions().height-h),c>0&&b.getDimensions().width<=e&&(c=0),c+g>0&&b.getDimensions().width>e&&(c=-g),d>0&&b.getDimensions().height<=f&&(d=0),d+h>0&&b.getDimensions().height>f&&(d=-h),b.origin={x:c,y:d},b.mapContainer.css("left",(b.origin.x+g).toFixed(1)+"px").css("top",(b.origin.y+h).toFixed(1)+"px")},e.prototype.setCenter=function(a){if(!a)return void(this.center=null);this.center={x:a.x,y:a.y};var b=this.getDimensions(),c=this.scale||1;this.setOrigin({x:b.width/2-this.center.x*c,y:b.height/2-this.center.y*c}),this.updateControls()},e.prototype.canScroll=function(){var a=this.getDimensions();return a.width>this.container.width()+1||a.height>this.container.height()+1},e.prototype.updateLineButtons=function(){var a=this;this.lineButtons&&(this.lineButtons.remove(),this.lineButtons=null),this.map&&0!=this.lines.length&&(this.lineButtons=$("<ul></ul>").addClass("line-buttons"),this.lines.forEach(function(b){var c=b.line;if(0!=a.map.find('[class^="'+c.friendlyId+'"], [class*=" '+c.friendlyId+'"]').length){var d=$("<li></li>"),e=$('<a tabindex="0" role="button"></a>').addClass("line-button").text(c.name).css("background-color",c.colour).attr("data-cm-line-button",c.id);e.click(function(){a.preventClickEvent=!0,a.selectedLine==c.id?a.clearSelectedLine():a.setSelectedLine(c.id)}),d.append(e),a.lineButtons.append(d)}}),this.mapContainer.append(this.lineButtons),this.updateLayout())},e.prototype.updateLineButtonsActive=function(){var a=this;a.lineButtons.find(".active").removeClass("active"),a.selectedLine&&a.lineButtons.find('[data-cm-line-button="'+a.selectedLine+'"]').addClass("active")},e.prototype.updateDownloadLink=function(){var a=this;a.downloadUrl&&(a.downloadLink=$('<a><span class="icon-download"></span> Download map</a>').addClass("map-download-link").attr("href",a.downloadUrl).attr("target","_blank"),a.footer.append(a.downloadLink))},e.prototype.updateFooter=function(){if(this.footer&&(this.footer.remove(),this.footer=null),this.map){var a=this.scale||1;this.footer=$("<div></div>").addClass("map-footer").attr("data-cm-footer","");var b=Math.min(this.footerFontSize/a,this.maxFontSizeScale*this.footerFontSize);this.footer.css("font-size",b),this.footer.append($('<div><span class="icon-construction"></span><span> denotes an item under construction, which may not yet contain a full range of content.</span></div>')),this.footer.append($('<div><span class="icon-forbidden"></span> denotes an item not yet ready for viewing.</div>')),this.mapContainer.append(this.footer)}};var f=function(a,b){if("Public"==a)return!0;if(!b||!b.username||!b.verified)return!1;switch(a){case"ChampionReview":return b.roles.indexOf("Champion")>=0||b.roles.indexOf("AcademicReviewer")>=0||b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0;case"AcademicReview":return b.roles.indexOf("AcademicReviewer")>=0||b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0;default:return b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0}};e.prototype.updateStations=function(){if(this.map){var a=this;a.stationElements.forEach(function(a){a.element.remove()}),a.stationElements=[],this.stations.forEach(function(b){if(null!=b.mapPositionX&&null!=b.mapPositionY){var c=b.mapTextMaxWidth||200,d=$("<div></div>").attr("data-cm-station",b.id),e=$("<a></a>").appendTo(d);d.css("display","block").css("position","absolute").css("left","0px").css("top","0px").css("max-width",c.toFixed(0)+"px"),e.text(b.title),"Public"==b.publishStatus?b.underConstructionWarning&&e.prepend('<span class="icon-construction"></span> '):e.prepend('<span class="icon-forbidden"></span> '),f(b.publishStatus,a.currentUser)?(e.attr("href","/"+b.friendlyId),e.click(function(a){$(this).hasClass("fade-out")&&a.preventDefault()})):e.addClass("disabled"),a.selectedStation===b.id&&(d.addClass("selected"),a.hasPanned||0==isNaN(b.mapPositionX)&&0==isNaN(b.mapPositionY)&&a.setCenter({x:b.mapPositionX,y:b.mapPositionY}));a.lines.filter(function(a){return a.stationIds.indexOf(b.id)>=0}).forEach(function(a){d.addClass(a.line.friendlyId)}),a.mapContainer.append(d),a.stationElements.push({element:d,station:b})}}),a.updateStationsLayout()}},e.prototype.updateStationsLayout=function(){var a=this;if(this.map){var b=this.scale||1,c=Math.min(this.fontSize/b,this.maxFontSizeScale*this.fontSize);this.stationElements.forEach(function(b,d){var e=b.station;if(null!=e.mapPositionX&&null!=e.mapPositionY){var f=b.element;f.css("font-size",c.toFixed(1)+"px");for(var g=e.mapPositionX,h=e.mapPositionY,i=e.mapTextAngle||0;i<0;)i+=360;for(;i>=360;)i-=360;var j=f.outerWidth(),k=f.outerHeight(),l=10,m="left",n=10;if(i>=90&&i<270&&(m="right"),(Math.abs(i-90)<=n/2||Math.abs(i-270)<=n/2)&&(m="center"),f.css("text-align",m),i>=45&&i<135)h-=k+l,g-=(i-45)/90*j;else if(i>=135&&i<225)g-=j+l,h-=(225-i)/90*k;else if(i>=225&&i<315)g-=(315-i)/90*j,h+=l;else{var o=i<=45?i+360:i;g+=l,h-=(o-315)/90*k}i>=90&&i<270&&(m="right"),(Math.abs(i-90)<=n/2||Math.abs(i-270)<=n/2)&&(m="center"),f.css("left",g.toFixed(1)+"px").css("top",h.toFixed(1)+"px"),a.selectedStation===e.id&&(f.addClass("selected"),a.hasPanned||0==isNaN(e.mapPositionX)&&0==isNaN(e.mapPositionY)&&a.setCenter({x:e.mapPositionX,y:e.mapPositionY}))}})}},e.prototype.updatePervasiveIdeas=function(){if(this.map){var b=this,c=this.map.find("#map-pervasive-ideas");if(0!=c.length){if(b.pervasiveIdeaElements.forEach(function(a){a.element.remove(),a.spoke.remove()}),b.pervasiveIdeaElements=[],this.pervasiveIdeas.forEach(function(d,e){var g=$("<div></div>").addClass("map-pervasive-idea"),h=$("<a></a>").attr("data-cm-pervasive-idea-toggle",d.friendlyId).appendTo(g),i=b.pervasiveIdeasCenter.x,j=b.pervasiveIdeasCenter.y,k=Math.PI/2-2*Math.PI/b.pervasiveIdeas.length*e;k<0&&(k+=2*Math.PI),i+=b.pervasiveIdeasRadius*Math.cos(k),j-=b.pervasiveIdeasRadius*Math.sin(k),g.css("display","block").css("position","absolute").css("left",i.toFixed(1)+"px").css("top",j.toFixed(1)+"px"),h.text(d.title),h.click(function(a){$(this).hasClass("fade-out")&&a.preventDefault()}),"Public"==d.publishStatus?d.underConstructionWarning&&h.prepend('<span class="icon-construction"></span> '):h.prepend('<span class="icon-forbidden"></span> '),f(d.publishStatus,b.currentUser)?h.attr("tabindex","0").attr("href","/pervasive-ideas/"+d.friendlyId):h.addClass("disabled"),b.mapContainer.append(g);var l=document.createElementNS(a,"line");l.setAttributeNS(null,"x1",b.pervasiveIdeasCenter.x.toFixed(1)),l.setAttributeNS(null,"y1",b.pervasiveIdeasCenter.y.toFixed(1)),l.setAttributeNS(null,"x2",i.toFixed(1)),l.setAttributeNS(null,"y2",j.toFixed(1)),l.setAttributeNS(null,"stroke","#00bfb5"),l.setAttributeNS(null,"stroke-width",5..toFixed(1)),l.setAttributeNS(null,"data-cm-pervasive-idea-spoke",""),c.append(l),b.pervasiveIdeaElements.push({element:g,spoke:l,pervasiveIdea:d})}),!b.pervasiveIdeasHeading){var d=$("<div></div>").addClass("map-pervasive-ideas-heading");d.text("Pervasive Ideas"),d.prepend('<span class="icon-pervasive-idea"></span> ');var e=b.pervasiveIdeasCenter.x-90,g=b.pervasiveIdeasCenter.y-b.pervasiveIdeasRadius-30;d.css("display","block").css("position","absolute").css("left",e.toFixed(1)+"px").css("top",g.toFixed(1)+"px"),d.appendTo(b.mapContainer),b.pervasiveIdeasHeading=d}if(!b.pervasiveIdeaExplanationLink){var d=$("<div></div>").addClass("map-pervasive-idea-explanation"),h=$('<a tabindex="0"></a>').attr("data-cm-pervasive-idea-explanation-toggle","").appendTo(d),e=b.pervasiveIdeasCenter.x-90,g=b.pervasiveIdeasCenter.y+b.pervasiveIdeasRadius+30;d.css("display","block").css("position","absolute").css("left",e.toFixed(1)+"px").css("top",g.toFixed(1)+"px"),h.html('<span class="icon-question"></span> What are pervasive ideas?'),d.appendTo(b.mapContainer),b.pervasiveIdeaExplanationLink=d}b.updatePervasiveIdeasLayout()}}},e.prototype.updatePervasiveIdeasLayout=function(){var a=this;if(this.map){var b=this.scale||1,c=Math.min(this.fontSize/b,this.maxFontSizeScale*this.fontSize);if(this.pervasiveIdeaElements.forEach(function(b,d){var e=(b.pervasiveIdea,b.element);e.css("font-size",c.toFixed(1)+"px");var f=a.pervasiveIdeasCenter.x,g=a.pervasiveIdeasCenter.y,h=Math.PI/2-2*Math.PI/a.pervasiveIdeas.length*d;h<0&&(h+=2*Math.PI),f+=(a.pervasiveIdeasRadius+5)*Math.cos(h),g-=(a.pervasiveIdeasRadius+5)*Math.sin(h);var i=Math.PI/16,j=e.outerWidth(),k=e.outerHeight();h<Math.PI/2+i&&h>Math.PI/2-i?(g-=k,f-=j/2):h<i||h>2*Math.PI-i?g-=k/2:h<3*Math.PI/2+i&&h>3*Math.PI/2-i?f-=j/2:h<Math.PI+i&&h>Math.PI-i?(f-=j,g-=k/2):h<=Math.PI/2&&h>=0?g-=k:h>=3*Math.PI/2||(h<=3*Math.PI/2&&h>=Math.PI?f-=j:h<=Math.PI&&h>=Math.PI/2&&(f-=j,g-=k)),e.css("left",f.toFixed(1)+"px").css("top",g.toFixed(1)+"px")}),a.pervasiveIdeasHeading){var d=Math.min(this.headingFontSize/b,this.maxFontSizeScale*this.headingFontSize);a.pervasiveIdeasHeading.css("font-size",d.toFixed(1)+"px");var e=a.pervasiveIdeasCenter.x-a.pervasiveIdeasHeading.outerWidth()/2,f=a.pervasiveIdeasCenter.y-a.pervasiveIdeasRadius-30-a.pervasiveIdeasHeading.outerHeight();a.pervasiveIdeasHeading.css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px")}if(a.pervasiveIdeaExplanationLink){var g=Math.min(this.smallFontSize/b,this.maxFontSizeScale*this.smallFontSize);a.pervasiveIdeaExplanationLink.css("font-size",g.toFixed(1)+"px");var e=a.pervasiveIdeasCenter.x-a.pervasiveIdeaExplanationLink.outerWidth()/2,f=a.pervasiveIdeasCenter.y+a.pervasiveIdeasRadius+30;a.pervasiveIdeaExplanationLink.css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px")}}},e.prototype.clearSelectedLine=function(){if(this.map){var a;a=this.map.find('[class^="line"], [class*=" line"]'),a.each(function(a,b){d(b,"fade-out")}),a=this.mapContainer.find("[data-cm-station]"),a.each(function(a,b){$(b).removeClass("fade-out")}),this.selectedLine=null,this.updateLineButtonsActive()}},e.prototype.setSelectedLine=function(a){var b=this;if(this.map){if(!a)return void this.clearSelectedLine();var e=b.lines.filter(function(b){return b.line.id==a});if(0!=e.length){var f,g=e[0].line;f=this.map.find('[class^="line"], [class*=" line"]'),f.each(function(a,b){c(b,"fade-out")}),f=this.mapContainer.find("[data-cm-station]"),f.each(function(a,b){$(b).addClass("fade-out")}),f=this.map.find('[class^="'+g.friendlyId+'"], [class*=" '+g.friendlyId+'"]'),f.each(function(a,b){d(b,"fade-out")}),f=this.mapContainer.children("."+g.friendlyId),f.each(function(a,b){d(b,"fade-out")}),this.selectedLine=a,this.updateLineButtonsActive()}}},window.Map=e}(),function(){angular.module("MathematicalClassroomCore",["cmCore"]).run(["$rootScope","$timeout",function(a,b){a.mathematicalClassroomRootViewModel={headerMenuItemSelected:null,menuOpen:!1};var c=null,d=function(b){var d=$("#mathematical-classroom-header");c&&$(c).closest(d).length>0||b&&b.closest(d).length>0||(a.mathematicalClassroomRootViewModel.menuOpen=!1)};$("body").on("mousedown touchstart",function(a){c=a.target}),$("body").on("mouseup touchend",function(b){a.$apply(function(){d($(b.target))})})}])}(),function(){var a="http://www.w3.org/2000/svg",b=function(b){var c=this;this.center=null,this.pervasiveIdeas=[],this.pervasiveIdeasRadius=68,this.pervasiveIdeasCenter={x:this.pervasiveIdeasRadius+90,y:this.pervasiveIdeasRadius+50},this.nativeDimensions={width:2*this.pervasiveIdeasRadius+180,height:2*this.pervasiveIdeasRadius+100},this.pervasiveIdeaElements=[],this.fontSize=14,this.smallFontSize=13,this.headingFontSize=18,this.pervasiveIdeaExplanationLink=null,this.pervasiveIdeasHeading=null,this.loadedPervasiveIdeas=!1,this.outerContainer=$(b),this.container=$("<div></div>").css("position","relative").css("width",this.nativeDimensions.width+"px").css("height",this.nativeDimensions.height+"px").appendTo(this.outerContainer),this.wheel=document.createElementNS(a,"svg"),this.wheel.setAttributeNS(null,"viewBox","0 0 "+this.nativeDimensions.width+" "+this.nativeDimensions.height),$(this.wheel).css("position","absolute").css("width",this.nativeDimensions.width+"px").css("height",this.nativeDimensions.height+"px").css("left",0).css("top",0).appendTo(this.container);var d=document.createElementNS(a,"circle");$(this.wheel).append(d),d.outerHTML='<circle style="fill:none;stroke:#00bfb5;stroke-width:9.38879967" r="64.400002" cy="'+this.pervasiveIdeasCenter.y+'" cx="'+this.pervasiveIdeasCenter.x+'"></circle>',d=document.createElementNS(a,"circle"),$(this.wheel).append(d),d.outerHTML='<circle style="fill:#00bfb5;" r="11.8" cy="'+this.pervasiveIdeasCenter.y+'" cx="'+this.pervasiveIdeasCenter.x+'"></circle>',this.currentUser=null,this.getCurrentUser=function(){$.getJSON("/account/api/users/current",function(a){a&&a.username?c.currentUser=a:c.currentUser=null}).fail(function(){c.currentUser=null}).always(function(){c.loadedUser=!0,c.updateIfLoaded()})},this.getCurrentUser(),$.getJSON("/api/pervasive-ideas",function(a){a&&Array.isArray(a)&&(c.pervasiveIdeas=a)}).always(function(){c.loadedPervasiveIdeas=!0,c.updateIfLoaded()})};b.prototype.updateIfLoaded=function(){var a=this;a.loadedUser&&a.loadedPervasiveIdeas&&a.update()},b.prototype.update=function(){var a=this;a.updatePervasiveIdeas(),a.updateLayout()},b.prototype.updateLayout=function(){this.updatePervasiveIdeasLayout()},b.prototype.getNativeDimensions=function(){return this.nativeDimensions};var c=function(a,b){if("Public"==a)return!0;if(!b||!b.username||!b.verified)return!1;switch(a){case"ChampionReview":return b.roles.indexOf("Champion")>=0||b.roles.indexOf("AcademicReviewer")>=0||b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0;case"AcademicReview":return b.roles.indexOf("AcademicReviewer")>=0||b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0;default:return b.roles.indexOf("InternalReviewer")>=0||b.roles.indexOf("AssistantAuthor")>=0||b.roles.indexOf("Author")>=0||b.roles.indexOf("Webmaster")>=0}};b.prototype.updatePervasiveIdeas=function(){if(this.wheel){var b=this;if(b.pervasiveIdeaElements.forEach(function(a){a.element.remove(),a.spoke.remove()}),b.pervasiveIdeaElements=[],this.pervasiveIdeas.forEach(function(d,e){var f=$("<div></div>").addClass("pervaisve-ideas-wheel-pervasive-idea"),g=$("<a></a>").attr("data-cm-pervasive-idea-toggle",d.friendlyId).appendTo(f),h=b.pervasiveIdeasCenter.x,i=b.pervasiveIdeasCenter.y,j=Math.PI/2-2*Math.PI/b.pervasiveIdeas.length*e;j<0&&(j+=2*Math.PI),h+=b.pervasiveIdeasRadius*Math.cos(j),i-=b.pervasiveIdeasRadius*Math.sin(j),f.css("display","block").css("position","absolute").css("left",h.toFixed(1)+"px").css("top",i.toFixed(1)+"px"),g.text(d.title),g.click(function(a){$(this).hasClass("fade-out")&&a.preventDefault()}),"Public"==d.publishStatus?d.underConstructionWarning&&g.prepend('<span class="icon-construction"></span> '):g.prepend('<span class="icon-forbidden"></span> '),c(d.publishStatus,b.currentUser)?g.attr("tabindex","0").attr("href","/pervasive-ideas/"+d.friendlyId):g.addClass("disabled"),b.container.append(f);var k=document.createElementNS(a,"line");k.setAttributeNS(null,"x1",b.pervasiveIdeasCenter.x.toFixed(1)),k.setAttributeNS(null,"y1",b.pervasiveIdeasCenter.y.toFixed(1)),k.setAttributeNS(null,"x2",h.toFixed(1)),k.setAttributeNS(null,"y2",i.toFixed(1)),k.setAttributeNS(null,"stroke","#00bfb5"),k.setAttributeNS(null,"stroke-width",5..toFixed(1)),k.setAttributeNS(null,"data-cm-pervasive-idea-spoke",""),$(b.wheel).append(k),b.pervasiveIdeaElements.push({element:f,spoke:k,pervasiveIdea:d})}),!b.pervasiveIdeasHeading){var d=$("<div></div>").addClass("pervasive-ideas-wheel-pervasive-ideas-heading");d.text("Pervasive Ideas"),d.prepend('<span class="icon-pervasive-idea"></span> ');var e=b.pervasiveIdeasCenter.x-90,f=b.pervasiveIdeasCenter.y-b.pervasiveIdeasRadius-30;d.css("display","block").css("position","absolute").css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px"),d.appendTo(b.container),b.pervasiveIdeasHeading=d}if(!b.pervasiveIdeaExplanationLink){var d=$("<div></div>").addClass("pervasive-ideas-wheel-pervasive-idea-explanation"),g=$('<a tabindex="0"></a>').attr("data-cm-pervasive-idea-explanation-toggle","").appendTo(d),e=b.pervasiveIdeasCenter.x-90,f=b.pervasiveIdeasCenter.y+b.pervasiveIdeasRadius+30;d.css("display","block").css("position","absolute").css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px"),g.html('<span class="icon-question"></span> What are pervasive ideas?'),d.appendTo(b.container),b.pervasiveIdeaExplanationLink=d}b.updatePervasiveIdeasLayout()}},b.prototype.updatePervasiveIdeasLayout=function(){var a=this;if(this.wheel){var b=this.scale||1,c=Math.min(this.fontSize/b,this.maxFontSizeScale*this.fontSize);if(this.pervasiveIdeaElements.forEach(function(b,d){var e=(b.pervasiveIdea,b.element);e.css("font-size",c.toFixed(1)+"px");var f=a.pervasiveIdeasCenter.x,g=a.pervasiveIdeasCenter.y,h=Math.PI/2-2*Math.PI/a.pervasiveIdeas.length*d;h<0&&(h+=2*Math.PI),f+=(a.pervasiveIdeasRadius+5)*Math.cos(h),g-=(a.pervasiveIdeasRadius+5)*Math.sin(h);var i=Math.PI/16,j=e.outerWidth(),k=e.outerHeight();h<Math.PI/2+i&&h>Math.PI/2-i?(g-=k,f-=j/2):h<i||h>2*Math.PI-i?g-=k/2:h<3*Math.PI/2+i&&h>3*Math.PI/2-i?f-=j/2:h<Math.PI+i&&h>Math.PI-i?(f-=j,g-=k/2):h<=Math.PI/2&&h>=0?g-=k:h>=3*Math.PI/2||(h<=3*Math.PI/2&&h>=Math.PI?f-=j:h<=Math.PI&&h>=Math.PI/2&&(f-=j,g-=k)),e.css("left",f.toFixed(1)+"px").css("top",g.toFixed(1)+"px")}),a.pervasiveIdeasHeading){var d=Math.min(this.headingFontSize/b,this.maxFontSizeScale*this.headingFontSize);a.pervasiveIdeasHeading.css("font-size",d.toFixed(1)+"px");var e=a.pervasiveIdeasCenter.x-a.pervasiveIdeasHeading.outerWidth()/2,f=a.pervasiveIdeasCenter.y-a.pervasiveIdeasRadius-30-a.pervasiveIdeasHeading.outerHeight();a.pervasiveIdeasHeading.css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px")}if(a.pervasiveIdeaExplanationLink){var g=Math.min(this.smallFontSize/b,this.maxFontSizeScale*this.smallFontSize);a.pervasiveIdeaExplanationLink.css("font-size",g.toFixed(1)+"px");var e=a.pervasiveIdeasCenter.x-a.pervasiveIdeaExplanationLink.outerWidth()/2,f=a.pervasiveIdeasCenter.y+a.pervasiveIdeasRadius+30;a.pervasiveIdeaExplanationLink.css("left",e.toFixed(1)+"px").css("top",f.toFixed(1)+"px")}}},window.PervasiveIdeasWheel=b}(),function(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker",{scope:"/"}).then(function(a){}).catch(function(a){})}(),function(){var a=window.cmSite||{},b=function(){window.twttr&&twttr.events.bind("rendered",function(a){if(a.target){$(a.target).contents().find("head").append($("<link/>",{rel:"stylesheet",href:"/static/css/twitter.min.css"}))}})};a.loadTwitter=function(){$.getScript("https://platform.twitter.com/widgets.js",function(){b()})},$(document).ready(function(){$("[data-widget-id]").length>0&&a.loadTwitter()})}();