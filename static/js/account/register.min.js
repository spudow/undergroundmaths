!function(){angular.module("cmAccountRegister",["cmCore"]).controller("RegisterController",["$scope","Auth","User","UserAccount","UserType",function(a,b,c,d,e){if(a.currentUser.isLoggedIn())return void(location.href="/user?message=LogoutRequired");a.viewModel={},a.viewModel.registerFormTemplate=cmHelper.templateBaseUrl+"/account/register-form.html",a.viewModel.userTypes=e.query(),a.user=new c,a.user.receiveNewsletter=!1,a.viewModel.errors=[],a.viewModel.savingRegistration=!1;var f=function(){var a=Math.floor(10*Math.random()+1),b=Math.floor(10*Math.random()+1),c=Math.floor(3*Math.random()),d="Plus";return 1==c?d="Times":2==c&&(d="Minus"),{num1:a,num2:b,type:d}};a.user.antiSpamQuestion=f(),a.getAntiSpamQuestionText=function(a){return a?a.num1.toString()+" "+a.type.toLowerCase()+" "+a.num2.toString()+" is":""},a.clearErrors=function(){a.viewModel.errors=[]},a.onSchoolSelect=function(b){a.user.school=b.value},a.register=function(){a.clearErrors(),a.viewModel.registerForm.$valid&&!a.viewModel.savingRegistration&&(a.viewModel.savingRegistration=!0,a.user.createdDate=new Date,a.user.$save(function(){d.logIn({username:a.user.username,password:a.user.newPassword},function(c){a.viewModel.savingRegistration=!1,b.setCurrentUser(c.userIdentity),location.href="/user?message=AccountCreated"},function(){a.viewModel.savingRegistration=!1})},function(b){a.viewModel.savingRegistration=!1,b.data&&b.data.errorMessages?a.viewModel.errors=b.data.errorMessages:a.viewModel.errors=["An error occured whilst trying to create the user account."]}))}}])}();