!function(){var a=angular.module("cmBlog",["MathematicalClassroomCore","cmCommenter"]);a.controller("BlogController",["$scope","$timeout","$location","$sce","TeacherPerspective","PublishStatus","User","Auth",function(a,b,c,d,e,f,g,h){var i=cmHelper.getUrlParameters("/blog",["friendlyId"]);a.viewModel={},a.mathematicalClassroomRootViewModel.headerMenuItemSelected="TeacherPerspective",a.viewModel.publishStatuses=f.query(),a.getPublishStatus=function(b){var c=a.viewModel.publishStatuses.filter(function(a){return a.value==b});return c.length>0?c[0]:null},a.viewModel.loaded=!1,a.viewModel.teacherPerspectiveList=[],a.viewModel.stationIdSelected=null,a.viewModel.resourceTypeIdSelected=null,a.viewModel.categoryIdSelected=null,a.viewModel.pageSize=10,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.initalized=!1,a.viewModel.getCurrentRow=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b},a.viewModel.pageChange=function(){a.getTeacherPerspectives()},a.getTeacherPerspectives=function(c){c&&(a.viewModel.currentPage=0),a.viewModel.initalized=!0;var d=i.friendlyId&&!a.viewModel.loaded?i.friendlyId:void 0,f={startRow:a.viewModel.getCurrentRow(),maxRows:a.viewModel.pageSize,category:a.viewModel.categoryIdSelected,station:a.viewModel.stationIdSelected,resourceType:a.viewModel.resourceTypeIdSelected,selected:d};e.queryConverted(f,function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.currentPage=Math.floor(c.startRow/a.viewModel.pageSize);var d=c.results;a.viewModel.teacherPerspectiveList=d,b(function(){cmSite.processContent(),$("[data-cm-teacher-perspective-media] video").each(function(){cmElementsHelper.addCustomVideoControls(this)})}),a.viewModel.loaded=!0},function(){a.viewModel.loaded=!0})};var j=!1;a.$watch("viewModel.categoryIdSelected",function(c,d){c!=d&&(j=!0,a.getStations(),a.getResourceTypes(),a.viewModel.categoryIdSelected||(a.viewModel.resourceTypeIdSelected=null,a.viewModel.stationIdSelected=null),a.getTeacherPerspectives(!0),b(function(){j=!1}))}),a.$watch("viewModel.stationIdSelected",function(b,c){b==c||j||a.getTeacherPerspectives(!0)}),a.$watch("viewModel.resourceTypeIdSelected",function(b,c){b==c||j||a.getTeacherPerspectives(!0)}),a.teacherPerspectiveOnPlay=function(a){},a.teacherPerspectiveOnPause=function(a){},a.viewModel.initialized||a.getTeacherPerspectives(),a.getComputedContent=function(a){var b=$("<div></div>");b.html(a.convertedContent);var c=a.teacherPerspective.description||b.text()||"",d=a.teacherPerspective.image?180:240;return c.length<=d?c.substr(0,d):c.substr(0,d-3)+"..."},a.getCategories=function(){a.viewModel.categories=e.getCategories()},a.getStations=function(){a.viewModel.stations=e.getStations({category:a.viewModel.categoryIdSelected})},a.getResourceTypes=function(){a.viewModel.resourceTypes=e.getResourceTypes({category:a.viewModel.categoryIdSelected})},a.getCategories(),a.getStations(),a.getResourceTypes(),a.canEditTeacherPerspective=function(b){return a.currentUser.isInAnyRole(["Webmaster","Author","ChampionManager"])||b.userId==a.currentUser.userId&&["Unpublished","AuthorReview"].indexOf(b.publishStatus)>=0},a.getTeacherPerspectiveIdentifier=function(a){return cmHelper.getIdentifierStringFriendly("teacher-perspective",a)},a.scrollToElement=function(a,b){var c=$(a);if(0!=c.length){var d=c.offset().top-70,e=$(document).scrollTop();"up"==b&&d>e||"down"==b&&d<e||$("html, body").animate({scrollTop:d},300)}},a.viewModel.errors=[],a.clearErrors=function(){a.viewModel.errors=[]},a.viewModel.userEmailAlerts=!1,a.viewModel.user=null,a.viewModel.emailAlertInitialized=!1,a.getEmailAlerts=function(){if(!a.currentUser.userId)return void(a.viewModel.emailAlertInitialized=!0);g.get({id:a.currentUser.userId},function(c){if(a.viewModel.user=c,a.viewModel.userEmailAlerts=c.blogAlerts,b(function(){a.viewModel.emailAlertInitialized=!0}),sessionStorage["blog.loadAction"]){var d=null;try{d=JSON.parse(sessionStorage["blog.loadAction"])}catch(e){}if(cmHelper.setSessionStorage("blog.loadAction",null),"CreateEmailAlert"==d){if(a.viewModel.userEmailAlerts)return;a.viewModel.userEmailAlerts=!0,a.updateEmailAlerts()}}},function(c){b(function(){a.viewModel.emailAlertInitialized=!0})})},a.getEmailAlerts(),a.updateEmailAlerts=function(){if(a.clearErrors(),!a.viewModel.user)return cmHelper.setSessionStorage("blog.loadAction",JSON.stringify("CreateEmailAlert")),void a.promptLogin();a.viewModel.user.blogAlerts=a.viewModel.userEmailAlerts,g.update({id:a.viewModel.user.id},a.viewModel.user,function(b){a.viewModel.user=b},function(b){if(b.data&&b.data.errorMessages){if("LoginRequired"==b.data.errorType)return void h.confirmLogin(a.createEmailAlert,function(){a.viewModel.errors=b.data.errorMessages});a.viewModel.errors=b.data.errorMessages}else a.viewModel.errors=["An error occured whilst trying to "+(a.viewModel.userEmailAlerts?"create":"delete")+" the email alert."]})},a.$watch("viewModel.userEmailAlerts",function(b,c){c!=b&&a.viewModel.emailAlertInitialized&&a.updateEmailAlerts()}),a.viewModel.bioModal=null,a.showBio=function(c){if(c.bioConvertedContent){var d=a.viewModel.bioModal;d&&d.remove();var e={};e.teacherPerspective=c;var f=new CmModal;a.viewModel.bioModal=f,f.setContentLoading(),f.show(),$.get("/static/spa-templates/public/blog/bio-modal.html",function(a){var c=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,d){var g=a.$new();g.viewModel=e,d(c)(g),f.setContent(c[0]),b(function(){})}])})}}}]),a.controller("BlogEntryController",["$scope","$timeout","$location","$sce","TeacherPerspective","PublishStatus","Auth",function(a,b,c,d,e,f,g){var h=cmHelper.getUrlParameters("/blog",["friendlyId"]);a.viewModel={},a.mathematicalClassroomRootViewModel.headerMenuItemSelected="TeacherPerspective",a.viewModel.publishStatuses=f.query(),a.getPublishStatus=function(b){var c=a.viewModel.publishStatuses.filter(function(a){return a.value==b});return c.length>0?c[0]:null},a.viewModel.loaded=!1,a.viewModel.initalized=!1,a.viewModel.teacherPerspective=null,a.getTeacherPerspective=function(){a.viewModel.initalized=!0,e.getConverted({friendlyId:h.friendlyId},function(c){a.viewModel.teacherPerspective=c,a.viewModel.teacherPerspective.bioConvertedContent&&(a.viewModel.teacherPerspective.bioConvertedContent=d.trustAsHtml(a.viewModel.teacherPerspective.bioConvertedContent)),a.viewModel.teacherPerspective.resource&&a.viewModel.teacherPerspective.resource.description&&(a.viewModel.teacherPerspective.resource.description=d.trustAsHtml(cmHelper.convertMarkdownLineToHtml(a.viewModel.teacherPerspective.resource.description))),b(function(){cmSite.processContent(),$("[data-cm-teacher-perspective-media] video").each(function(){cmElementsHelper.addCustomVideoControls(this)})}),a.viewModel.loaded=!0},function(){a.viewModel.loaded=!0})},a.getTeacherPerspective(),a.teacherPerspectiveOnPlay=function(a){},a.teacherPerspectiveOnPause=function(a){},a.getComputedContent=function(a){return a?d.trustAsHtml(a.convertedContent):null},a.canEditTeacherPerspective=function(b){return!!b&&(a.currentUser.isInAnyRole(["Webmaster","Author","ChampionManager"])||b.userId==a.currentUser.userId&&["Unpublished","AuthorReview"].indexOf(b.publishStatus)>=0)},a.getTeacherPerspectiveIdentifier=function(a){return a?cmHelper.getIdentifierStringFriendly("teacher-perspective",a):null},a.viewModel.bioModal=null,a.showBio=function(c){if(c.bioConvertedContent){var d=a.viewModel.bioModal;if(d)return void d.show();var e={};e.teacherPerspective=c;var f=new CmModal;a.viewModel.bioModal=f,f.setContentLoading(),f.show(),$.get("/static/spa-templates/public/blog/bio-modal.html",function(a){var c=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,d){var g=a.$new();g.viewModel=e,d(c)(g),f.setContent(c[0]),b(function(){})}])})}}}])}();