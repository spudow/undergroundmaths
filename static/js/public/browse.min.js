!function(){angular.module("cmBrowse",["cmCore"]).controller("BrowseController",["$scope","$timeout","$location","Resource","ResourceType","ReviewQuestionType","Line","Station","LineStation","PervasiveIdea","Glossary","Bundle","Auth",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.viewModel=a.viewModel||{};var n=!1;a.viewModel.pageSize=25,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.typeOption=null,a.viewModel.resourceTypeIdSelected=null,a.viewModel.reviewQuestionTypeIdSelected=null,a.viewModel.lineIdSelected=null,a.viewModel.stationIdSelected=null,a.viewModel.resourceList=[],a.viewModel.lineStations=[],a.viewModel.lines=[],a.viewModel.stations=[],a.viewModel.pervasiveIdeas=j.query(),a.viewModel.stationList=[],a.viewModel.glossaryList=[],a.viewModel.bundles=[];for(var o="abcdefghijklmnopqrstuvwxyz",p=[],q=0;q<o.length;q++)p.push(o.substr(q,1));a.viewModel.letters=p,a.viewModel.letterSelected=null,a.viewModel.otherResourceTypes=[],a.viewModel.browseComponent=cmHelper.templateBaseUrl+"/browse-component.html",a.viewModel.resourceTypes=e.query(function(){a.viewModel.otherResourceTypes=a.viewModel.resourceTypes.filter(function(a){return"review-question"!=a.friendlyId&&a.description})}),a.viewModel.reviewQuestionTypes=f.query();var r=function(){var b=c.search();b.typeOption&&(a.viewModel.typeOption=b.typeOption),b.resourceType&&"RichResource"==a.viewModel.typeOption&&(a.viewModel.resourceTypeIdSelected=Number(b.resourceType)),b.reviewQuestionType&&"ReviewQuestion"==a.viewModel.typeOption&&(a.viewModel.reviewQuestionTypeIdSelected=Number(b.reviewQuestionType)),b.line&&(a.viewModel.lineIdSelected=Number(b.line)),b.station&&(a.viewModel.stationIdSelected=Number(b.station)),b.letter&&"Glossary"==a.viewModel.typeOption&&(a.viewModel.letterSelected=b.letter),b.startRow&&(a.viewModel.currentPage=Math.floor(Number(b.startRow)/a.viewModel.pageSize))};r(),a.updateStationLines=function(){var b=[];a.viewModel.stations.forEach(function(c){var d={station:c};b.push(d);var e=a.viewModel.lineStations.filter(function(a){return a.stationId==c.id}),f=e.map(function(b){var c=a.viewModel.lines.filter(function(a){return a.id==b.lineId});return c.length>0?c[0]:null});d.lines=f.filter(function(a){return null!=a})}),a.viewModel.stationList=b},a.viewModel.lines=g.query(function(){a.updateStationLines()}),a.viewModel.lineStations=i.query(function(){a.updateStationLines()}),a.viewModel.stations=h.query(function(){a.updateStationLines()}),a.filterStations=function(){return a.viewModel.stationList.filter(function(b){return!a.viewModel.lineIdSelected||b.lines.filter(function(b){return b.id==a.viewModel.lineIdSelected}).length>0})},a.toggleTypeOption=function(b){if(a.viewModel.typeOption==b)return void(a.viewModel.typeOption=null);a.viewModel.typeOption=b};var s=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b};a.getBrowseList=function(){n=!0,a.getResourceList(),a.getGlossaryList(),a.getBundleList()},a.getResourceList=function(){if("RichResource"!=a.viewModel.typeOption&&"ReviewQuestion"!=a.viewModel.typeOption)return void(a.viewModel.resourceList=[]);a.viewModel.searching=!0,a.viewModel.pageSize=25,d.getList({startRow:s(),maxRows:a.viewModel.pageSize,typeOption:a.viewModel.typeOption,resourceType:a.viewModel.resourceTypeIdSelected,reviewQuestionType:a.viewModel.reviewQuestionTypeIdSelected,line:a.viewModel.lineIdSelected,station:a.viewModel.stationIdSelected},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.resourceList=c.results,a.viewModel.searching=!1,b(function(){cmSite.processContent()})},function(){a.viewModel.searching=!1})},a.getGlossaryList=function(){if("Glossary"!=a.viewModel.typeOption)return void(a.viewModel.glossaryList=[]);a.viewModel.searching=!0,a.viewModel.pageSize=50,k.query({startRow:s(),maxRows:a.viewModel.pageSize,query:a.viewModel.letterSelected,queryType:"MatchStart"},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.glossaryList=c.suggestions.map(function(a){return a.data}),a.viewModel.searching=!1,b(function(){cmSite.processContent()})},function(){a.viewModel.searching=!1})},a.getBundleList=function(){if("Bundle"!=a.viewModel.typeOption)return void(a.viewModel.bundles=[]);a.viewModel.searching=!0,a.viewModel.pageSize=25,l.query({startRow:s(),maxRows:a.viewModel.pageSize},function(c){a.viewModel.totalRows=c.totalRows,a.viewModel.bundles=c.results,a.viewModel.searching=!1,b(function(){cmSite.processContent()})},function(){a.viewModel.searching=!1})},a.$on("$locationChangeSuccess",function(){r(),a.getBrowseList()});var t=function(){var b="/browse?maxRows="+a.viewModel.pageSize+"&startRow="+s();a.viewModel.typeOption&&(b+="&typeOption="+a.viewModel.typeOption),a.viewModel.resourceTypeIdSelected&&"RichResource"==a.viewModel.typeOption&&(b+="&resourceType="+a.viewModel.resourceTypeIdSelected),a.viewModel.reviewQuestionTypeIdSelected&&"ReviewQuestion"==a.viewModel.typeOption&&(b+="&reviewQuestionType="+a.viewModel.reviewQuestionTypeIdSelected),a.viewModel.lineIdSelected&&(b+="&line="+a.viewModel.lineIdSelected),a.viewModel.stationIdSelected&&(b+="&station="+a.viewModel.stationIdSelected),a.viewModel.letterSelected&&(b+="&letter="+a.viewModel.letterSelected),c.url()!=b&&c.url(b)};a.pageChange=function(){n&&t()},a.$watch("viewModel.typeOption",function(b,c){b!=c&&(a.viewModel.currentPage=0,t(),"function"==typeof ga&&ga("send","event","Browse section","click",a.viewModel.typeOption))}),a.$watch("viewModel.resourceTypeIdSelected",function(b,c){b!=c&&(a.viewModel.currentPage=0,t())}),a.$watch("viewModel.reviewQuestionTypeIdSelected",function(b,c){b!=c&&(a.viewModel.currentPage=0,t())}),a.$watch("viewModel.lineIdSelected",function(b,c){b!=c&&(a.viewModel.currentPage=0,t())}),a.$watch("viewModel.stationIdSelected",function(b,c){b!=c&&(a.viewModel.currentPage=0,t())}),a.$watch("viewModel.letterSelected",function(b,c){b!=c&&(a.viewModel.currentPage=0,t())}),a.getRestrictedAccessWarningText=cmHelper.getRestrictedAccessWarningText,a.getUnderContructionWarningText=cmHelper.getUnderContructionWarningText,a.getResourceRefText=cmHelper.getResourceRefText,a.getInteractivityLabelString=function(a){return a.interactivityLabels&&0!=a.interactivityLabels.length?"Contains interactive elements - "+a.interactivityLabels.map(function(a){return a.name}).join(", "):null},n||a.getBrowseList()}])}();