!function(){var a=angular.module("cmBundle",["MathematicalClassroomCore"]);a.controller("BundleListController",["$scope","$timeout","Bundle","PublishStatus","Auth",function(a,b,c,d,e){if(a.viewModel={},a.mathematicalClassroomRootViewModel.headerMenuItemSelected="Bundles",a.viewModel.publishStatuses=d.query(),a.getPublishStatus=function(b){var c=a.viewModel.publishStatuses.filter(function(a){return a.value==b});return c.length>0?c[0]:null},a.viewModel.loaded=!1,a.viewModel.bundles=[],a.viewModel.pageSize=20,a.viewModel.totalRows=0,a.viewModel.currentPage=0,a.viewModel.initalized=!1,a.viewModel.getCurrentRow=function(){var b=a.viewModel.pageSize||0;return(a.viewModel.currentPage||0)*b},a.viewModel.pageChange=function(){cmHelper.setSessionStorage("bundles.currentPage",JSON.stringify(a.viewModel.currentPage)),a.getBundles()},a.$watch("viewModel.currentPage",function(){cmHelper.setSessionStorage("bundles.currentPage",JSON.stringify(a.viewModel.currentPage))}),a.getBundles=function(){a.viewModel.initalized=!0,c.queryDetail({startRow:a.viewModel.getCurrentRow(),maxRows:a.viewModel.pageSize},function(b){a.viewModel.bundles=b.results,a.viewModel.totalRows=b.totalRows,a.viewModel.loaded=!0},function(){a.viewModel.loaded=!0})},a.getBundleItemStyle=function(a){if(a.bannerImage){return'background-image:url("'+(cmHelper.isAbsoluteUrl(a.bannerImage)?a.bannerImage:"/bundles/"+a.friendlyId+"/"+a.bannerImage)+'");'}},sessionStorage["bundles.currentPage"])try{a.viewModel.currentPage=JSON.parse(sessionStorage["bundles.currentPage"])}catch(f){}a.viewModel.initialized||a.getBundles()}]),a.controller("BundleController",["$scope","$timeout","$sce","Bundle","BundleResource","BundleBundleEmphasis","Content","Webinar","Bookmark","BookmarkGroup","BookmarkGroupPair","Auth",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=cmHelper.getUrlParameters("/bundles",["friendlyId"]);a.viewModel={},a.mathematicalClassroomRootViewModel.headerMenuItemSelected="Bundles",a.viewModel.loaded=!1,a.viewModel.bundle=null,a.viewModel.bundleResources=[],a.viewModel.bundleEmphases=[],a.viewModel.identifier=null,a.viewModel.content=null,d.query({id:m.friendlyId},function(c){a.viewModel.bundle=c,e.queryBundleDetail({bundleId:c.id},function(c){a.viewModel.bundleResources=c,a.viewModel.loaded=!0,a.updateBundleResourceEmphases(),b(function(){cmSite.processContent()})},function(){a.viewModel.loaded=!0}),f.queryBundleDetail({bundleId:c.id},function(c){a.viewModel.bundleEmphases=c,a.updateBundleResourceEmphases(),a.updateContent(),b(function(){cmSite.processContent()})}),a.viewModel.identifier=cmHelper.getIdentifierStringFriendly("bundle",c.id),g.getConverted({identifier:a.viewModel.identifier},function(c){a.viewModel.content=c.content,a.updateContent(),b(function(){cmSite.processContent()})}),a.viewModel.bundle.relatedWebinarId&&h.get({id:a.viewModel.bundle.relatedWebinarId},function(b){a.viewModel.relatedWebinar=b})},function(){a.viewModel.loaded=!0}),a.getBundleResourceDescription=function(a){return a.convertedDescription?c.trustAsHtml(a.convertedDescription):a.resource.description?c.trustAsHtml(cmHelper.convertMarkdownLineToHtml(a.resource.description)):""},a.updateContent=function(){if(a.viewModel.whyContent=null,a.viewModel.howContent=null,a.viewModel.content){var b=$("<div></div>").html(a.viewModel.content),d=b.find('[data-cm-id="emphases"]');d.length>0&&d.append(a.getEmphasesListElement());var e=b.find('[data-cm-id="why"]');if(e.length>0){var f=e.html();f.trim()&&(a.viewModel.whyContent=c.trustAsHtml(f))}var g=b.find('[data-cm-id="how"]');if(g.length>0){var h=g.html();h.trim()&&(a.viewModel.howContent=c.trustAsHtml(h))}}},a.updateBundleResourceEmphases=function(){a.viewModel.bundleResources.forEach(function(b){b.emphasesDetail=a.viewModel.bundleEmphases.filter(function(a){return b.emphases.indexOf(a.bundleBundleEmphasis.id)>=0}).map(function(a){return a.bundleEmphasis})})},a.getEmphasesListElement=function(){var b=$('<ul class="bundle-emphases-list"></ul>');return a.viewModel.bundleEmphases.forEach(function(a){$("<li></li>").text(a.bundleEmphasis.text).appendTo(b)}),b},a.processUrl=function(a){return cmHelper.isAbsoluteUrl(a)?a:"/bundles/"+m.friendlyId+"/"+a},a.scrollToSection=function(a){var b=$("#"+a);0!=b.length&&$("html, body").animate({scrollTop:b.offset().top},300)},a.canBookmarkCurrentBundle=function(){return!!a.viewModel.bundle&&0==a.bookmarkManager.bookmarkGroups.filter(function(b){return b.name.toLowerCase()==a.viewModel.bundle.title.toLowerCase()}).length},a.isCurrentBundleBookmarked=function(){return!!a.viewModel.bundle&&a.bookmarkManager.bookmarkGroups.filter(function(b){return b.name.toLowerCase()==a.viewModel.bundle.title.toLowerCase()}).length>0},a.addBookmarkForCurrentBundle=function(){if(a.canBookmarkCurrentBundle()){if(!a.currentUser.isInAnyRole())return void CmModal.showAlert("Login required to add to resource collection",'You must <a tabindex="0" data-cm-prompt-login-toggle="">log in</a> or <a tabindex="0" data-cm-prompt-register-toggle="">register</a> to add this bundle to your collection.',null,!0);var b=a.viewModel.bundleResources.map(function(a){return a.bundleResource.resourceId}),c=b.map(function(b){var c=new i;return c.resourceId=b,c.userId=a.currentUser.userId,c.createdDate=new Date,c.updatedDate=new Date,c}),d=new j;d.userId=a.currentUser.userId,d.name=a.viewModel.bundle.title,d.updatedDate=new Date,d.$save(function(b){i.saveMany(c,function(c){var d=c.map(function(a,c){var d=new k;return d.bookmarkId=a.id,d.groupId=b.id,d.order=c+1,d});k.saveMany(d,function(){a.bookmarkManager.loadBookmarks()},function(){a.bookmarkManager.loadBookmarks()})},function(){a.bookmarkManager.loadBookmarks()})},function(a){})}},removeBookmarkForCurrentBundle=function(b){if(a.viewModel.bundle){var c=a.bookmarkManager.bookmarkGroups.filter(function(b){return b.name.toLowerCase()==a.viewModel.bundle.title.toLowerCase()});if(!(c.length<=0)){var d=c[0];j.remove({id:d.id,removeFully:!!b},null,function(b){a.bookmarkManager.loadBookmarks()},function(b){a.bookmarkManager.loadBookmarks()})}}},a.confirmRemoveBookmarkForCurrentBundle=function(){a.isCurrentBundleBookmarked()&&CmModal.showMultiOptionModal("Remove this bundle from your resource collection","You are about to delete the subcollection from your resource collection corresponding to this bundle. Do you want to keep the resources in your collection?",[{label:"Yes",buttonClass:"cm-button-submit",callback:function(){removeBookmarkForCurrentBundle(!1)}},{label:"No",buttonClass:"cm-button-warning",callback:function(){removeBookmarkForCurrentBundle(!0)}},{label:"Cancel",buttonClass:"cm-button-cancel"}])}}])}();