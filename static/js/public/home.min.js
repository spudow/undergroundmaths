!function(){angular.module("cmHome",["cmCore"]).controller("HomeController",["$scope","$timeout","$sce","$filter","NewsItem","Event","RecentUpdate","Comment","Analytics","ResourceType","Auth",function(a,b,c,d,e,f,g,h,i,j,k){a.viewModel={},a.viewModel.showSimpleView=!1,a.viewModel.howToItemSelected="Overview",a.scrollToSection=function(a){var b=$("#"+a);0!=b.length&&$("html, body").animate({scrollTop:b.offset().top-40},300)},a.resizeMapContainer=function(){if(a.map){var b=0,c=$("#home-map-container"),d=c.parent().width(),e=$(window).height()-110-c.parent().offset().top,f=(a.map.getNativeDimensions(),1.15),g=1.3,b=0,h=0,i=0,j=d-2*i;h=j,h>850?(h>950&&(h=950),b=h/g):b=h/f,b>e&&(b=Math.max(h/g,e)),b>e&&(b=e>550?e:Math.min(b,550),h=Math.min(b*g,j)),b<300&&(b=Math.min(300,h/f));var k=5,l=Math.max(.02*b,k),m=Math.max(.02*b,k),n=Math.max(.02*h,k),o=Math.max(.02*h,k);c.css("height",b+"px").css("width",h+"px").css("padding",l+"px "+o+"px "+m+"px "+n+"px")}},a.repositionTopDownArrow=function(){var a=$("#home-header-and-top-wrapper").outerHeight(),b=$(window).height(),c=$(window).scrollTop(),d=Math.min(a,b+c);d<300&&(d=a);var e=a-d;$("#home-top-down-arrow-wrapper").css("bottom",e+"px")},a.viewModel.howToItemHighlighted=null,a.toggleHowToItemHighlighted=function(b,c){return!0===c?void(a.viewModel.howToItemHighlighted=b):!1===c?void(a.viewModel.howToItemHighlighted=null):a.viewModel.howToItemHighlighted==b?void(a.viewModel.howToItemHighlighted=null):void(a.viewModel.howToItemHighlighted=b)},$(window).resize(function(){a.resizeMapContainer(),a.map.updateLayout(),a.repositionTopDownArrow()}),$(document).ready(function(){a.map=new Map("#home-map-container"),a.map.minAutoScale=.1,a.resizeMapContainer(),a.map.updateLayout(),a.repositionTopDownArrow()}),$(window).scroll(function(){a.repositionTopDownArrow()}),a.goToHubPage=function(a){var b=cmHelper.setSessionStorage("hub.initialSection",JSON.stringify(a));location.href=b?"/hub":"/hub#"+a},a.viewModel.hub={},a.viewModel.hub.resourceTypes=j.query(),a.processContentIfLoaded=function(){a.viewModel.hub.newsLoaded&&a.viewModel.hub.eventsLoaded&&a.viewModel.hub.updatesLoaded&&a.viewModel.hub.quotesLoaded&&a.viewModel.hub.topResourcesLoaded&&a.viewModel.hub.recentDiscussionLoaded&&b(function(){cmSite.processContent()})},a.getUpdateDescription=function(a){var b=a.recentUpdate.description?a.recentUpdate.description:a.ownerInfo.description;return b||null},a.getUpdateTypeText=function(a){var b="Added";return"Updated"==a.recentUpdate.updateType&&(b="Updated"),b},e.queryConverted({startRow:0,maxRows:3},function(b){a.viewModel.hub.newsList=b.results,a.viewModel.hub.newsList.forEach(function(a){a.convertedContent=$("<div></div>").html(a.convertedContent).text()}),a.viewModel.hub.newsLoaded=!0,a.processContentIfLoaded()},function(){a.viewModel.hub.newsLoaded=!0,a.processContentIfLoaded()}),f.queryConverted({startRow:0,maxRows:3},function(b){a.viewModel.hub.eventsList=b.results,a.viewModel.hub.eventsList.forEach(function(a){a.convertedContent=$("<div></div>").html(a.convertedContent).text()}),a.viewModel.hub.eventsLoaded=!0,a.processContentIfLoaded()},function(){a.viewModel.hub.eventsLoaded=!0,a.processContentIfLoaded()}),a.viewModel.hub.updates=[],g.queryDetail({startRow:0,maxRows:4},function(b){a.viewModel.hub.updates=b.results,a.viewModel.hub.updates.forEach(function(b){if(b.ownerInfo&&b.ownerInfo.htmlTitle){var e=$("<div></div>").html(b.ownerInfo.htmlTitle);e.find("a:first-child").after($('<span class="home-hub-update-item-meta"></span>').text(a.getUpdateTypeText(b)+" "+d("date")(b.recentUpdate.date,"dd-MMM-yy"))),b.ownerInfo.htmlTitle=c.trustAsHtml(e.html())}}),a.viewModel.hub.updatesLoaded=!0,a.processContentIfLoaded()},function(){a.viewModel.hub.updatesLoaded=!0,a.processContentIfLoaded()}),a.viewModel.hub.quotesLoaded=!0,h.queryRecent({maxRows:2},function(b){a.viewModel.hub.recentDiscussionRaw=b.results;var c=[];a.viewModel.hub.recentDiscussionRaw.forEach(function(a){if(a.commentedItemInfo&&a.comment){var b={};c.push(b);var d=$("<div></div>").html(a.convertedContent).text();b.date=a.comment.createdDate,b.commentedItemUrl=a.commentedItemInfo.url,b.title=a.comment.title,b.commentedItemTitle=a.commentedItemInfo.title,b.content=d}}),a.viewModel.hub.recentDiscussionList=c,a.viewModel.hub.recentDiscussionLoaded=!0,a.processContentIfLoaded()},function(){a.viewModel.hub.recentDiscussionLoaded=!0,a.processContentIfLoaded()}),i.queryResources(function(b){a.viewModel.hub.topResourcesList=b.slice(0,2),a.viewModel.hub.topResourcesLoaded=!0,a.processContentIfLoaded()},function(){a.viewModel.hub.topResourcesLoaded=!0,a.processContentIfLoaded()}),a.getResourceAnalyticsDataUrl=function(a){return"/"+a.stationFriendlyId+"/"+a.friendlyName},a.getResourceAnalyticsDataResourceType=function(b){var c=a.viewModel.hub.resourceTypes.filter(function(a){return a.friendlyId==b.resourceType});return c.length>0?c[0]:null},a.secondsToHours=function(a){return a?a/3600:0};var l=null;l="#features-strip",new Features(l),document.addEventListener("play",function(a){0!=$(a.target).closest("#how-to-video").length&&"function"==typeof ga&&ga("send","event","How-to video","play")},!0),$("#how-to-menu li > a").on("click",function(){var a=$(this).closest("li").attr("data-cm-how-to-item");"function"==typeof ga&&ga("send","event","How-to section","view",a)})}])}();