!function(){var a=angular.module("cmResource",["MathematicalClassroomCore","cmCommenter"]);a.controller("ResourceController",["$scope","$location","$timeout","Station","Resource","ResourceSection","InternalNoteSection","Content","TeacherSupport","ResourceExtra","ResourceType",function(a,b,c,d,e,f,g,h,i,j,k){var l=location.pathname.split("/");a.viewModel={},a.updateMathematicalClassroomHeader=function(){if(a.viewModel.resource){var b=a.getResourceType(a.viewModel.resource.resourceTypeId);b&&"resource-in-action"==b.friendlyId&&(a.mathematicalClassroomRootViewModel.headerMenuItemSelected="ResourcesInAction")}},a.viewModel.resourceTypes=k.query(function(){a.updateMathematicalClassroomHeader()}),a.getResourceType=function(b){var c=a.viewModel.resourceTypes.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.viewModel.relatedOpen=!1;var m=null,n=null,o=null,p=null;l.length>=3&&(p=l[1],o=l[2]);var q=function(){var a=!1,b=location.pathname.split("/");return b.length>=4?"internal-notes"==b[3]&&b.length>=5?(m!=b[4]&&(a=!0),n=null,m=b[4]):(n!=b[3]&&(a=!0),m=null,n=b[3]):((n||m)&&(a=!0),m=null,n=null),a};q(),a.updateTitle=function(){if(window.resourceSetup&&a.viewModel.resource&&a.viewModel.station){var b=window.resourceSetup.resourceTitle+" | "+a.viewModel.station.title;a.viewModel.resourceSection&&a.viewModel.resourceSection.order>1?b=a.viewModel.resourceSection.title+" | "+b:a.viewModel.internalNoteSection&&(b=a.viewModel.internalNoteSection.title+" | "+b),a.rootViewModel.title=cmHelper.stripLatexDollars(b)}},a.viewModel.getCurrentUrl=function(){return location.pathname},a.viewModel.resourceSections=[],a.viewModel.internalNoteSections=[],a.viewModel.resourceSectionElements=[],a.viewModel.internalNoteSectionElements=[],a.viewModel.teacherSupport=null,a.viewModel.extras=[],a.rootViewModel.currentViewModel=a.viewModel,a.viewModel.station=null,p&&(a.viewModel.station=d.get({id:p},function(){a.rootViewModel.stationIdSelected=a.viewModel.station.id})),a.viewModel.resource=null,a.viewModel.resourceSection=null,a.viewModel.internalNoteSection=null,o&&(a.viewModel.resource=e.get({id:p+"_"+o},function(){a.bookmarkManager.setCurrentResourceId(a.viewModel.resource.id),a.updateMathematicalClassroomHeader();var b=cmHelper.getIdentifierStringFriendly("resource",a.viewModel.resource.id);a.setCommentedItem(b,window.resourceSetup?window.resourceSetup.resourceTitle:null),a.viewModel.resourceSections=f.queryResource({resourceId:a.viewModel.resource.id},function(){if(a.updateSupportingMaterialsViewModel(),0!=a.viewModel.resourceSections.length){if(n){var b=a.viewModel.resourceSections.filter(function(a){return a.friendlyName==n});a.viewModel.resourceSection=b.length>0?b[0]:null}else m||(a.viewModel.resourceSection=a.viewModel.resourceSections[0],n=a.viewModel.resourceSection.friendlyName);a.viewModel.resourceSection&&(a.viewModel.sectionTitle=a.viewModel.resourceSection.title,h.getConverted({identifier:cmHelper.getIdentifierStringFriendly("resource-section",a.viewModel.resourceSection.id)}))}}),a.viewModel.internalNoteSections=g.queryResource({resourceId:a.viewModel.resource.id},function(){if(0!=a.viewModel.internalNoteSections.length){if(m){var b=a.viewModel.internalNoteSections.filter(function(a){return a.friendlyName==m});a.viewModel.internalNoteSection=b.length>0?b[0]:null}a.viewModel.internalNoteSection&&(a.viewModel.sectionTitle=a.viewModel.internalNoteSection.title,h.getConverted({identifier:cmHelper.getIdentifierStringFriendly("internal-note-section",a.viewModel.internalNoteSection.id)}))}}),i.queryResource({resourceId:a.viewModel.resource.id},function(b){a.viewModel.teacherSupport=b,a.updateSupportingMaterialsViewModel()}),j.queryResource({resourceId:a.viewModel.resource.id},function(b){a.viewModel.extras=b,a.updateSupportingMaterialsViewModel()})})),a.$on("$locationChangeSuccess",function(){if(a.saveCurrentContent(),q())if(n){var b=a.viewModel.resourceSections.filter(function(a){return a.friendlyName==n});b.length>0&&a.loadResourceSection(b[0].id)}else if(m){var b=a.viewModel.internalNoteSections.filter(function(a){return a.friendlyName==m});b.length>0&&a.loadInternalNoteSection(b[0].id)}else a.viewModel.resourceSections.length>0&&a.loadResourceSection(a.viewModel.resourceSections[0].id)}),a.setLineIdSelected=function(b){if(a.viewModel.station&&a.viewModel.station.id){var c=cmHelper.getIdentifierStringFriendly("station",a.viewModel.station.id);cmHelper.setSessionStorage(c+".lineIdSelected",b)}},a.setKeyQuestionIdSelected=function(b){if(a.viewModel.station&&a.viewModel.station.id){var c=cmHelper.getIdentifierStringFriendly("station",a.viewModel.station.id);cmHelper.setSessionStorage(c+".keyQuestionIdSelected",b)}},$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||!1||($("#resource-main").removeClass("fullscreen"),$("body").removeClass("fullscreen"))}),a.enterFullscreenMode=function(){var a=$("#resource-main")[0];a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen(),$("#resource-main").addClass("fullscreen"),$("body").addClass("fullscreen")},a.exitFullscreenMode=function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),$("#resource-main").removeClass("fullscreen"),$("body").removeClass("fullscreen")},a.getResourceSection=function(b){var c=a.viewModel.resourceSections.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.getResourceSectionElement=function(b){var c=a.viewModel.resourceSectionElements.filter(function(a){return a.friendlyName==b});return c.length>0?c[0]:null},a.openResourceSection=function(c,d){var e="/"+p+"/"+o,f=a.viewModel.resourceSections.filter(function(a){return a.friendlyName==c}),g=f.length>0?f[0]:null;!c||g&&1==g.order||(e+="/"+c),d&&d.preventDefault(),b.url(e),"function"==typeof ga&&(ga("set","page",e),ga("send","pageview"))},a.openInternalNoteSection=function(a,c){var d="/"+p+"/"+o+"/internal-notes/"+a;c&&c.preventDefault(),b.url(d),"function"==typeof ga&&(ga("set","page",d),ga("send","pageview"))},a.saveCurrentContent=function(){if(n){var b=a.getResourceSectionElement(n);b||(b={friendlyName:n,element:null},a.viewModel.resourceSectionElements.push(b)),b.element=$("#resource-section-content")}else if(m){var b=a.getInternalNoteSectionElement(m);b||(b={friendlyName:m,element:null},a.viewModel.internalNoteSectionElements.push(b)),b.element=$("#resource-section-content")}},a.loadResourceSection=function(b){var c=a.getResourceSection(b);if(c&&o&&p){m=null,a.viewModel.internalNoteSection=null,n=c.friendlyName,a.viewModel.resourceSection=c;var d=a.getResourceSectionElement(n);if(d&&d.element)$("#resource-section-content").detach(),$("#resource-section-content-outer").append(d.element),MathJax.Hub.Queue(["resetEquationNumbers",MathJax.InputJax.TeX]),cmSite.processContent();else{$("#resource-section-content").detach();var e=cmHelper.getIdentifierStringFriendly("resource-section",b),f=$("#resource-section-content-outer");f.html('<div id="resource-section-content">Loading...</div>'),h.getConverted({identifier:e},function(a){0!=f.length&&(f.html('<div id="resource-section-content" class="resource-section-content cm-content" data-cm-content="">\n'+a.content+"\n<div>"),MathJax.Hub.Queue(["resetEquationNumbers",MathJax.InputJax.TeX]),cmSite.processContent())},function(a){f.html('<div id="resource-section-content">Failed to load the resource section content.</div>')})}a.viewModel.sectionTitle=a.viewModel.resourceSection.title,a.updateTitle()}},a.getInternalNoteSection=function(b){var c=a.viewModel.internalNoteSections.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.getInternalNoteSectionElement=function(b){var c=a.viewModel.internalNoteSectionElements.filter(function(a){return a.friendlyName==b});return c.length>0?c[0]:null},a.loadInternalNoteSection=function(b){var c=a.getInternalNoteSection(b);if(c&&o&&p){m=c.friendlyName,a.viewModel.internalNoteSection=c,n=null,a.viewModel.resourceSection=null;var d=a.getResourceSectionElement(m);if(d&&d.element)$("#resource-section-content").detach(),$("#resource-section-content-outer").append(d.element),MathJax.Hub.Queue(["resetEquationNumbers",MathJax.InputJax.TeX]),cmSite.processContent();else{$("#resource-section-content").detach();var e=cmHelper.getIdentifierStringFriendly("internal-note-section",b),f=$("#resource-section-content-outer");f.html('<div id="resource-section-content">Loading...</div>'),h.getConverted({identifier:e},function(a){0!=f.length&&(f.html('<div id="resource-section-content" class="resource-section-content cm-content" data-cm-content="">\n'+a.content+"\n<div>"),MathJax.Hub.Queue(["resetEquationNumbers",MathJax.InputJax.TeX]),cmSite.processContent())},function(a){f.html('<div id="resource-section-content">Failed to load the internal note section content.</div>')})}a.viewModel.sectionTitle=a.viewModel.internalNoteSection.title,a.updateTitle()}},a.getNextSection=function(){if(!a.viewModel.resourceSection)return null;for(var b=-1,c=0;c<a.viewModel.resourceSections.length;c++)if(a.viewModel.resourceSections[c].id==a.viewModel.resourceSection.id){b=c;break}return b<0||b>=a.viewModel.resourceSections.length-1?null:a.viewModel.resourceSections[b+1]},a.getPreviousSection=function(){if(!a.viewModel.resourceSection)return null;for(var b=-1,c=0;c<a.viewModel.resourceSections.length;c++)if(a.viewModel.resourceSections[c].id==a.viewModel.resourceSection.id){b=c;break}return b<=0?null:a.viewModel.resourceSections[b-1]},a.getContentRestrictedAccessWarningText=function(){return a.viewModel.resource?a.viewModel.resourceSection?"Public"!=a.viewModel.resource.publishStatus||"Public"==a.viewModel.resourceSection.publishStatus?null:cmHelper.getRestrictedAccessWarningText(a.viewModel.resourceSection.publishStatus):a.viewModel.internalNoteSectionFriendlyName&&"Public"==a.viewModel.resource.publishStatus?"For internal use only.":null:null},a.getContentUnderConstructionWarningText=function(){return a.viewModel.resourceSection&&a.viewModel.resource?a.viewModel.resource.underConstructionWarning||!a.viewModel.resourceSection.underConstructionWarning?null:"Resource sections under construction may not yet have been fully reviewed.":null};var r=function(){var a=$("#resource-related"),b=$("#resource-related-more-button");0!=a.length&&0!=b.length&&(a[0].scrollHeight>=a[0].clientHeight+2?b.show():b.hide())};$(window).resize(function(){r()}),$(document).ready(function(){r()}),a.supportingMaterialsViewModel={},a.supportingMaterialsViewModel.getPdfDownloadUrl=function(a){if(!p||!o)return null;var b=a;return b||(b=o),"/"+p+"/"+o+"/download/"+b+".pdf"},a.supportingMaterialsViewModel.getUrl=function(a){return p&&o?a.indexOf("//")>=0||"/"==a.substr(0,1)?a:"/"+p+"/"+o+"/"+a:null};var s=!1;a.updateSupportingMaterialsViewModel=function(){a.viewModel.resource&&(a.supportingMaterialsViewModel.resource=a.viewModel.resource,a.supportingMaterialsViewModel.resourceSections=a.viewModel.resourceSections,a.supportingMaterialsViewModel.printableResourceSections=a.viewModel.resourceSections.filter(function(a){return a.printable}),a.supportingMaterialsViewModel.title="Printable/supporting materials for "+window.resourceSetup.resourceTitle,a.supportingMaterialsViewModel.extras=a.viewModel.extras.slice(0),a.supportingMaterialsViewModel.hasTeacherSupport=!!a.viewModel.teacherSupport,a.supportingMaterialsViewModel.hasModal=a.supportingMaterialsViewModel.resourceSections.length>1&&a.supportingMaterialsViewModel.printableResourceSections.length>0||a.supportingMaterialsViewModel.extras.length>0||a.supportingMaterialsViewModel.hasTeacherSupport,s=!0)},a.viewModel.supportingMaterialsModal=null,a.showSupportingMaterialsModal=function(){if(a.viewModel.supportingMaterialsModal)return void a.viewModel.supportingMaterialsModal.show();var b=new CmModal;a.viewModel.supportingMaterialsModal=b,b.setContentLoading(),b.show(),$.get("/static/spa-templates/resource-supporting-materials-modal.html",function(d){var e=$(d);angular.element(document).injector().invoke(["$rootScope","$compile",function(d,f){var g=d.$new();g.viewModel=a.supportingMaterialsViewModel,f(e)(g),b.setContent(e[0]),c(function(){cmSite.processContent(e[0])})}])})},a.showAddedBookmarkMessage=function(){var a=$('<div class="bookmark-added-message"></div>').text("Added current resource to your collection").css("right","5px").css("top","53px");$("#header").append(a),a.animate({opacity:0},5e3,function(){a.remove()})}}]),a.controller("ResourceSupportingMaterialsModalController",["$scope","$timeout","$element",function(a,b,c){b(function(){})}])}();