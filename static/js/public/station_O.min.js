!function(){var a=angular.module("cmStation",["cmCore","cmCommenter"]);a.controller("StationController",["$scope","$timeout","$sce","Station","Resource","ResourceType","ResourceLevel","KeyQuestion","LineStation","Auth",function(a,b,c,d,e,f,g,h,i,j){var k=cmHelper.getUrlParameters("",["friendlyId"]);a.viewModel={},a.viewModel.showSimpleView=!1,a.viewModel.lineIdSelected=null,a.viewModel.keyQuestionIdSelected=null,a.viewModel.station=null,a.viewModel.resourceDetailList=[],a.viewModel.resourceDetailListSplit=[],a.viewModel.reviewQuestionDetailListAll=[],a.viewModel.reviewQuestionDetailListFiltered=[],a.viewModel.reviewQuestionDetailListOrder={field:"Title",direction:"Asc"},a.viewModel.reviewQuestionDetailListNonFeatured=[],a.viewModel.reviewQuestionShowAllSelected=!1,a.viewModel.keyQuestions=[],a.viewModel.lines=[],a.viewModel.showComments=!1,a.viewModel.resourceTypes=f.query(function(){a.updateDetailLists()}),a.viewModel.resourceLevelDetailList=[],a.viewModel.resourcesLoaded=!1,a.viewModel.resourceLevelsLoaded=!1,a.viewModel.resourceLevels=g.query(function(){a.viewModel.resourceLevelsLoaded=!0,a.updateResourceLevelDetailList(),a.updateDetailLists()},function(){a.viewModel.resourceLevelsLoaded=!0}),a.viewModel.resourceSelected=null,a.getResourceType=function(b){var c=a.viewModel.resourceTypes.filter(function(a){return a.id==b});return c.length>0?c[0]:null},a.getKeyQuestionConvertedContent=function(b){var c=a.viewModel.keyQuestions.filter(function(a){return a.id==b});return c.length>0?c[0].content:""},a.updateResourceLevelDetailList=function(){a.viewModel.resourceLevelDetailList=a.viewModel.resourceLevels.map(function(a){return{resourceLevel:a,order:{field:"ResourceType",direction:"Asc"},showAllResources:!1}})},a.updateResourceDetailListSplit=function(){var b=a.viewModel.resourceLevelDetailList.map(function(b){var c={resourceLevel:b.resourceLevel},d=a.viewModel.resourceDetailList.slice(0);d.forEach(function(b){b.resourceType=a.getResourceType(b.resource.resourceTypeId)}),c.all=d.filter(function(a){return!(a.resource.resourceLevel!=b.resourceLevel.value||a.resourceType&&"review-question"==a.resourceType.friendlyId||a.resourceType&&"resource-in-action"==a.resourceType.friendlyId)});var e=c.all.filter(function(c){var d=!0;return d=d&&(b.showAllResources||c.resource.displayAtStation),(!a.viewModel.lineIdSelected||0!=c.lines.filter(function(b){return b.id==a.viewModel.lineIdSelected}).length)&&((!a.viewModel.keyQuestionIdSelected||0!=c.keyQuestions.filter(function(b){return b.id==a.viewModel.keyQuestionIdSelected}).length)&&d)});return e.sort(function(a,c){return"ResourceType"==b.order.field?a.resourceType?c.resourceType?a.resourceType.order==c.resourceType.order?cmHelper.compareInsensitiveAlphaNumeric(a.resource.title,c.resource.title):a.resourceType.order-c.resourceType.order:-1:1:"Title"==b.order.field?"Asc"==b.order.direction?cmHelper.compareInsensitiveAlphaNumeric(a.resource.title,c.resource.title):-cmHelper.compareInsensitiveAlphaNumeric(a.resource.title,c.resource.title):0}),c.filtered=e,c.nonFeaturedResources=c.all.filter(function(a){return 0==a.resource.displayAtStation}),c});a.viewModel.resourceDetailListSplit=b},a.updateReviewQuestionDetailList=function(){var b=a.viewModel.resourceDetailList.slice(0);b.forEach(function(b){b.resourceType=a.getResourceType(b.resource.resourceTypeId)}),a.viewModel.reviewQuestionDetailListAll=b.filter(function(a){return a.resourceType&&"review-question"==a.resourceType.friendlyId});var c=a.viewModel.reviewQuestionDetailListAll.filter(function(b){var c=!0;return c=c&&(a.viewModel.reviewQuestionShowAllSelected||b.resource.displayAtStation),(!a.viewModel.lineIdSelected||0!=b.lines.filter(function(b){return b.id==a.viewModel.lineIdSelected}).length)&&((!a.viewModel.keyQuestionIdSelected||0!=b.keyQuestions.filter(function(b){return b.id==a.viewModel.keyQuestionIdSelected}).length)&&c)});c.sort(function(b,c){return"Title"==a.viewModel.reviewQuestionDetailListOrder.field?"Asc"==a.viewModel.reviewQuestionDetailListOrder.direction?cmHelper.compareInsensitiveAlphaNumeric(b.title,c.title):-cmHelper.compareInsensitiveAlphaNumeric(b.title,c.title):"Ref"==a.viewModel.reviewQuestionDetailListOrder.field?"Asc"==a.viewModel.reviewQuestionDetailListOrder.direction?cmHelper.compareInsensitiveAlphaNumeric(cmHelper.getResourceRefText(b.resource.ref),cmHelper.getResourceRefText(c.resource.ref)):-cmHelper.compareInsensitiveAlphaNumeric(cmHelper.getResourceRefText(b.resource.ref),cmHelper.getResourceRefText(c.resource.ref)):0}),a.viewModel.reviewQuestionDetailListFiltered=c,a.viewModel.reviewQuestionDetailListNonFeatured=a.viewModel.reviewQuestionDetailListAll.filter(function(a){return 0==a.resource.displayAtStation})},a.updateDetailLists=function(){a.viewModel.resourceDetailList.forEach(function(a){a.resource&&a.resource.description&&!a.hasProcessedDescription&&(a.resource.description=c.trustAsHtml(cmHelper.convertMarkdownLineToHtml(a.resource.description)),a.hasProcessedDescription=!0)}),a.updateResourceDetailListSplit(),a.updateReviewQuestionDetailList(),b(function(){cmSite.processContent()})},a.$watch("viewModel.keyQuestionIdSelected",function(b,c){b!=c&&a.updateDetailLists()}),a.$watch("viewModel.lineIdSelected",function(b,c){b!=c&&a.updateDetailLists()}),a.updateOrder=function(b,c,d){var e=a.viewModel.resourceLevelDetailList.filter(function(a){return a.resourceLevel.value==b});0!=e.length&&(e[0].order={field:c,direction:d},a.updateDetailLists())},a.isOrderSelected=function(b,c,d){var e=a.viewModel.resourceLevelDetailList.filter(function(a){return a.resourceLevel.value==b});if(0!=e.length)return e[0].order.field==c&&e[0].order.direction==d},a.setShowAllSelected=function(c,d){var e=a.viewModel.resourceLevelDetailList.filter(function(a){return a.resourceLevel.value==c});0!=e.length&&(e[0].showAllResources=d,a.updateResourceDetailListSplit(),b(function(){cmSite.processContent()}))},a.isShowAllSelected=function(b){var c=a.viewModel.resourceLevelDetailList.filter(function(a){return a.resourceLevel.value==b});return 0!=c.length&&c[0].showAllResources},a.$watch("viewModel.reviewQuestionShowAllSelected",function(c,d){c!=d&&(a.updateReviewQuestionDetailList(),b(function(){cmSite.processContent()}))}),a.updateReviewQuestionOrder=function(b,c){a.viewModel.reviewQuestionDetailListOrder={field:b,direction:c},a.updateDetailLists()},a.isReviewQuestionOrderSelected=function(b,c){return a.viewModel.reviewQuestionDetailListOrder.field==b&&a.viewModel.reviewQuestionDetailListOrder.direction==c},a.getResources=function(){a.viewModel.station&&(a.viewModel.resourceDetailList=e.queryStationAllDetail({stationId:a.viewModel.station.id},function(){a.viewModel.resourcesLoaded=!0,a.updateDetailLists()},function(){a.viewModel.resourcesLoaded=!0}))},a.viewModel.station=d.get({id:k.friendlyId},function(){a.viewModel.keyQuestions=h.queryStationConverted({stationId:a.viewModel.station.id}),i.queryStationDetail({stationId:a.viewModel.station.id},function(b){a.viewModel.lines=b.map(function(a){return a.detail})}),a.rootViewModel.stationIdSelected=a.viewModel.station.id,a.getResources();var b=cmHelper.getIdentifierStringFriendly("station",a.viewModel.station.id);if(a.setCommentedItem(b,a.viewModel.station.title),sessionStorage[b+".lineIdSelected"])try{a.viewModel.lineIdSelected=JSON.parse(sessionStorage[b+".lineIdSelected"])}catch(c){}if(cmHelper.setSessionStorage(b+".lineIdSelected",null),sessionStorage[b+".keyQuestionIdSelected"])try{a.viewModel.keyQuestionIdSelected=JSON.parse(sessionStorage[b+".keyQuestionIdSelected"])}catch(c){}cmHelper.setSessionStorage(b+".keyQuestionIdSelected",null)},function(){a.viewModel.resourcesLoaded=!0}),a.toggleLineIdSelected=function(b){b==a.viewModel.lineIdSelected?a.viewModel.lineIdSelected=null:a.viewModel.lineIdSelected=b},a.toggleKeyQuestionIdSelected=function(b){b==a.viewModel.keyQuestionIdSelected?a.viewModel.keyQuestionIdSelected=null:a.viewModel.keyQuestionIdSelected=b},a.canViewStation=function(b){return a.currentUser.canViewItem(b.publishStatus)},a.toggleResourceSelected=function(b){a.viewModel.resourceSelected==b?a.viewModel.resourceSelected=null:a.viewModel.resourceSelected=b},a.getKeyQuestionFilterText=function(a){var b=$("<div></div>").html(a.content).text();return a.number+". "+b.substr(0,30)+"..."},a.getRestrictedAccessWarningText=cmHelper.getRestrictedAccessWarningText,a.getUnderConstructionWarningText=cmHelper.getUnderContructionWarningText,a.getResourceRefText=cmHelper.getResourceRefText,a.viewModel.nearbyStationsModal=null,a.showNearbyStationsModal=function(){if(a.viewModel.nearbyStationsModal)return void a.viewModel.nearbyStationsModal.show();var c=new CmModal;a.viewModel.nearbyStationsModal=c,c.setContentLoading(),c.show(),$.get("/static/spa-templates/nearby-stations-modal.html",function(a){var d=$(a);angular.element(document).injector().invoke(["$rootScope","$compile",function(a,e){var f=a.$new();f.viewModel={stationFriendlyId:k.friendlyId},e(d)(f),c.setContent(d[0]),b(function(){cmSite.processContent(d[0])})}])})},a.getInteractivityLabelString=function(a){return a.interactivityLabels&&0!=a.interactivityLabels.length?"Contains interactive elements - "+a.interactivityLabels.map(function(a){return a.name}).join(", "):null}}]),a.controller("NearbyStationsModalController",["$scope","$timeout","$element","Station","Line","LineStation","StationNearby",function(a,b,c,d,e,f,g){a.viewModel=a.viewModel||{},a.viewModel.stations=[],a.viewModel.lines=[],a.viewModel.lineStations=[],a.viewModel.station=null,a.viewModel.nearbyStations=[],a.viewModel.nearbyStationDetailList=[],a.viewModel.previousStations=[],a.viewModel.nextStations=[],a.updateStationLines=function(){var b=[];a.viewModel.nearbyStations.forEach(function(c){var d={station:c.detail,nearbyType:c.value.nearbyType};b.push(d);var e=a.viewModel.lineStations.filter(function(a){return a.stationId==d.station.id}),f=e.map(function(b){var c=a.viewModel.lines.filter(function(a){return a.id==b.lineId});return c.length>0?c[0]:null});d.lines=f.filter(function(a){return null!=a})}),a.viewModel.nearbyStationDetailList=b,a.viewModel.previousStations=b.filter(function(a){return"StationNearbyTypeBack"==a.nearbyType}),a.viewModel.nextStations=b.filter(function(a){return"StationNearbyTypeBack"!=a.nearbyType})},a.viewModel.lines=e.query(function(){a.updateStationLines()}),a.viewModel.lineStations=f.query(function(){a.updateStationLines()}),a.viewModel.station=d.get({id:a.viewModel.stationFriendlyId},function(){a.viewModel.nearbyStations=g.queryStationDetail({stationId:a.viewModel.station.id},function(){a.updateStationLines()})}),b(function(){})}])}();